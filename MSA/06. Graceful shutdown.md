## ğŸ’¡ ì™œ Graceful Shutdownì´ ì¤‘ìš”í•œê°€?

Cloud Native í™˜ê²½ì—ì„œëŠ” ì»¨í…Œì´ë„ˆê°€ ë™ì ìœ¼ë¡œ ì‹œì‘ë˜ê³  ì¢…ë£Œëœë‹¤.   
ECS, EKS, K8s ë“±ì€ ì„œë¹„ìŠ¤ ìŠ¤ì¼€ì¼ë§, ë¡¤ë§ ë°°í¬, ì¥ì•  ë³µêµ¬ ë“±ì˜ ìƒí™©ì—ì„œ ì»¨í…Œì´ë„ˆ ì¢…ë£Œë¥¼ ìì£¼ ë°œìƒì‹œí‚¨ë‹¤.

### Graceful Shutdownì´ ì—†ë‹¤ë©´

- í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì¤‘ë‹¨ â†’ ì˜¤ë¥˜ ì‘ë‹µ
- DB íŠ¸ëœì­ì…˜ ì¤‘ë‹¨ â†’ ë°ì´í„° ë¬´ê²°ì„± ì†ìƒ
- SQS ë©”ì‹œì§€ ì¤‘ë³µ ì²˜ë¦¬ / ìœ ì‹¤
- ë¦¬ì†ŒìŠ¤ ë¯¸ì •ë¦¬ â†’ ì»¤ë„¥ì…˜ ëˆ„ìˆ˜

## ğŸ’¡ ì¢…ë£Œ íë¦„: ì•„í‚¤í…ì²˜ ìˆ˜ì¤€ì—ì„œì˜ ì‹œí€€ìŠ¤

```text
[1] ALB: Health check ì‹¤íŒ¨ ìœ ë„ â†’ íŠ¸ë˜í”½ ì¢…ë£Œ
[2] ECS: SIGTERM â†’ ì»¨í…Œì´ë„ˆ graceful ì¢…ë£Œ ì§„ì…
[3] Spring Boot: shutdown phase ì§„ì…
[4] ì• í”Œë¦¬ì¼€ì´ì…˜: HTTP ìš”ì²­ ë§ˆë¬´ë¦¬, SQS Consumer ì¤‘ë‹¨, DB ì •ë¦¬
[5] ECS: SIGKILL (timeout ì´ˆê³¼ ì‹œ) or ì¢…ë£Œ ì™„ë£Œ
```

## ğŸ’¡ 1. ALB êµ¬ì„± - Deregistration ì§€ì—° ì‹œê°„ ì¡°ì ˆ

ALBëŠ” Target Groupì˜ ëŒ€ìƒì´ ë¹„ì •ìƒ ìƒíƒœê°€ ë˜ë©´ íŠ¸ë˜í”½ì„ ë” ì´ìƒ ì „ë‹¬í•˜ì§€ ì•ŠëŠ”ë‹¤.   
ECSëŠ” Task ì¢…ë£Œ ì‹œ, í•´ë‹¹ ì»¨í…Œì´ë„ˆë¥¼ ALBì—ì„œ **Deregister**í•˜ê³  **`deregistration_delay.timeout_seconds`** ë™ì•ˆ ê¸°ì¡´ ì—°ê²°ì„ ìœ ì§€í•œë‹¤.

### ê¶Œì¥ ì„¤ì •

- `deregistration_delay.timeout_seconds = 30` (ê¸°ë³¸ì€ 300ì´ˆ)
- ALB ë¡œê·¸ ë° CloudWatch ì§€í‘œë¡œ íŠ¸ë˜í”½ì´ ì°¨ë‹¨ë˜ì—ˆëŠ”ì§€ í™•ì¸ ê°€ëŠ¥

### ì¼ë°˜ì ì¸ ë°°í¬ ìƒí™©ì—ì„œì˜ ALB íŠ¸ë˜í”½ ì°¨ë‹¨ íë¦„

1. ECSëŠ” ìƒˆ Taskë¥¼ ì‹¤í–‰
2. ìƒˆ Taskê°€ ALB Health Checkì— í†µê³¼ (ì •ìƒ ìƒíƒœ)
3. ALBê°€ ìƒˆ Taskë¡œ íŠ¸ë˜í”½ì„ ë¼ìš°íŒ… ì‹œì‘
4. ê¸°ì¡´ TaskëŠ” ALBì—ì„œ Deregisterë¨
5. ALBëŠ” Deregistration Delay ë™ì•ˆ ê¸°ì¡´ ì—°ê²° ìœ ì§€, ìƒˆë¡œìš´ ìš”ì²­ì€ ì „ë‹¬ ì•ˆ í•¨
6. ECSëŠ” Deregisterê°€ ì™„ë£Œëœ Taskë¥¼ ì¢…ë£Œ

## ğŸ’¡ ECS ì¢…ë£Œ ë©”ì»¤ë‹ˆì¦˜ ì´í•´

ECSëŠ” Task ì¢…ë£Œ ì‹œ ë‹¤ìŒ ìˆœì„œë¥¼ ë”°ë¥¸ë‹¤.

1. ì»¨í…Œì´ë„ˆì— `SIGTERM` ì „ì†¡
2. `stopTimeout` ë™ì•ˆ ì¢…ë£Œë¥¼ ëŒ€ê¸°
3. ì¢…ë£Œë˜ì§€ ì•Šìœ¼ë©´ `SIGKILL` ì „ì†¡ (ê°•ì œ ì¢…ë£Œ)

### stopTimeout ì„¤ì • (Task Definition)

```json
"containerDefinitions": [
  {
    "name": "app",
    "essential": true,
    "stopTimeout": 60  // ì´ˆ ë‹¨ìœ„, SIGTERM ì´í›„ ëŒ€ê¸° ì‹œê°„
  }
]
```

## ğŸ’¡ Spring Boot ì„¤ì •: shutdown phase í™œì„±í™”

Spring Boot 2.3+ì—ì„œëŠ” `server.shutdown=graceful` ì„¤ì • ì‹œ shutdown phaseê°€ í™œì„±í™”ëœë‹¤.  
ì´ë•Œ `@PreDestroy`, `SmartLifecycle`, `DisposableBean` ë“±ì´ ì‘ë™í•œë‹¤.

### application.yml ì„¤ì •

```yaml
server:
  shutdown: graceful
spring:
  lifecycle:
    timeout-per-shutdown-phase: 30s  # ëª¨ë“  ì¢…ë£Œ í›…ì´ ì‹¤í–‰ë  ìµœëŒ€ ì‹œê°„
```

## ğŸ’¡ ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ ì¢…ë£Œ ë¡œì§

### HTTP ìš”ì²­ graceful ì²˜ë¦¬

Spring Webì€ ì¢…ë£Œ signal ìˆ˜ì‹  í›„ ë‹¤ìŒ ë™ì‘ì„ ë”°ë¥¸ë‹¤.

- ê¸°ì¡´ ì—°ê²° ìš”ì²­ì€ ëê¹Œì§€ ì²˜ë¦¬
- ìƒˆë¡œìš´ ìš”ì²­ ìˆ˜ë½ ì°¨ë‹¨ (`keep-alive` í¬í•¨)
- Tomcat/Netty ê¸°ë°˜ì´ë©´ ìì²´ì ìœ¼ë¡œ ì—°ê²°ì„ ì¢…ë£Œê¹Œì§€ ë³´ì¥

### @PreDestroy Hook ì˜ˆì‹œ

```java
@Component
public class GracefulShutdownHook {

    @PreDestroy
    public void onShutdown() {
        log.info("[Shutdown] ì„œë¹„ìŠ¤ ì¢…ë£Œ ì‹œì‘...");
        flushPendingWrites();
        shutdownKafkaProducer();
        releaseExternalResources();
        log.info("[Shutdown] ëª¨ë“  ì¢…ë£Œ ì‘ì—… ì™„ë£Œ.");
    }
}
```

### SQS Consumer ì•ˆì „í•œ ì¤‘ë‹¨

#### ìœ„í—˜: SQS Listenerê°€ ì¢…ë£Œ ì§ì „ê¹Œì§€ ë©”ì‹œì§€ë¥¼ ê°€ì ¸ì˜¤ë©´...?

- ì²˜ë¦¬ ì¤‘ ì»¨í…Œì´ë„ˆê°€ ì¢…ë£Œë˜ë©´ ë©”ì‹œì§€ëŠ” visibility timeout ì´í›„ ì¬ë°°ë‹¬ë¨
- ì¤‘ë³µ ì²˜ë¦¬ ë˜ëŠ” ë°ì´í„° ë¶ˆì¼ì¹˜ ë°œìƒ

#### ğŸ“Œ í•´ê²° ì „ëµ

- ìˆ˜ì‹  ì“°ë ˆë“œë¥¼ ì¡°ê¸°ì— ì¢…ë£Œ
- ë©”ì‹œì§€ ìˆ˜ì‹  ì¤‘ë‹¨ í›„ drain + commit

### ì˜ˆì œ: SmartLifecycleë¡œ ë©”ì‹œì§€ ì†Œë¹„ ì œì–´

```java
@Component
public class SqsListener implements SmartLifecycle {

    private volatile boolean running = false;
    private final ExecutorService executor = Executors.newSingleThreadExecutor();

    @Override
    public void start() {
        running = true;
        executor.submit(() -> {
            while (running) {
                Message msg = receiveMessage();
                if (msg != null) {
                    process(msg);
                    deleteMessage(msg);
                }
            }
        });
    }

    @Override
    public void stop() {
        running = false;
        executor.shutdown();
        try {
            if (!executor.awaitTermination(10, TimeUnit.SECONDS)) {
                log.warn("Shutdown timeout, forcing stop.");
            }
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }

    @Override
    public boolean isRunning() {
        return running;
    }
}
```

## ğŸ’¡ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### 1. ìˆ˜ë™ ì¢…ë£Œ

```bash
aws ecs update-service --desired-count 0
```

- ë¡œê·¸ì— shutdown ë¡œê·¸ ì¶œë ¥ í™•ì¸
- ì²˜ë¦¬ ì¤‘ ë©”ì‹œì§€ ìœ ì‹¤ ì—†ëŠ”ì§€ ê²€ì¦

### 2. ìš”ì²­ ë„ì¤‘ ì¢…ë£Œ

- í´ë¼ì´ì–¸íŠ¸ì—ì„œ long polling ìš”ì²­ ì¤‘ ECS ì¢…ë£Œ
- ì •ìƒ ì‘ë‹µ ë°˜í™˜ë˜ëŠ”ì§€ í™•ì¸

### 3. ë©”ì‹œì§€ ì†Œë¹„ ì¤‘ë‹¨ í…ŒìŠ¤íŠ¸

- ì²˜ë¦¬ ì¤‘ì¸ ë©”ì‹œì§€ì˜ ì¤‘ë³µ ì²˜ë¦¬ ì—¬ë¶€ í™•ì¸
- shutdown ë¡œê·¸ â†’ ë©”ì‹œì§€ ì²˜ë¦¬ ì™„ë£Œ â†’ ì¢…ë£Œ ìˆœì„œ í™•ì¸

## ğŸ’¡ ì°¸ê³  ë¬¸ì„œ

- [Spring Boot Graceful Shutdown](https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.graceful-shutdown)
- [AWS ECS Container Lifecycle](https://docs.aws.amazon.com/AmazonECS/latest/userguide/container-instance-life-cycle.html)
- [AWS ALB Deregistration Delay](https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-target-groups.html#deregistration-delay)
