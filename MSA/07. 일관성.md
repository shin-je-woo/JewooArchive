## 💡 분산 시스템에서의 일관성

분산 시스템에서 일관성(Consistency)은 데이터의 정합성과 동기화를 다루는 중요한 개념이다.   
특히 마이크로서비스나 분산 DB를 쓸 때 필수적으로 고려해야 하는 개념이다.

## 💡 일관성 모델 종류

### 강한 일관성 (Strong Consistency)

- 모든 노드에서 항상 같은 데이터를 읽을 수 있음
- 쓰기 직후 읽으면 반드시 최신 데이터가 나옴
- 예: DocumentDB (공유 스토리지 개념이 있어서 모든 노드에서 같은 데이터가 조회됨이 보장된다.)

### 최종적 일관성 (Eventual Consistency)

- 일시적으로 불일치해도 시간이 지나면 결국 동기화됨
- 빠르고 확장성 좋지만, 일시적으로 정확한 값이 아닐 수 있음
- 예: DynamoDB, Cassandra

### 지연된 일관성 (Lazy Consistency)

- 최종적 일관성의 하위 개념
- 비동기 복제를 통해 데이터 반영됨

### 약한 일관성 (Weak Consistency)

- 쓰기 이후 읽었을 때 변경 사항이 반영되지 않을 수 있음
- 실시간 정합성이 중요하지 않을 때 사용

### BASE 모델

- Basically Available, Soft-state, Eventually consistent
- NoSQL 시스템에서 자주 사용
- ACID보다 가용성과 성능을 우선시함

## 💡 CAP 이론

CAP 이론은 분산 시스템에서 **Consistency**, **Availability**, **Partition Tolerance** 중 **2가지만 보장**할 수 있다는 이론이다.  
보통 Partition Tolerance는 무조건 보장되어야 하는 개념이라 일관성과 가용성 중 양자 택일의 Trade-off 개념이다.

| 조합 | 설명 | 예시 |
|------|------|------|
| CP   | 강한 일관성 + 분할 허용 | HBase |
| AP   | 가용성 + 분할 허용 | Cassandra |
| CA   | 네트워크 분할이 없다는 가정 하에 강일 + 가용 | 단일 노드 DB |

## 💡 실무 적용 전략

### Saga 패턴

- 분산 트랜잭션의 대안
- 각 단계가 실패할 경우 **보상 트랜잭션**으로 정합성 유지 (최종적 일관성)

### Outbox 패턴

- DB 트랜잭션에 메시지를 함께 저장하고, 이후 비동기로 Kafka 등에 발행
- 로컬 데이터와 이벤트 간 원자성 보장

### Idempotency Key

- 동일 이벤트가 여러 번 처리되어도 **중복 반영 방지**

## 💡 어떤 상황에서 어떤 일관성을 쓸까?

| 유스케이스 | 강한 일관성 필요 | 최종 일관성 가능 |
|----------|------------------|------------------|
| 이체 처리 | 🟢               | ❌               |
| 포인트 적립 | ❌              | 🟢               |
| 알림 발송 | ❌              | 🟢               |
| 주문 결제 | 🟢               | ❌               |
| 공지사항 조회 | ❌           | 🟢               |

일관성 모델은 **성능, 가용성, 정확성** 간의 트레이드오프를 어떻게 가져가느냐에 따라 선택이 달라진다. 실무에서는 비즈니스 요구사항에 따라 **부분적으로 강한 일관성**을 쓰거나, **전체 시스템은 최종 일관성**으로 설계하는 경우도 많다.
