# 💡 분해로 인한 문제

- 기존의 모놀리식 아키텍처에서는 정형화된 로그, 메트릭 수집방식이 있었고, 대부분의 Node상태가 커버되었다.
- MSA환경으로 넘어오게 되면서 Node 상태 뿐만 아니라, 다음과 같은 문제인식이 필요해졌다.
  - Latency 증감, Call 횟수 증감 확인
  - 어떤 서비스가 어떤 API 호출중인지 확인
  - Async 방식도 모니터링 필요 (e.g. 카프카 컨슈머 렉, dlq)
  - 다양한 비즈니스 메트릭을 어떻게 중앙화 할 것인지
- 또한, 다음과 같은 문제점도 발생할 수 있게 된다.
  - 네트워크 hop이 늘어남에 따라, 어디서 어떤 요청에 대해 문제가 발생했는지 파악이 어렵다. -> `Tracing`
  - 로그 수집을 위한 별도의 인프라 구성 및 관리 필요성 -> `Logging`
  - 수십, 수백 개의 서비스에 대해 JVM, 하드웨어가 정상적인지 지속적인 확인 필요 -> `Metric`, `Alert`
  - 어느 서비스에서 어느 서비스를 호출하는지, 정상적으로 호출중인지 확인 필요 -> `Service-Mesh`
 
# 💡 올바른 모니터링이란?

- Tracing, Logging, Metric, Alert, Service-Mesh 올바른 사용 예시

1. 특정 `Metric`에 사전 정의 되어진 `Alert`를 통해서 문제를 감지 (예외적으로 확인이 필요한 상황이 있을 수 있다. e.g. DB 정합성 문제 발생 감지)
2. 어떤 `Metric`에 대한 문제인지를 파악하고, 어떤 행동을 해야할 지 판단   
2-1. Metric 수치를 보고 오판단, 혹은 당장 이슈의 정도가 미미하다면 Alert 조건 등을 수정. 코드 수정   
2-2. 어플리케이션 레벨의 문제라고 판단 시, `Log`를 확인   
2-3. 단순 Log로 확인이 어려울 시, 해당 트랜잭션에 대한 `Tracing` 확인   
2-4. 인프라 수준의 문제라면, 정확한 원인 파악 필요 (e.g. CI/CD 과정에서의 문제, OOM Killed 등)   
2-5. 라우팅, 트래픽 등에 문제라면, `Service-Mesh` 를 통해 현재 서비스 간 트래픽 모니터링 상태 확인    
3. 같은 문제가 발생하지 않도록 조치 필요

# 💡 모니터링 요소 별로 풀어야 할 문제와, 이를 해결해 주는 기술 스택들

### 로깅 (Logging)

- 수많은 서버(IDC, Cloud)의 수많은 서비스들의 로그들을 적절히 필터링 하여 누락 없이 로그 저장소까지 전송해야 한다.
- 수많은 로그들을 적절히 인덱싱 하여, 필요 시 빠르게 다양한 조건으로 검색이 가능해야 한다.

![image](https://github.com/user-attachments/assets/d534b0ae-f7e2-4a0b-bc1e-0475399ff2d5)

### 메트릭, 얼럿 (Metric, Alert)

- 수많은 서버(IDC, Cloud)의 수많은 서비스 내 메트릭들을 안정적으로 수집하고, 시계열 방식으로 저장해야 한다. (시계열: 시간의 흐름에 따라 일정 간격으로 측정된 연속적인 데이터)
- 다양한 오픈 소스의 메트릭을 지원하는 대시보드를 사용해야 한다.
- 원하는 복잡한 형태의 비즈니스 메트릭을 작성하고, 이를 기반으로 적절하게 Alert 조건을 설정할 수 있어야 한다.

![image](https://github.com/user-attachments/assets/cbaff79a-7111-4c14-abc5-e4e5d97589bf)

### 트레이싱 (Tracing)

- 하나의 소스, 트랜잭션이 여러 서비스에서 처리되는 과정을 추적할 수 있어야 한다.
- 적절한 샘플링과, 보기 좋은 UI 등을 제공해야 한다.

![image](https://github.com/user-attachments/assets/2d49a876-65cb-463c-96c6-a0bb8c1cb7dd)

### 서비스 메시 (Service Mesh)

- 어떤 서비스가 어떤 서비스를 호출하는지 시각화할 수 있어야 한다.
- 어떤 서비스에서 트래픽이 얼마나 발생하는지 모니터링할 수 있어야 한다.

![image](https://github.com/user-attachments/assets/4c35efb1-62f2-4e73-a95b-4ebaa790a09b)
