## 💡 DocumentDB란?

Amazon DocumentDB는 MongoDB 호환 API를 제공하는 AWS의 관리형 문서형 NoSQL 데이터베이스다.  
JSON 문서 기반 데이터 모델을 사용하며, MongoDB 클라이언트/라이브러리와 연동 가능하도록 설계됐다.

### 주요 특징
- MongoDB 3.6/4.0 API 호환
- 완전관리형 (백업, 모니터링, 보안 포함)
- 스토리지와 컴퓨팅 분리 아키텍처
- 6-way 복제되는 고내구성 공유 스토리지
- 읽기 Replica 최대 15개까지 지원
- Auto-failover 및 Reader Endpoint 제공

## 💡 인스턴스 개념

DocumentDB 인스턴스는 데이터를 저장하는 공간이 아니라, **쿼리 실행 및 데이터 처리 역할**을 하는 컴퓨팅 노드다.  
모든 데이터는 공유 스토리지에 저장되고, 인스턴스는 해당 스토리지에 접근해서 데이터를 처리하는 구조다.   
클러스터 내에서 다음 두 가지 인스턴스 역할로 나뉜다.

### Primary Instance

- 유일한 쓰기 가능한 인스턴스
- 모든 쓰기 작업은 Primary에서만 수행됨
- 클러스터 기본 엔드포인트로 연결됨

### Replica Instance
- 읽기 전용 인스턴스
- Primary와 동일한 스토리지를 공유하며 읽기 부하 분산
- 읽기 트래픽 분산 처리
- Reader Endpoint를 통해 자동 로드 밸런싱 가능
- Auto-failover 시 Primary로 자동 승격 가능
- 최대 15개까지 생성 가능

## 💡 스토리지 구조

DocumentDB는 **스토리지와 인스턴스를 완전히 분리**하는 구조를 채택하고 있다.

| 항목 | MongoDB | Amazon DocumentDB |
|------|---------|--------------------|
| 스토리지 | 각 노드가 데이터를 저장함 | 중앙 공유 스토리지를 사용 |
| 복제 방식 | Oplog 기반 복제 | 복제 대신 공유 스토리지 읽기 (자동 6-way 복제) |
| 인스턴스 장애 | 수동 복구 필요 | 새 인스턴스로 연결 시 즉시 사용 가능 |

## 💡 읽기 Replica를 15개까지 지원하는 이유

DocumentDB에서 Replica 인스턴스는 단순히 **Failover 목적**만 있는것이 아니다.   
**읽기 부하 분산과 수평 확장**을 위한 핵심 메커니즘이다.

### 주요 목적

1. **Failover 대응**: 최소 1개 이상의 Replica로 고가용성 구성 (Primary 장애 시 자동 승격)
2. **수평 확장 (Read Scalability)**: 트래픽 증가 시 읽기 인스턴스를 추가해 부하 분산
3. **병렬 쿼리 처리**: 각 Replica는 자체 CPU/메모리를 사용해 독립적으로 쿼리 실행

> 모든 인스턴스는 공유 스토리지를 참조하더라도, 쿼리 실행은 각 인스턴스의 CPU/메모리 자원을 사용하기 때문에 Replica 수가 많을수록 읽기 처리량이 증가한다.

## 💡 Quorum 개념과 일관성 설정

DocumentDB는 MongoDB 호환 API를 따르기 때문에, `writeConcern`, `readConcern`을 통해 **Quorum 유사 개념**을 설정할 수 있다.  
But, 실제 구조는 공유 스토리지이기 때문에 관련 설정은 정상 동작하지 않을 수 있다.

## 💡 인스턴스 구성 전략


| 목적 | 권장 구성 |
|------|-----------|
| 최소 구성 | Primary 1개 |
| 고가용성 | Primary 1 + Replica 1 이상 (다중 AZ) |
| 읽기 성능 확장 | Primary 1 + 여러 Replica (최대 15개) |
| 장애 복구 대비 | Auto-failover 활성화 + 최소 2개 인스턴스 구성 |

## 💡 DocumentDB vs MongoDB - 저장 방식 비교

Amazon DocumentDB는 MongoDB와 API 호환성을 제공하지만, 저장 방식과 내부 아키텍처는 상당히 다르다.  
DocumentDB는 공유 스토리지 기반이고, MongoDB는 각 노드가 데이터를 개별적으로 저장하고 복제한다.

| 항목 | Amazon DocumentDB | MongoDB (Replica Set) |
|------|--------------------|------------------------|
| 저장 위치 | 중앙 공유 스토리지 (6-way 복제) | 각 노드가 로컬 디스크에 데이터 저장 |
| 복제 방식 | 없음 (공유 스토리지 기반) | Oplog 기반 Primary → Secondary 복제 |
| 읽기 처리 | 모든 인스턴스가 공유 스토리지에서 직접 읽음 | Secondary 노드가 로컬 복제본에서 읽음 |
| 복제 지연 | 없음 (즉시 반영) | 있음 (네트워크 지연 및 oplog 처리 시간 발생) |
| 데이터 정합성 | 스토리지 계층에서 실시간 동기화 | Secondary는 지연된 상태일 수 있음 |
| 장애 대응 | 스토리지에 복제본이 있어 자동 복구 | Secondary가 직접 승격되고 복제 필요 |

> DocumentDB는 Primary와 Replica 모두 같은 스토리지를 공유하므로, 복제 지연이나 일관성 이슈가 없고 장애 복구가 더 단순하다.  
> 반면, MongoDB는 각 노드가 데이터를 직접 저장하고 별도로 복제하기 때문에 복잡한 동기화 관리가 필요하다.
