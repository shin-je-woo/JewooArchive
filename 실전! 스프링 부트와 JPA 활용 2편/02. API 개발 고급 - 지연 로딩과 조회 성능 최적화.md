# Previous
* ì£¼ë¬¸ + ë°°ì†¡ì •ë³´ + íšŒì›ì„ ì¡°íšŒí•˜ëŠ” APIë¥¼ ë§Œë“¤ì
* ì§€ì—° ë¡œë”© ë•Œë¬¸ì— ë°œìƒí•˜ëŠ” ì„±ëŠ¥ ë¬¸ì œë¥¼ ë‹¨ê³„ì ìœ¼ë¡œ í•´ê²°í•´ë³´ì
* (Impotant) ì‹¤ë¬´ì—ì„œ ì¤‘ìš”í•œ ë‚´ìš©ë“¤ì„ ë‹¤ë£¨ê¸°ì— ì´ ì±•í„°ëŠ” ëª¨ë‘ ë³µìŠµ ì² ì €íˆ í•˜ë„ë¡ í•˜ì.

# ğŸ’¡ ê°„ë‹¨í•œ ì£¼ë¬¸ ì¡°íšŒ V1: ì—”í‹°í‹°ë¥¼ ì§ì ‘ ë…¸ì¶œ
```java
@RequiredArgsConstructor
@RestController
public class OrderSimpleApiController {
  
    private final OrderRepository orderRepository;

    @GetMapping("/api/v1/simple-orders")
    public List<Order> ordersV1() {
        List<Order> all = orderRepository.findAllByString(new OrderSearch());
        for (Order order : all) {
            order.getMember().getName(); //Lazyë•Œë¬¸ì— í”„ë¡ì‹œê°ì²´ ê°•ì œ ì´ˆê¸°í™”
            order.getDelivery().getStatus(); //Lazyë•Œë¬¸ì— í”„ë¡ì‹œê°ì²´ ê°•ì œ ì´ˆê¸°í™”
        }
        return all;
    }
}
```
* ì—”í‹°í‹°ë¥¼ ì§ì ‘ ë…¸ì¶œí•˜ëŠ” ê²ƒì€ ì¢‹ì§€ ì•Šë‹¤. (ì•ì¥ì—ì„œ ì´ë¯¸ ì„¤ëª…)
* order.member ì™€ order.delivery ëŠ” ì§€ì—° ë¡œë”©ì´ë‹¤. ë”°ë¼ì„œ ì‹¤ì œ ì—”í‹°í‹° ëŒ€ì‹ ì— `í”„ë¡ì‹œ` ì¡´ì¬
* `jackson` ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì´ í”„ë¡ì‹œ ê°ì²´ë¥¼ jsonìœ¼ë¡œ ì–´ë–»ê²Œ ìƒì„±í•´ì•¼ í•˜ëŠ”ì§€ ëª¨ë¦„ â†’ ì˜ˆì™¸ ë°œìƒ
* `Hibernate5Module` ì„ ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë“±ë¡í•˜ë©´ í•´ê²°(ìŠ¤í”„ë§ ë¶€íŠ¸ ì‚¬ìš©ì¤‘)

```java
/*build.gradle*/
implementation 'com.fasterxml.jackson.datatype:jackson-datatype-hibernate5'

/*JpashopApplication.java*/
@Bean
Hibernate5Module hibernate5Module(){
    return new Hibernate5Module();
}
```
* ê¸°ë³¸ì ìœ¼ë¡œ ì´ˆê¸°í™” ëœ í”„ë¡ì‹œ ê°ì²´ë§Œ ë…¸ì¶œ, ì´ˆê¸°í™” ë˜ì§€ ì•Šì€ í”„ë¡ì‹œ ê°ì²´ëŠ” ë…¸ì¶œ ì•ˆí•¨
* â— ì—”í‹°í‹°ë¥¼ APIì— ì§ì ‘ ë…¸ì¶œí•˜ëŠ” ê²ƒì€ ì¢‹ì§€ ì•Šë‹¤. ê·¸ë˜ì„œ Hibernate5Module ë¥¼ ì‚¬ìš©í•˜ê¸° ë³´ë‹¤ëŠ” DTOë¡œ ë³€í™˜í•´ì„œ ë°˜í™˜í•˜ëŠ”ê²ƒì´ ë” ì¢‹ì€ ë°©ë²•ì´ë‹¤.
* â— `ì§€ì—° ë¡œë”©(LAZY)`ì„ í”¼í•˜ê¸° ìœ„í•´ `ì¦‰ì‹œ ë¡œë”©(EARGR)`ìœ¼ë¡œ ì„¤ì •í•˜ë©´ ì•ˆëœë‹¤! 
* ì¦‰ì‹œ ë¡œë”© ë•Œë¬¸ì— ì—°ê´€ê´€ê³„ê°€ í•„ìš” ì—†ëŠ” ê²½ìš°ì—ë„ ë°ì´í„°ë¥¼ í•­ìƒ ì¡°íšŒí•´ì„œ ì„±ëŠ¥ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤. ì¦‰ì‹œ ë¡œë”©ìœ¼ë¡œ ì •í•˜ë©´ ì„±ëŠ¥ íŠœë‹ì´ ë§¤ìš° ì–´ë ¤ì›Œì§„ë‹¤.
* í•­ìƒ ì§€ì—° ë¡œë”©ì„ ê¸°ë³¸ìœ¼ë¡œ í•˜ê³ , ì„±ëŠ¥ ìµœì í™”ê°€ í•„ìš”í•œ ê²½ìš°ì—ëŠ” `í˜ì¹˜ ì¡°ì¸(fetch join)`ì„ ì‚¬ìš©í•´ë¼!

# ğŸ’¡ ê°„ë‹¨í•œ ì£¼ë¬¸ ì¡°íšŒ V2: ì—”í‹°í‹°ë¥¼ DTOë¡œ ë³€í™˜
```java
@RequiredArgsConstructor
@RestController
public class OrderSimpleApiController {
  
    private final OrderRepository orderRepository;

    @GetMapping("/api/v2/simple-orders")
    public List<SimpleOrderDto> ordersV2(){
        List<Order> orders = orderRepository.findAllByString(new OrderSearch());

        List<SimpleOrderDto> collect = orders.stream()
                .map(o -> new SimpleOrderDto(o))
                .collect(Collectors.toList());
        return collect;

    }

    @Data
    static class SimpleOrderDto {
      
        private Long orderId;
        private String name;
        private LocalDateTime orderDate;
        private OrderStatus orderStatus;
        private Address address;

        public SimpleOrderDto(Order order){
            orderId = order.getId();
            name = order.getMember().getName(); //LAZY í”„ë¡ì‹œ ì´ˆê¸°í™”
            orderDate = order.getOrderDate();
            orderStatus = order.getStatus();
            address = order.getDelivery().getAddress(); //LAZY í”„ë¡ì‹œ ì´ˆê¸°í™”
        }
    }
}
```
* ì—”í‹°í‹°ë¥¼ DTOë¡œ ë³€í™˜í•˜ëŠ” ì¼ë°˜ì ì¸ ë°©ë²•ì´ë‹¤.
* ì¿¼ë¦¬ê°€ ì´ 1 + N + Në²ˆ ì‹¤í–‰ëœë‹¤. (v1ê³¼ ì¿¼ë¦¬ìˆ˜ ê²°ê³¼ëŠ” ê°™ë‹¤.)
  * order ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ 1ë²ˆ(order ì¡°íšŒ ê²°ê³¼ ìˆ˜ê°€ Nì´ ëœë‹¤.)
  * order -> member ì§€ì—° ë¡œë”© ì¡°íšŒ N ë²ˆ
  * order -> delivery ì§€ì—° ë¡œë”© ì¡°íšŒ N ë²ˆ
  * ì˜ˆ) orderì˜ ê²°ê³¼ê°€ 4ê°œë©´ ìµœì•…ì˜ ê²½ìš° 1 + 4 + 4ë²ˆ ì‹¤í–‰ëœë‹¤.(ìµœì•…ì˜ ê²½ìš°)
    * ì§€ì—°ë¡œë”©ì€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì¡°íšŒí•˜ë¯€ë¡œ ì´ë¯¸ ì¡°íšŒëœ ê²½ìš° ì¿¼ë¦¬ë¥¼ ìƒëµí•œë‹¤.

# ğŸ’¡ ê°„ë‹¨í•œ ì£¼ë¬¸ ì¡°íšŒ V3: ì—”í‹°í‹°ë¥¼ DTOë¡œ ë³€í™˜ - í˜ì¹˜ ì¡°ì¸ ìµœì í™”
```java
@GetMapping("/api/v3/simple-orders")
public List<SimpleOrderDto> ordersV3() {
    List<Order> orders = orderRepository.findAllWithMemberDelivery();

    List<SimpleOrderDto> collect = orders.stream()
            .map(o -> new SimpleOrderDto(o))
            .collect(Collectors.toList());
    return collect;
}
```
```java
public List<Order> findAllWithMemberDelivery() {
    return em.createQuery(
            "select o from Order o " +
                    " join fetch o.member m " +
                    " join fetch o.delivery d", Order.class
    ).getResultList();
}
```
* ì—”í‹°í‹°ë¥¼ `í˜ì¹˜ ì¡°ì¸(fetch join)`ì„ ì‚¬ìš©í•´ì„œ ì¿¼ë¦¬ 1ë²ˆì— ì¡°íšŒ
* í˜ì¹˜ ì¡°ì¸ìœ¼ë¡œ order â†’ member , order â†’ delivery ëŠ” ì´ë¯¸ ì¡°íšŒ ëœ ìƒíƒœ ì´ë¯€ë¡œ ì§€ì—°ë¡œë”©X

# ğŸ’¡ ê°„ë‹¨í•œ ì£¼ë¬¸ ì¡°íšŒ V4: JPAì—ì„œ DTOë¡œ ë°”ë¡œ ì¡°íšŒ
â–¶ï¸ OrderSimpleApiController
```java
@GetMapping("/api/v4/simple-orders")
public List<OrderSimpleQueryDto> ordersV4() {
    return orderSimpleQueryRepository.findOrderDtos(); 
}
* DTOë¥¼ ì¡°íšŒí•˜ëŠ” ê²½ìš° ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•˜ëŠ” ë¦¬í¬ì§€í† ë¦¬(OrderRepository)ê°€ ì•„ë‹ˆë¼ ë”°ë¡œ ì¿¼ë¦¬ìš© ë¦¬í¬ì§€í† ë¦¬ë¥¼ ë§Œë“¤ë©´ êµ¬ë¶„ì´ ì‰½ë‹¤.
```
â–¶ï¸ OrderSimpleQueryRepository ì¡°íšŒ ì „ìš© ë¦¬í¬ì§€í† ë¦¬
```java
@Repository
@RequiredArgsConstructor
public class OrderSimpleQueryRepository {

    private final EntityManager em;

    public List<OrderSimpleQueryDto> findOrderDtos() {
        return em.createQuery(
                "select new jpabook.jpashop.repository.OrderSimpleQueryDto(o.id, m.name, o.orderDate, o.status, d.address) from Order o" +
                        " join o.member m" +
                        " join o.delivery d", OrderSimpleQueryDto.class)
                .getResultList();
    }

}
```
* new ë¥¼ í†µí•´ ê°ì²´ë¥¼ ìƒì„±í•´ì¤„ ë•Œ full package pathë¥¼ ì…ë ¥í•´ì¤˜ì•¼ í•œë‹¤. 
â–¶ï¸ OrderSimpleQueryDto
```java
@Data
public class OrderSimpleQueryDto {
  
    private Long orderId;
    private String name;
    private LocalDateTime orderDate;
    private OrderStatus orderStatus;
    private Address address;

    public OrderSimpleQueryDto(Order order) {
        orderId = order.getId();
        name = order.getMember().getName();
        orderDate = order.getOrderDate();
        orderStatus = order.getStatus();
        address = order.getDelivery().getAddress();
    }
  
    /* OrderSimpleQueryRepository::findOrderDtosë©”ì„œë“œì—ì„œ ì‚¬ìš©í•  ìƒì„±ì(Constructor)*/
    public OrderSimpleQueryDto(Long orderId,
                               String name,
                               LocalDateTime orderDate,
                               OrderStatus orderStatus,
                               Address address) {
        this.orderId = orderId;
        this.name = name;
        this.orderDate = orderDate;
        this.orderStatus = orderStatus;
        this.address = address;
    }

}
```
* ì¼ë°˜ì ì¸ SQLì„ ì‚¬ìš©í•  ë•Œ ì²˜ëŸ¼ ì›í•˜ëŠ” ê°’ì„ ì„ íƒí•´ì„œ ì¡°íšŒ
* new ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•´ì„œ JPQLì˜ ê²°ê³¼ë¥¼ DTOë¡œ ì¦‰ì‹œ ë³€í™˜
* SELECT ì ˆì—ì„œ ì›í•˜ëŠ” ë°ì´í„°ë¥¼ ì§ì ‘ ì„ íƒí•˜ë¯€ë¡œ DB ì• í”Œë¦¬ì¼€ì´ì…˜ ë„¤íŠ¸ì› ìš©ëŸ‰ ìµœì í™”(ìƒê°ë³´ë‹¤ ë¯¸ë¹„)
* ë¦¬í¬ì§€í† ë¦¬ ì¬ì‚¬ìš©ì„± ë–¨ì–´ì§, API ìŠ¤í™ì— ë§ì¶˜ ì½”ë“œê°€ ë¦¬í¬ì§€í† ë¦¬ì— ë“¤ì–´ê°€ëŠ” ë‹¨ì 

### ì •ë¦¬
* ì—”í‹°í‹°ë¥¼ DTOë¡œ ë³€í™˜í•˜ê±°ë‚˜, DTOë¡œ ë°”ë¡œ ì¡°íšŒí•˜ëŠ” ë‘ê°€ì§€ ë°©ë²•ì€ ê°ê° ì¥ë‹¨ì ì´ ìˆë‹¤. 
* ë‘˜ì¤‘ ìƒí™©ì— ë”°ë¼ì„œ ë” ë‚˜ì€ ë°©ë²•ì„ ì„ íƒí•˜ë©´ ëœë‹¤. 
* ì—”í‹°í‹°ë¡œ ì¡°íšŒí•˜ë©´ ë¦¬í¬ì§€í† ë¦¬ ì¬ì‚¬ìš©ì„±ë„ ì¢‹ê³ , ê°œë°œë„ ë‹¨ìˆœí•´ì§„ë‹¤.
* ë”°ë¼ì„œ ê¶Œì¥í•˜ëŠ” ë°©ë²•ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

âœ… ì¿¼ë¦¬ ë°©ì‹ ì„ íƒ ê¶Œì¥ ìˆœì„œ
1. ìš°ì„  ì—”í‹°í‹°ë¥¼ DTOë¡œ ë³€í™˜í•˜ëŠ” ë°©ë²•ì„ ì„ íƒí•œë‹¤.
2. í•„ìš”í•˜ë©´ í˜ì¹˜ ì¡°ì¸ìœ¼ë¡œ ì„±ëŠ¥ì„ ìµœì í™” í•œë‹¤. ëŒ€ë¶€ë¶„ì˜ ì„±ëŠ¥ ì´ìŠˆê°€ í•´ê²°ëœë‹¤.
3. ê·¸ë˜ë„ ì•ˆë˜ë©´ DTOë¡œ ì§ì ‘ ì¡°íšŒí•˜ëŠ” ë°©ë²•ì„ ì‚¬ìš©í•œë‹¤.
4. ìµœí›„ì˜ ë°©ë²•ì€ JPAê°€ ì œê³µí•˜ëŠ” ë„¤ì´í‹°ë¸Œ SQLì´ë‚˜ ìŠ¤í”„ë§ JDBC Templateì„ ì‚¬ìš©í•´ì„œ SQLì„ ì§ì ‘ ì‚¬ìš©í•œë‹¤.
