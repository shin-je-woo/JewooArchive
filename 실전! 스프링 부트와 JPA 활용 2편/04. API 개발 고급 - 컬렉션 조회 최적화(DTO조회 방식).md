# ğŸ’¡ ì£¼ë¬¸ ì¡°íšŒ V4: JPAì—ì„œ DTOì§ì ‘ ì¡°íšŒ
```java
@GetMapping("/api/v4/orders")
public List<OrderQueryDto> ordersV4() {
    return orderQueryRepository.findOrderQueryDtos();
}
```
```java
@Repository
@RequiredArgsConstructor
public class OrderQueryRepository {

    private final EntityManager em;

    public List<OrderQueryDto> findOrderQueryDtos() {
        //ë£¨íŠ¸ ì¡°íšŒ(toOne ì½”ë“œë¥¼ ëª¨ë‘ í•œë²ˆì— ì¡°íšŒ)
        List<OrderQueryDto> result = findOrders(); // query 1ë²ˆ -> Nê°œ
        
        //ë£¨í”„ë¥¼ ëŒë©´ì„œ ì»¬ë ‰ì…˜ ì¶”ê°€(ì¶”ê°€ ì¿¼ë¦¬ ì‹¤í–‰)
        result.forEach(o -> {
            List<OrderItemQueryDto> orderItems = findOrderItems(o.getOrderId()); // Query Në²ˆ
            o.setOrderItems(orderItems);
        });
        return result;
    }
    
    /**
     * 1:N ê´€ê³„(ì»¬ë ‰ì…˜)ë¥¼ ì œì™¸í•œ ë‚˜ë¨¸ì§€ë¥¼ í•œë²ˆì— ì¡°íšŒ
     */
    private List<OrderQueryDto> findOrders() {
        return em.createQuery(
                "select new jpabook.jpashop.repository.order.query.OrderQueryDto(o.id, m.name, o.orderDate, o.status, d.address ) from Order o" +
                        " join o.member m" +
                        " join o.delivery d", OrderQueryDto.class
        ).getResultList();
    }

    /**
     * 1:N ê´€ê³„ì¸ orderItems ì¡°íšŒ
     */
    private List<OrderItemQueryDto> findOrderItems(Long orderId) {
        return em.createQuery(
                "select new jpabook.jpashop.repository.order.query.OrderItemQueryDto(oi.order.id, i.name, oi.orderPrice, oi.count)" +
                        " from OrderItem oi" +
                        " join oi.item i" +
                        " where oi.order.id = :orderId", OrderItemQueryDto.class)
                .setParameter("orderId", orderId)
                .getResultList();
    }
    
}
```
* Query: ë£¨íŠ¸ 1ë²ˆ, ì»¬ë ‰ì…˜ N ë²ˆ ì‹¤í–‰
* ToOne(N:1, 1:1) ê´€ê³„ë“¤ì„ ë¨¼ì € ì¡°íšŒí•˜ê³ , ToMany(1:N) ê´€ê³„ëŠ” ê°ê° ë³„ë„ë¡œ ì²˜ë¦¬í•œë‹¤.
* ì´ëŸ° ë°©ì‹ì„ ì„ íƒí•œ ì´ìœ ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.
  * ToOne ê´€ê³„ëŠ” ì¡°ì¸í•´ë„ ë°ì´í„° row ìˆ˜ê°€ ì¦ê°€í•˜ì§€ ì•ŠëŠ”ë‹¤.
  * ToMany(1:N) ê´€ê³„ëŠ” ì¡°ì¸í•˜ë©´ row ìˆ˜ê°€ ì¦ê°€í•œë‹¤.
  * row ìˆ˜ê°€ ì¦ê°€í•˜ì§€ ì•ŠëŠ” ToOne ê´€ê³„ëŠ” ì¡°ì¸ìœ¼ë¡œ ìµœì í™” í•˜ê¸° ì‰¬ìš°ë¯€ë¡œ í•œë²ˆì— ì¡°íšŒí•˜ê³ , ToMany ê´€ê³„ëŠ” ìµœì í™” í•˜ê¸° ì–´ë ¤ìš°ë¯€ë¡œ findOrderItems() ê°™ì€ ë³„ë„ì˜ ë©”ì„œë“œë¡œ ì¡°íšŒí•œë‹¤.

# ğŸ’¡ ì£¼ë¬¸ ì¡°íšŒ V5: JPAì—ì„œ DTOì§ì ‘ ì¡°íšŒ - ì»¬ë ‰ì…˜ ì¡°íšŒ ìµœì í™”
```java
@GetMapping("/api/v5/orders")
public List<OrderQueryDto> ordersV5() {
    return orderQueryRepository.findAllByDto_optimization();
}
```
```java
public List<OrderQueryDto> findAllByDto_optimization() {

    //ë£¨íŠ¸ ì¡°íšŒ(toOne ì½”ë“œë¥¼ ëª¨ë‘ í•œë²ˆì— ì¡°íšŒ)
    List<OrderQueryDto> result = findOrders();
    
    //orderItem ì»¬ë ‰ì…˜ì„ MAP í•œë°©ì— ì¡°íšŒ
    Map<Long, List<OrderItemQueryDto>> orderItemMap = findOrderItemMap(toOrderIds(result));
    
    //ë£¨í”„ë¥¼ ëŒë©´ì„œ ì»¬ë ‰ì…˜ ì¶”ê°€(ì¶”ê°€ ì¿¼ë¦¬ ì‹¤í–‰X)
    result.forEach(o -> o.setOrderItems(orderItemMap.get(o.getOrderId())));

    return result;
}

private Map<Long, List<OrderItemQueryDto>> findOrderItemMap(List<Long> orderIds) {
    List<OrderItemQueryDto> orderItems = em.createQuery(
            "select new jpabook.jpashop.repository.order.query.OrderItemQueryDto(oi.order.id, i.name, oi.orderPrice, oi.count)" +
                    " from OrderItem oi" +
                    " join oi.item i" +
                    " where oi.order.id in :orderIds", OrderItemQueryDto.class)
            .setParameter("orderIds", orderIds)
            .getResultList();

    return orderItems.stream()
            .collect(Collectors.groupingBy(OrderItemQueryDto::getOrderId));
}

private List<Long> toOrderIds(List<OrderQueryDto> result) {
    return result.stream()
                .map(OrderQueryDto::getOrderId)
                .collect(Collectors.toList());
}
```
* Query: ë£¨íŠ¸ 1ë²ˆ, ì»¬ë ‰ì…˜ 1ë²ˆ
* ToOne ê´€ê³„ë“¤ì„ ë¨¼ì € ì¡°íšŒí•˜ê³ , ì—¬ê¸°ì„œ ì–»ì€ ì‹ë³„ì orderIdë¡œ ToMany ê´€ê³„ì¸ OrderItem ì„ í•œêº¼ë²ˆì— ì¡°íšŒ
* MAPì„ ì‚¬ìš©í•´ì„œ ë§¤ì¹­ ì„±ëŠ¥ í–¥ìƒ(O(1))

# ğŸ’¡ API ê°œë°œ ê³ ê¸‰ ì •ë¦¬
### ì—”í‹°í‹° ì¡°íšŒ
* ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•´ì„œ ê·¸ëŒ€ë¡œ ë°˜í™˜: V1
* ì—”í‹°í‹° ì¡°íšŒ í›„ DTOë¡œ ë³€í™˜: V2
* í˜ì¹˜ ì¡°ì¸ìœ¼ë¡œ ì¿¼ë¦¬ ìˆ˜ ìµœì í™” V3
* ì»¬ë ‰ì…˜ í˜ì´ì§•ê³¼ í•œê³„ ëŒíŒŒ: V3.1
* ì»¬ë ‰ì…˜ì€ í˜ì¹˜ ì¡°ì¸ì‹œ í˜ì´ì§•ì´ ë¶ˆê°€ëŠ¥
* ToOne ê´€ê³„ëŠ” í˜ì¹˜ ì¡°ì¸ìœ¼ë¡œ ì¿¼ë¦¬ ìˆ˜ ìµœì í™”
* ì»¬ë ‰ì…˜ì€ í˜ì¹˜ ì¡°ì¸ ëŒ€ì‹ ì— ì§€ì—° ë¡œë”©ì„ ìœ ì§€í•˜ê³  `hibernate.default_batch_fetch_size`, `@BatchSize` ë¡œ ìµœì í™”

### DTO ì§ì ‘ ì¡°íšŒ
* JPAì—ì„œ DTOë¥¼ ì§ì ‘ ì¡°íšŒ: V4
* ì»¬ë ‰ì…˜ ì¡°íšŒ ìµœì í™” - ì¼ëŒ€ë‹¤ ê´€ê³„ì¸ ì»¬ë ‰ì…˜ì€ INì ˆì„ í™œìš©í•´ì„œ ë©”ëª¨ë¦¬ì— ë¯¸ë¦¬ ì¡°íšŒí•´ì„œ ìµœì í™”: V5

### ê¶Œì¥ ìˆœì„œ
1. ì—”í‹°í‹° ì¡°íšŒ ë°©ì‹ìœ¼ë¡œ ìš°ì„  ì ‘ê·¼
    1. í˜ì¹˜ì¡°ì¸ìœ¼ë¡œ ì¿¼ë¦¬ ìˆ˜ë¥¼ ìµœì í™”
    2. ì»¬ë ‰ì…˜ ìµœì í™”
        1. í˜ì´ì§• í•„ìš” hibernate.default_batch_fetch_size , @BatchSize ë¡œ ìµœì í™”
        2. í˜ì´ì§• í•„ìš” X â†’ í˜ì¹˜ ì¡°ì¸ ì‚¬ìš©
2. ì—”í‹°í‹° ì¡°íšŒ ë°©ì‹ìœ¼ë¡œ í•´ê²°ì´ ì•ˆë˜ë©´ DTOì¡°íšŒ ë°©ì‹ ì‚¬ìš©
3. DTOì¡°íšŒ ë°©ì‹ìœ¼ë¡œ í•´ê²°ì´ ì•ˆë˜ë©´ NativeSQL or JdbcTemplate

> ì°¸ê³   
> ì—”í‹°í‹° ì¡°íšŒ ë°©ì‹ì€ í˜ì¹˜ ì¡°ì¸ì´ë‚˜, hibernate.default_batch_fetch_size , @BatchSize ê°™ì´ ì½”ë“œë¥¼ ê±°ì˜ ìˆ˜ì •í•˜ì§€ ì•Šê³ , ì˜µì…˜ë§Œ ì•½ê°„ ë³€ê²½í•´ì„œ, ë‹¤ì–‘í•œ ì„±ëŠ¥ ìµœì í™”ë¥¼ ì‹œë„í•  ìˆ˜ ìˆë‹¤.   
> ë°˜ë©´ì— DTOë¥¼ ì§ì ‘ ì¡°íšŒí•˜ëŠ” ë°©ì‹ì€ ì„±ëŠ¥ì„ ìµœì í™” í•˜ê±°ë‚˜ ì„±ëŠ¥ ìµœì í™” ë°©ì‹ì„ ë³€ê²½í•  ë•Œ ë§ì€ ì½”ë“œë¥¼ ë³€ê²½í•´ì•¼ í•œë‹¤.

> ì°¸ê³    
> ê°œë°œìëŠ” ì„±ëŠ¥ ìµœì í™”ì™€ ì½”ë“œ ë³µì¡ë„ ì‚¬ì´ì—ì„œ ì¤„íƒ€ê¸°ë¥¼ í•´ì•¼ í•œë‹¤. í•­ìƒ ê·¸ëŸ° ê²ƒì€ ì•„ë‹ˆì§€ë§Œ ë³´í†µ ì„±ëŠ¥ ìµœì í™”ëŠ” ë‹¨ìˆœí•œ ì½”ë“œë¥¼ ë³µì¡í•œ ì½”ë“œë¡œ ëª°ê³ ê°„ë‹¤.   
> ì—”í‹°í‹° ì¡°íšŒ ë°©ì‹ì€ JPAê°€ ë§ì€ ë¶€ë¶„ì„ ìµœì í™” í•´ì£¼ê¸° ë•Œë¬¸ì—, ë‹¨ìˆœí•œ ì½”ë“œë¥¼ ìœ ì§€í•˜ë©´ì„œ ì„±ëŠ¥ì„ ìµœì í™” í•  ìˆ˜ ìˆë‹¤.   
> ë°˜ë©´ì— DTO ì¡°íšŒ ë°©ì‹ì€ SQLì„ ì§ì ‘ ë‹¤ë£¨ëŠ” ê²ƒê³¼ ìœ ì‚¬í•˜ê¸° ë•Œë¬¸ì— ë‘˜ ì‚¬ì´ì— ì¤„íƒ€ê¸°ë¥¼ í•´ì•¼ í•œë‹¤.
