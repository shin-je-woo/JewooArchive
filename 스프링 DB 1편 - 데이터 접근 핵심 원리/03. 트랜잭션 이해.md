# Previous
* 데이터베이스는 `트랜잭션`이라는 개념을 지원한다. (사전적 의미로 거래라는 뜻)
* 데이터베이스에서 트랜잭션은 하나의 작업단위를 안전하게 처리하도록 보장해주는 것을 뜻한다.
* 예를 들어서 A의 5000원을 B에게 계좌이체 할 때 A의 잔고를 5000원 감소하고, B의 잔고를 5000원 증가해야한다.
* 계좌이체라는 거래는 이렇게 2가지 작업이 합쳐져서 하나의 작업처럼 동작해야 한다.
* 만약 1번은 성공했는데 2번에서 시스템에 문제가 발생하면 계좌이체는 실패하고, A의 잔고만 5000원 감소하는 심각한 문제가 발생한다.
* 데이터베이스가 제공하는 `트랜잭션` 기능을 사용하면 1,2 둘다 함께 성공해야 저장(`commit`)하고, 중간에 하나라도 실패하면 거래 전의 상태(`rollback`)로 돌아갈 수 있다.

# 💡 트랜잭션 ACID
* `원자성(Atomicity)`: 트랜잭션 내에서 실행한 작업들은 마치 하나의 작업인 것처럼 모두 성공 하거나 모두 실패해야 한다.
* `일관성(Consistency)`: 모든 트랜잭션은 일관성 있는 데이터베이스 상태를 유지해야 한다. 예를 들어 데이터베이스에서 정한 무결성 제약 조건을 항상 만족해야 한다.
* `격리성(Isolation)`: 동시에 실행되는 트랜잭션들이 서로에게 영향을 미치지 않도록 격리한다. 예를 들어 동시에 같은 데이터를 수정하지 못하도록 해야 한다. 격리성은 동시성과 관련된 성능 이슈로 인해 트랜잭션 격리 수준(Isolation level)을 선택할 수 있다.
* `지속성(Durability)`: 트랜잭션을 성공적으로 끝내면 그 결과가 항상 기록되어야 한다. 중간에 시스템에 문제가 발생해도 데이터베이스 로그 등을 사용해서 성공한 트랜잭션 내용을 복구해야 한다.

### 트랜잭션 격리 수준 - Isolation level
* READ UNCOMMITED(커밋되지 않은 읽기)
* READ COMMITTED(커밋된 읽기)
* REPEATABLE READ(반복 가능한 읽기)
* SERIALIZABLE(직렬화 가능) 

# 💡 데이터베이스 연결 구조와 DB 세션
![image](https://github.com/shin-je-woo/TIL/assets/39439576/d118fc85-9b6b-4840-bdb3-430aaf141a13)
* 사용자는 웹 애플리케이션 서버(WAS)나 DB 접근 툴 같은 클라이언트를 사용해서 데이터베이스 서버에 접근할 수 있다. 클라이언트는 데이터베이스 서버에 연결을 요청하고 `커넥션`을 맺게 된다. 
* 이때 데이터베이스 서버는 내부에 `세션`이라는 것을 만든다. 그리고 앞으로 해당 커넥션을 통한 모든 요청은 이 세션을 통해서 실행하게 된다.
* 쉽게 이야기해서 개발자가 클라이언트를 통해 SQL을 전달하면 현재 커넥션에 연결된 세션이 SQL을 실행한다.
* `세션`은 `트랜잭션`을 시작하고, `커밋` 또는 `롤백`을 통해 트랜잭션을 종료한다. 그리고 이후에 새로운 트랜잭션을 다시 시작할 수 있다.
* 사용자가 커넥션을 닫거나, 또는 DBA(DB 관리자)가 세션을 강제로 종료하면 세션은 종료된다.
* 커넥션 풀이 10개의 커넥션을 생성하면, 세션도 10개 만들어진다.

### 트랜잭션 사용법
* 데이터 변경 쿼리를 실행하고 데이터베이스에 그 결과를 반영하려면 `commit` 을 호출하고, 결과를 반영하고 싶지 않으면 `rollback` 을 호출하면 된다.
* 커밋을 호출하기 전까지는 임시로 데이터를 저장하는 것이다. 따라서 해당 트랜잭션을 시작한 세션(사용자)에게만 변경 데이터가 보이고 다른 세션(사용자)에게는 변경 데이터가 보이지 않는다.

# 💡 DB 락 - 개념 이해
* 세션1이 트랜잭션을 시작하고 데이터를 수정하는 동안 아직 커밋을 수행하지 않았는데, 세션2에서 동시에 같은 데이터를 수정하게 되면 여러가지 문제가 발생한다.
* 바로 트랜잭션의 원자성이 깨지는 것이다. 
* 여기에 더해서 세션1이 중간에 롤백을 하게 되면 세션2는 잘못된 데이터를 수정하는 문제가 발생한다.
* 이런 문제를 방지하려면, 세션이 트랜잭션을 시작하고 데이터를 수정하는 동안에는 커밋이나 롤백 전까지 다른 세션에서 해당 데이터를 수정할 수 없게 막아야 한다.

![image](https://github.com/shin-je-woo/TIL/assets/39439576/8db8710f-57b7-4b42-9a66-61cb052643db)
* 세션1은 `memberA` 의 금액을 500원으로 변경하고 싶고, 세션2는 같은 `memberA` 의 금액을 1000원으로 변경하고 싶다.
* 데이터베이스는 이런 문제를 해결하기 위해 `락(Lock)` 이라는 개념을 제공한다.
* 다음 예시를 통해 동시에 데이터를 수정하는 문제를 락으로 어떻게 해결하는지 자세히 알아보자.

![image](https://github.com/shin-je-woo/TIL/assets/39439576/aa9e57b2-0249-4026-be2f-76f5e79a61b8)

1. 세션1은 트랜잭션을 시작한다.
2. 세션1은 `memberA` 의 `money` 를 500으로 변경을 시도한다. 이때 해당 로우의 락을 먼저 획득해야 한다. 락이 남아 있으므로 세션1은 락을 획득한다. (세션1이 세션2보다 조금 더 빨리 요청했다.)
3. 세션1은 락을 획득했으므로 해당 로우에 update sql을 수행한다.

![image](https://github.com/shin-je-woo/TIL/assets/39439576/3e17c7db-4e2f-40df-b0a9-5328a1576834)

4. 세션2는 트랜잭션을 시작한다.
5. 세션2도 `memberA` 의 `money` 데이터를 변경하려고 시도한다. 이때 해당 로우의 락을 먼저 획득해야 한다. 락이 없으므로 락이 돌아올 때 까지 대기한다.
* 참고로 세션2가 락을 무한정 대기하는 것은 아니다. 락 대기 시간을 넘어가면 락 타임아웃 오류가 발생한다. 락 대기 시간은 설정할 수 있다.

![image](https://github.com/shin-je-woo/TIL/assets/39439576/b7312378-57e2-41af-8fe3-6c5f3aa3bbe0)

6. 세션1은 커밋을 수행한다. 커밋으로 트랜잭션이 종료되었으므로 락도 반납한다.

![image](https://github.com/shin-je-woo/TIL/assets/39439576/e24fece2-bd3e-49ca-975c-320bb6fa4e41)

7. 세션2는 update sql을 수행한다.

![image](https://github.com/shin-je-woo/TIL/assets/39439576/a2d2a529-0ef0-4509-8ad2-61a80930bd38)

8. 세션2는 커밋을 수행하고 트랜잭션이 종료되었으므로 락을 반납한다.

# 💡 DB 락 - 조회
#### 일반적인 조회는 락을 사용하지 않는다.
* 데이터베이스마다 다르지만, 보통 데이터를 조회할 때는 락을 획득하지 않고 바로 데이터를 조회할 수 있다.
* 예를 들어서 세션1이 락을 획득하고 데이터를 변경하고 있어도, 세션2에서 데이터를 조회는 할 수 있다.
* 물론 세션2에서 조회가 아니라 데이터를 변경하려면 락이 필요하기 때문에 락이 돌아올 때 까지 대기해야 한다.

#### 조회와 락
* 데이터를 조회할 때도 락을 획득하고 싶을 때가 있다. 이럴 때는 `select for update` 구문을 사용하면 된다.
* 이렇게 하면 세션1이 조회 시점에 락을 가져가버리기 때문에 다른 세션에서 해당 데이터를 변경할 수 없다.
* 물론 이 경우도 트랜잭션을 커밋하면 락을 반납한다.

#### 조회 시점에 락이 필요한 경우는 언제일까?
* 트랜잭션 종료 시점까지 해당 데이터를 다른 곳에서 변경하지 못하도록 강제로 막아야 할 때 사용한다.
* 예를 들어서 애플리케이션 로직에서 `memberA` 의 금액을 조회한 다음에 이 금액 정보로 애플리케이션에서 어떤 계산을 수행한다. 
* 그런데 이 계산이 돈과 관련된 매우 중요한 계산이어서 계산을 완료할 때 까지 `memberA` 의 금액을 다른곳에서 변경하면 안된다. 이럴 때 조회 시점에 락을 획득하면 된다.

![image](https://github.com/shin-je-woo/TIL/assets/39439576/b3881b1a-0b7f-4f36-96bb-479212c99e11)
