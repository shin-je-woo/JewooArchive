# π’΅ νΈλμ­μ… AOP μ΄ν•΄
* μ§€κΈκΉμ§€ νΈλμ­μ…μ„ νΈλ¦¬ν•κ² μ²λ¦¬ν•κΈ° μ„ν•΄μ„ νΈλμ­μ… μ¶”μƒν™”λ„ λ„μ…ν•κ³ , μ¶”κ°€λ΅ λ°λ³µμ μΈ νΈλμ­μ… λ΅μ§μ„ ν•΄κ²°ν•κΈ° μ„ν•΄ νΈλμ­μ… ν…ν”λ¦Ώλ„ λ„μ…ν–λ‹¤.
* νΈλμ­μ… ν…ν”λ¦Ώ λ•λ¶„μ— νΈλμ­μ…μ„ μ²λ¦¬ν•λ” λ°λ³µ μ½”λ“λ” ν•΄κ²°ν•  μ μμ—λ‹¤. ν•μ§€λ§ μ„λΉ„μ¤ κ³„μΈµμ— μμν• λΉ„μ¦λ‹μ¤ λ΅μ§λ§ λ‚¨κΈ΄λ‹¤λ” λ©ν‘λ” μ•„μ§ λ‹¬μ„±ν•μ§€ λ»ν–λ‹¤.
* μ΄λ΄ λ• μ¤ν”„λ§ AOPλ¥Ό ν†µν•΄ ν”„λ΅μ‹λ¥Ό λ„μ…ν•λ©΄ λ¬Έμ λ¥Ό κΉ”λ”ν•κ² ν•΄κ²°ν•  μ μλ‹¤

![image](https://github.com/shin-je-woo/TIL/assets/39439576/ed3535af-a985-436a-8463-cca73284c4d9)
* ν”„λ΅μ‹λ¥Ό λ„μ…ν•κΈ° μ „μ—λ” κΈ°μ΅΄μ²λΌ μ„λΉ„μ¤μ λ΅μ§μ—μ„ νΈλμ­μ…μ„ μ§μ ‘ μ‹μ‘ν•λ‹¤.

β–¶οΈ μ„λΉ„μ¤ κ³„μΈµμ νΈλμ­μ… μ‚¬μ© μ½”λ“ μμ‹
```java
public void accountTransfer(String fromId, String toId, int money) throws SQLException {
    // νΈλμ­μ… μ‹μ‘
    TransactionStatus status = transactionManager.getTransaction(new DefaultTransactionDefinition());

    try {
        //λΉ„μ¦λ‹μ¤ λ΅μ§ μν–‰
        bizLogic(fromId, toId, money);
        transactionManager.commit(status); //μ„±κ³µ μ‹ μ»¤λ°‹
    } catch (Exception e) {
        transactionManager.rollback(status); //μ‹¤ν¨ μ‹ λ΅¤λ°±
        throw new IllegalStateException(e);
    }
}
```

![image](https://github.com/shin-je-woo/TIL/assets/39439576/47557f73-0ebc-42c6-8956-b010af2a2f84)
* ν”„λ΅μ‹λ¥Ό μ‚¬μ©ν•λ©΄ νΈλμ­μ…μ„ μ²λ¦¬ν•λ” κ°μ²΄μ™€ λΉ„μ¦λ‹μ¤ λ΅μ§μ„ μ²λ¦¬ν•λ” μ„λΉ„μ¤ κ°μ²΄λ¥Ό λ…ν™•ν•κ² λ¶„λ¦¬ν•  μ μλ‹¤.

β–¶οΈ νΈλμ­μ… ν”„λ΅μ‹ μ½”λ“ μμ‹
```java
public class TransactionProxy {

    private MemberService target;

    public void logic() {
        //νΈλμ­μ… μ‹μ‘
        TransactionStatus status = transactionManager.getTransaction(..);
        try {
            //μ‹¤μ  λ€μƒ νΈμ¶
            target.logic();
            transactionManager.commit(status); //μ„±κ³µμ‹ μ»¤λ°‹
        } catch (Exception e) {
            transactionManager.rollback(status); //μ‹¤ν¨μ‹ λ΅¤λ°±
            throw new IllegalStateException(e);
        }
    }
}
```

β–¶οΈ νΈλμ­μ… ν”„λ΅μ‹ μ μ© ν›„ μ„λΉ„μ¤ μ½”λ“ μμ‹
```java
public void logic() {
    //νΈλμ­μ… κ΄€λ ¨ μ½”λ“ μ κ±°, μμ λΉ„μ¦λ‹μ¤ λ΅μ§λ§ λ‚¨μ
    bizLogic(fromId, toId, money);
}
```

* ν”„λ΅μ‹ λ„μ… μ „: μ„λΉ„μ¤μ— λΉ„μ¦λ‹μ¤ λ΅μ§κ³Ό νΈλμ­μ… μ²λ¦¬ λ΅μ§μ΄ ν•¨κ» μ„μ—¬μλ‹¤.
* ν”„λ΅μ‹ λ„μ… ν›„: νΈλμ­μ… ν”„λ΅μ‹κ°€ νΈλμ­μ… μ²λ¦¬ λ΅μ§μ„ λ¨λ‘ κ°€μ Έκ°„λ‹¤. κ·Έλ¦¬κ³  νΈλμ­μ…μ„ μ‹μ‘ν• ν›„μ— μ‹¤μ  μ„λΉ„μ¤λ¥Ό λ€μ‹  νΈμ¶ν•λ‹¤. νΈλμ­μ… ν”„λ΅μ‹ λ•λ¶„μ— μ„λΉ„μ¤ κ³„μΈµμ—λ” μμν• λΉ„μ¦λ‹μ¤ λ΅μ§λ§ λ‚¨κΈΈ μ μλ‹¤.

## μ¤ν”„λ§μ΄ μ κ³µν•λ” νΈλμ­μ… AOP - @Transactional
* μ¤ν”„λ§μ΄ μ κ³µν•λ” AOP κΈ°λ¥μ„ μ‚¬μ©ν•λ©΄ ν”„λ΅μ‹λ¥Ό λ§¤μ° νΈλ¦¬ν•κ² μ μ©ν•  μ μλ‹¤.
* μ¤ν”„λ§ λ¶€νΈλ¥Ό μ‚¬μ©ν•λ©΄ νΈλμ­μ… AOPλ¥Ό μ²λ¦¬ν•κΈ° μ„ν•΄ ν•„μ”ν• μ¤ν”„λ§ λΉλ“¤λ„ μλ™μΌλ΅ λ“±λ΅ν•΄μ¤€λ‹¤.
* κ°λ°μλ” νΈλμ­μ… μ²λ¦¬κ°€ ν•„μ”ν• κ³³μ— `@Transactional` μ• λ…Έν…μ΄μ…λ§ λ¶™μ—¬μ£Όλ©΄ λλ‹¤. μ¤ν”„λ§μ νΈλμ­μ… AOPλ” μ΄ μ• λ…Έν…μ΄μ…μ„ μΈμ‹ν•΄μ„ νΈλμ­μ… ν”„λ΅μ‹λ¥Ό μ μ©ν•΄μ¤€λ‹¤.

> μ°Έκ³   
> μ¤ν”„λ§ AOPλ¥Ό μ μ©ν•λ ¤λ©΄ μ–΄λ“λ°”μ΄μ €, ν¬μΈνΈμ»·, μ–΄λ“λ°”μ΄μ¤κ°€ ν•„μ”ν•λ‹¤.   
> μ¤ν”„λ§μ€ νΈλμ­μ… AOP μ²λ¦¬λ¥Ό μ„ν•΄ λ‹¤μ ν΄λμ¤λ¥Ό μ κ³µν•λ‹¤. μ¤ν”„λ§ λ¶€νΈλ¥Ό μ‚¬μ©ν•λ©΄ ν•΄λ‹Ή λΉλ“¤μ€ μ¤ν”„λ§ μ»¨ν…μ΄λ„μ— μλ™μΌλ΅ λ“±λ΅λλ‹¤.  
> μ–΄λ“λ°”μ΄μ €: `BeanFactoryTransactionAttributeSourceAdvisor`  
> ν¬μΈνΈμ»·: `TransactionAttributeSourcePointcut`  
> μ–΄λ“λ°”μ΄μ¤: `TransactionInterceptor`  

# π’΅ νΈλμ­μ… AOP μ μ©
β–¶οΈ μ„λΉ„μ¤ μ½”λ“
```java
@Slf4j
@RequiredArgsConstructor
public class MemberServiceV3_3 {

    private final MemberRepositoryV3 memberRepository;

    @Transactional
    public void accountTransfer(String fromId, String toId, int money) throws SQLException {
        bizLogic(fromId, toId, money);
    }

    private void bizLogic(String fromId, String toId, int money) throws SQLException {
        Member fromMember = memberRepository.findById(fromId);
        Member toMember = memberRepository.findById(toId);

        memberRepository.update(fromId, fromMember.getMoney() - money);
        validation(toMember);
        memberRepository.update(toId, toMember.getMoney() + money);
    }
    
    private void validation(Member toMember) {
        if (toMember.getMemberId().equals("ex")) {
            throw new IllegalStateException("μ΄μ²΄ μ¤‘ μμ™Έ λ°μƒ");
        }
    }
}
```
* μ„λΉ„μ¤λ‹¨μ—μ„ μμν• λΉ„μ¦λ‹μ¤ λ΅μ§λ§ λ‚¨κΈ°κ³ , νΈλμ­μ… κ΄€λ ¨ μ½”λ“λ” λ¨λ‘ μ κ±°ν–λ‹¤.
* μ¤ν”„λ§μ΄ μ κ³µν•λ” νΈλμ­μ… AOPλ¥Ό μ μ©ν•κΈ° μ„ν•΄ `@Transactional` μ• λ…Έν…μ΄μ…μ„ μ¶”κ°€ν–λ‹¤.
* `@Transactional` μ• λ…Έν…μ΄μ…μ€ λ©”μ„λ“μ— λ¶™μ—¬λ„ λκ³ , ν΄λμ¤μ— λ¶™μ—¬λ„ λλ‹¤. 
* ν΄λμ¤μ— λ¶™μ΄λ©΄ μ™Έλ¶€μ—μ„ νΈμ¶ κ°€λ¥ν• `public λ©”μ„λ“`κ°€ AOP μ μ© λ€μƒμ΄ λλ‹¤.

β–¶οΈ ν…μ¤νΈ μ½”λ“
```java
@Slf4j
@SpringBootTest
class MemberServiceV3_3Test {

    ...

    @Autowired
    private MemberRepositoryV3 memberRepository;

    @Autowired
    private MemberServiceV3_3 memberService;

    @TestConfiguration
    static class TestConfig {
        @Bean
        DataSource dataSource() {
            return new DriverManagerDataSource(URL, USERNAME, PASSWORD);
        }

        @Bean
        PlatformTransactionManager transactionManager() {
            return new DataSourceTransactionManager(dataSource());
        }

        @Bean
        MemberRepositoryV3 memberRepositoryV3() {
            return new MemberRepositoryV3(dataSource());
        }

        @Bean
        MemberServiceV3_3 memberServiceV3_3() {
            return new MemberServiceV3_3(memberRepositoryV3());
        }
    }

    @AfterEach
    ...

    @Test
    @DisplayName("μ •μƒ μ΄μ²΄")
    ...
    
    @Test
    @DisplayName("μ΄μ²΄ μ¤‘ μμ™Έ λ°μƒ")
    void accountTransferEx() throws Exception {
        //given
        Member memberA = new Member(MEMBER_A, 10000);
        Member memberEx = new Member(MEMBER_EX, 10000);
        memberRepository.save(memberA);
        memberRepository.save(memberEx);

        //when
        assertThatThrownBy(() -> memberService.accountTransfer(memberA.getMemberId(), memberEx.getMemberId(), 2000))
                .isInstanceOf(IllegalStateException.class);

        //then
        Member findMemberA = memberRepository.findById(memberA.getMemberId());
        Member findMemberEx = memberRepository.findById(memberEx.getMemberId());

        //memberAμ λμ΄ λ΅¤λ°± λμ–΄μ•Ό ν•¨
        assertThat(findMemberA.getMoney()).isEqualTo(10000);
        assertThat(findMemberEx.getMoney()).isEqualTo(10000);
    }
}
```
#### `@SpringBootTest`
* μ¤ν”„λ§ AOPλ¥Ό μ μ©ν•λ ¤λ©΄ μ¤ν”„λ§ μ»¨ν…μ΄λ„κ°€ ν•„μ”ν•λ‹¤. 
* μ΄ μ• λ…Έν…μ΄μ…μ΄ μμΌλ©΄ ν…μ¤νΈμ‹ μ¤ν”„λ§ λ¶€νΈλ¥Ό ν†µν•΄ μ¤ν”„λ§ μ»¨ν…μ΄λ„λ¥Ό μƒμ„±ν•λ‹¤. 
* κ·Έλ¦¬κ³  ν…μ¤νΈμ—μ„ @Autowired λ“±μ„ ν†µν•΄ μ¤ν”„λ§ μ»¨ν…μ΄λ„κ°€ κ΄€λ¦¬ν•λ” λΉλ“¤μ„ μ‚¬μ©ν•  μ μλ‹¤.

#### `@TestConfiguration`
* ν…μ¤νΈ μ½”λ“μ—μ„ μ¤ν”„λ§λΉμ„ λ“±λ΅ν•κ³  μ‹¶μΌλ©΄ λ‚΄λ¶€ μ„¤μ • ν΄λμ¤λ¥Ό λ§λ“¤μ–΄μ„ μ΄ μ–΄λ…Έν…μ΄μ…μ„ μ‚¬μ©ν•λ©΄ λλ‹¤.
* μ¤ν”„λ§ λ¶€νΈκ°€ μλ™μΌλ΅ λ§λ“¤μ–΄μ£Όλ” λΉλ“¤μ— μ¶”κ°€λ΅ ν•„μ”ν• μ¤ν”„λ§ λΉλ“¤μ„ λ“±λ΅ν•κ³  ν…μ¤νΈλ¥Ό μν–‰ν•  μ μλ‹¤.

#### `TestConfig`
* `DataSource` μ¤ν”„λ§μ—μ„ κΈ°λ³ΈμΌλ΅ μ‚¬μ©ν•  λ°μ΄ν„°μ†μ¤λ¥Ό μ¤ν”„λ§ λΉμΌλ΅ λ“±λ΅ν•λ‹¤. μ¶”κ°€λ΅ νΈλμ­μ… λ§¤λ‹μ €μ—μ„λ„ μ‚¬μ©ν•λ‹¤.
* `DataSourceTransactionManager` νΈλμ­μ… λ§¤λ‹μ €λ¥Ό μ¤ν”„λ§ λΉμΌλ΅ λ“±λ΅ν•λ‹¤.
* μ¤ν”„λ§μ΄ μ κ³µν•λ” νΈλμ­μ… AOPλ” μ¤ν”„λ§ λΉμ— λ“±λ΅λ νΈλμ­μ… λ§¤λ‹μ €λ¥Ό μ°Ύμ•„μ„ μ‚¬μ©ν•κΈ° λ•λ¬Έμ— νΈλμ­μ… λ§¤λ‹μ €λ¥Ό μ¤ν”„λ§ λΉμΌλ΅ λ“±λ΅ν•΄λ‘μ–΄μ•Ό ν•λ‹¤.

## AOP ν”„λ΅μ‹ μ μ© ν™•μΈ
```java
@Test
void AopCheck() {
    log.info("memberService class = {}", memberService.getClass());
    log.info("memberRepository class = {}", memberRepository.getClass());
    assertThat(AopUtils.isAopProxy(memberService)).isTrue();
    assertThat(AopUtils.isAopProxy(memberRepository)).isFalse();
}
```
```java
memberService class = class study.jdbc.service.MemberServiceV3_3$$EnhancerBySpringCGLIB$$...
memberRepository class = class study.jdbc.repository.MemberRepositoryV3
```
* λ¨Όμ € AOP ν”„λ΅μ‹κ°€ μ μ©λμ—λ”μ§€ ν™•μΈν•΄λ³΄μ. 
* AopCheck() μ μ‹¤ν–‰ κ²°κ³Όλ¥Ό λ³΄λ©΄ `memberService` μ— `EnhancerBySpringCGLIB..` λΌλ” λ¶€λ¶„μ„ ν†µν•΄ ν”„λ΅μ‹(CGLIB)κ°€ μ μ©λ κ²ƒμ„ ν™•μΈν•  μ μλ‹¤.
* `memberRepository` μ—λ” AOPλ¥Ό μ μ©ν•μ§€ μ•μ•κΈ° λ•λ¬Έμ— ν”„λ΅μ‹κ°€ μ μ©λμ§€ μ•λ”λ‹¤.
* λ‚λ¨Έμ§€ ν…μ¤νΈ μ½”λ“λ“¤μ„ μ‹¤ν–‰ν•΄λ³΄λ©΄ νΈλμ­μ…μ΄ μ •μƒ μν–‰λκ³ , μ‹¤ν¨μ‹ μ •μƒ λ΅¤λ°±λ κ²ƒμ„ ν™•μΈν•  μ μλ‹¤.

# π’΅ νΈλμ­μ… AOP μ •λ¦¬
![image](https://github.com/shin-je-woo/TIL/assets/39439576/9f813095-57e5-4a7f-9708-1442c7ecfbb3)

* μ¤ν”„λ§μ΄ μ κ³µν•λ” μ„ μ–Έμ  νΈλμ­μ… κ΄€λ¦¬ λ•λ¶„μ— λ“λ””μ–΄ νΈλμ­μ… κ΄€λ ¨ μ½”λ“λ¥Ό μμν• λΉ„μ¦λ‹μ¤ λ΅μ§μ—μ„ μ κ±°ν•  μ μμ—λ‹¤.
* κ°λ°μλ” νΈλμ­μ…μ΄ ν•„μ”ν• κ³³μ— @Transactional μ• λ…Έν…μ΄μ… ν•λ‚λ§ μ¶”κ°€ν•λ©΄ λλ‹¤. λ‚λ¨Έμ§€λ” μ¤ν”„λ§ νΈλμ­μ… AOPκ°€ μλ™μΌλ΅ μ²λ¦¬ν•΄μ¤€λ‹¤.
* @Transactional μ• λ…Έν…μ΄μ…μ μμ„Έν• μ‚¬μ©λ²•μ€ λ’¤μ—μ„ μ„¤λ…ν•λ‹¤. μ§€κΈμ€ μ „μ²΄ κµ¬μ΅°λ¥Ό μ΄ν•΄ν•λ”λ° μ΄μ μ„ λ§μ¶”μ.

## μ¤ν”„λ§ λ¶€νΈμ μλ™ λ¦¬μ†μ¤ λ“±λ΅
* μ¤ν”„λ§ λ¶€νΈκ°€ λ“±μ¥ν•κΈ° μ΄μ „μ—λ” λ°μ΄ν„°μ†μ¤μ™€ νΈλμ­μ… λ§¤λ‹μ €λ¥Ό κ°λ°μκ°€ μ§μ ‘ μ¤ν”„λ§ λΉμΌλ΅ λ“±λ΅ν•΄μ„ μ‚¬μ©ν–λ‹¤. 
* κ·Έλ°λ° μ¤ν”„λ§ λ¶€νΈλ΅ κ°λ°μ„ μ‹μ‘ν• κ°λ°μλΌλ©΄ λ°μ΄ν„°μ†μ¤λ‚ νΈλμ­μ… λ§¤λ‹μ €λ¥Ό μ§μ ‘ λ“±λ΅ν• μ μ΄ μ—†μ„ κ²ƒμ΄λ‹¤.

#### λ°μ΄ν„°μ†μ¤ - μλ™ λ“±λ΅
* μ¤ν”„λ§ λ¶€νΈλ” λ°μ΄ν„°μ†μ¤( `DataSource` )λ¥Ό μ¤ν”„λ§ λΉμ— μλ™μΌλ΅ λ“±λ΅ν•λ‹¤.
* μλ™μΌλ΅ λ“±λ΅λλ” μ¤ν”„λ§ λΉ μ΄λ¦„: `dataSource`
* μ°Έκ³ λ΅ κ°λ°μκ°€ μ§μ ‘ λ°μ΄ν„°μ†μ¤λ¥Ό λΉμΌλ΅ λ“±λ΅ν•λ©΄ μ¤ν”„λ§ λ¶€νΈλ” λ°μ΄ν„°μ†μ¤λ¥Ό μλ™μΌλ΅ λ“±λ΅ν•μ§€ μ•λ”λ‹¤.
* μ¤ν”„λ§ λ¶€νΈλ” λ‹¤μκ³Ό κ°™μ΄ `application.properties` μ— μλ” μ†μ„±μ„ μ‚¬μ©ν•΄μ„ `DataSource` λ¥Ό μƒμ„±ν•λ‹¤. κ·Έλ¦¬κ³  μ¤ν”„λ§ λΉμ— λ“±λ΅ν•λ‹¤.

```properties
spring.datasource.url=jdbc:h2:tcp://localhost/~/jdbc
spring.datasource.username=sa
spring.datasource.password=
```
* μ¤ν”„λ§ λ¶€νΈκ°€ κΈ°λ³ΈμΌλ΅ μƒμ„±ν•λ” λ°μ΄ν„°μ†μ¤λ” μ»¤λ„¥μ…ν’€μ„ μ κ³µν•λ” `HikariDataSource` μ΄λ‹¤.
* μ»¤λ„¥μ…ν’€κ³Ό κ΄€λ ¨λ μ„¤μ •λ„ `application.properties` λ¥Ό ν†µν•΄μ„ μ§€μ •ν•  μ μλ‹¤.
* `spring.datasource.url` μ†μ„±μ΄ μ—†μΌλ©΄ λ‚΄μ¥ λ°μ΄ν„°λ² μ΄μ¤(λ©”λ¨λ¦¬ DB)λ¥Ό μƒμ„±ν•λ ¤κ³  μ‹λ„ν•λ‹¤.

#### νΈλμ­μ… λ§¤λ‹μ € - μλ™ λ“±λ΅
* μ¤ν”„λ§ λ¶€νΈλ” μ μ ν• νΈλμ­μ… λ§¤λ‹μ €( `PlatformTransactionManager` )λ¥Ό μλ™μΌλ΅ μ¤ν”„λ§ λΉμ— λ“±λ΅ν•λ‹¤.
* μλ™μΌλ΅ λ“±λ΅λλ” μ¤ν”„λ§ λΉ μ΄λ¦„: `transactionManager`
* μ°Έκ³ λ΅ κ°λ°μκ°€ μ§μ ‘ νΈλμ­μ… λ§¤λ‹μ €λ¥Ό λΉμΌλ΅ λ“±λ΅ν•λ©΄ μ¤ν”„λ§ λ¶€νΈλ” νΈλμ­μ… λ§¤λ‹μ €λ¥Ό μλ™μΌλ΅ λ“±λ΅ν•μ§€ μ•λ”λ‹¤.
* μ–΄λ–¤ νΈλμ­μ… λ§¤λ‹μ €λ¥Ό μ„ νƒν• μ§€λ” ν„μ¬ λ“±λ΅λ λΌμ΄λΈλ¬λ¦¬λ¥Ό λ³΄κ³  νλ‹¨ν•λ‹¤.
  * JDBCλ¥Ό κΈ°μ μ„ μ‚¬μ©ν•λ©΄ `DataSourceTransactionManager` λ¥Ό λΉμΌλ΅ λ“±λ΅
  * JPAλ¥Ό μ‚¬μ©ν•λ©΄ `JpaTransactionManager` λ¥Ό λΉμΌλ΅ λ“±λ΅
  * λ‘λ‹¤ μ‚¬μ©ν•λ” κ²½μ° `JpaTransactionManager` λ¥Ό λ“±λ΅
  * `JpaTransactionManager` λ” `DataSourceTransactionManager` κ°€ μ κ³µν•λ” κΈ°λ¥λ„ λ€λ¶€λ¶„ μ§€μ›ν•λ‹¤.
