# ğŸ’¡ í”„ë¡ì‹œ
### í”„ë¡ì‹œ ê¸°ì´ˆ

âœ… em.find() vs em.getReference() 
* em.find(): ë°ì´í„°ë² ì´ìŠ¤ë¥¼ í†µí•´ì„œ ì‹¤ì œ ì—”í‹°í‹° ê°ì²´ ì¡°íšŒ
* em.getReference(): ë°ì´í„°ë² ì´ìŠ¤ ì¡°íšŒë¥¼ ë¯¸ë£¨ëŠ” ê°€ì§œ(í”„ë¡ì‹œ) ì—”í‹°í‹° ê°ì²´ ì¡°íšŒ

![image](https://user-images.githubusercontent.com/39439576/231021875-05e73775-39a4-43a2-b1a5-356279c931bb.png)

### í”„ë¡ì‹œ íŠ¹ì§•
* ì‹¤ì œ í´ë˜ìŠ¤ë¥¼ ìƒì† ë°›ì•„ì„œ ë§Œë“¤ì–´ì§„ë‹¤.
* ì‹¤ì œ í´ë˜ìŠ¤ì™€ ê²‰ ëª¨ì–‘ì´ ê°™ë‹¤.
* ì‚¬ìš©í•˜ëŠ” ì…ì¥ì—ì„œëŠ” ì§„ì§œ ê°ì²´ì¸ì§€ í”„ë¡ì‹œ ê°ì²´ì¸ì§€ êµ¬ë¶„í•˜ì§€ ì•Šê³  ì‚¬ìš©í•˜ë©´ ëœë‹¤.(ì´ë¡ ìƒ)
* í”„ë¡ì‹œ ê°ì²´ëŠ” ì‹¤ì œ ê°ì²´ì˜ ì°¸ì¡°(target)ë¥¼ ë³´ê´€í•œë‹¤.
* í”„ë¡ì‹œ ê°ì²´ë¥¼ í˜¸ì¶œ(getName())í•˜ë©´ í”„ë¡ì‹œ ê°ì²´ëŠ” ì‹¤ì œ ê°ì²´ì˜ ë©”ì†Œë“œ í˜¸ì¶œ

![image](https://user-images.githubusercontent.com/39439576/231022091-4334dd70-2a1b-4beb-bc12-2a34ff8f96db.png)

* í”„ë¡ì‹œ ê°ì²´ëŠ” ì²˜ìŒ ì‚¬ìš©í•  ë•Œ í•œ ë²ˆë§Œ ì´ˆê¸°í™”
* í”„ë¡ì‹œ ê°ì²´ë¥¼ ì´ˆê¸°í™” í•  ë•Œ í”„ë¡ì‹œ ê°ì²´ê°€ ì‹¤ì œ ì—”í‹°í‹°ë¡œ ë°”ë€ŒëŠ” ê²ƒì€ ì•„ë‹˜, ì´ˆê¸°í™”ë˜ë©´ í”„ë¡ì‹œ ê°ì²´ë¥¼ í†µí•´ì„œ ì‹¤ì œ ì—”í‹°í‹°ì— ì ‘ê·¼ ê°€ëŠ¥
* í”„ë¡ì‹œ ê°ì²´ëŠ” ì›ë³¸ ì—”í‹°í‹°ë¥¼ ìƒì†ë°›ìŒ, ë”°ë¼ì„œ íƒ€ì… ì²´í¬ì‹œ ì£¼ì˜í•´ì•¼í•¨ (== ë¹„êµ ì‹¤íŒ¨, ëŒ€ì‹  instance of ì‚¬ìš©)
* ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì°¾ëŠ” ì—”í‹°í‹°ê°€ ì´ë¯¸ ìˆìœ¼ë©´ em.getReference()ë¥¼ í˜¸ì¶œí•´ë„ ì‹¤ì œ ì—”í‹°í‹° ë°˜í™˜
* ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì˜ ë„ì›€ì„ ë°›ì„ ìˆ˜ ì—†ëŠ” ì¤€ì˜ì† ìƒíƒœì¼ ë•Œ, í”„ë¡ì‹œë¥¼ ì´ˆê¸°í™”í•˜ë©´ ë¬¸ì œ ë°œìƒ  
  â†’ (í•˜ì´ë²„ë„¤ì´íŠ¸ëŠ” org.hibernate.LazyInitializationException ì˜ˆì™¸ë¥¼ í„°íŠ¸ë¦¼)

### í”„ë¡ì‹œ ê°ì²´ì˜ ì´ˆê¸°í™”
![image](https://user-images.githubusercontent.com/39439576/231022868-fb3bcd35-6b58-4cff-8d55-6f3596f0fcc8.png)
* em.getReference() ë©”ì†Œë“œë¡œ Memberì—”í‹°í‹°ì˜ í”„ë¡ì‹œ ê°ì²´ë¥¼ ì¡°íšŒí•œë‹¤.
* í”„ë¡ì‹œ ê°ì²´ë¥¼ í˜¸ì¶œí•  ë•Œ(member.getName()) ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì‹¤ì œ ì—”í‹°í‹° ì¡°íšŒë¥¼ ìš”ì²­í•˜ëŠ”ë° ì´ê²ƒì„ ì´ˆê¸°í™”ë¼ í•œë‹¤.
* ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ëŠ” ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì¡°íšŒí•´ì„œ ì‹¤ì œ ì—”í‹°í‹° ê°ì²´ë¥¼ ìƒì„±í•œë‹¤.
* í”„ë¡ì‹œ ê°ì²´ëŠ” ìƒì„±ëœ ì‹¤ì œ ì—”í‹°í‹° ê°ì²´ì˜ ì°¸ì¡°ë¥¼ Member target ë©¤ë²„ ë³€ìˆ˜ì— ë³´ê´€í•œë‹¤.
* í”„ë¡ì‹œ ê°ì²´ëŠ” ì‹¤ì œ ì—”í‹°í‹° ê°ì²´ì˜ getName() ì„ í˜¸ì¶œ(ìœ„ì„)í•´ì„œ ê²°ê³¼ë¥¼ ë°˜í™˜í•œë‹¤.

### í”„ë¡ì‹œ í™•ì¸
* í”„ë¡ì‹œ ì¸ìŠ¤í„´ìŠ¤ì˜ ì´ˆê¸°í™” ì—¬ë¶€ í™•ì¸  
  PersistenceUnitUtil.isLoaded(Object entity) â†’ entityManagerFactory.getPersistenceUnitUtil().isLoaded(object)
* í”„ë¡ì‹œ í´ë˜ìŠ¤ í™•ì¸ ë°©ë²•  
  entity.getClass().getname() ì¶œë ¥(..javasist.. or HibernateProxy...)
* í”„ë¡ì‹œ ê°•ì œ ì´ˆê¸°í™”  
  org.hibernate.Hibernate.initialize(entity);
* ì°¸ê³ : JPA í‘œì¤€ì€ ê°•ì œ ì´ˆê¸°í™” ì—†ìŒ  
  ê°•ì œ í˜¸ì¶œ: method.getName();

# ğŸ’¡ ì¦‰ì‹œ ë¡œë”©ê³¼ ì§€ì—° ë¡œë”©
### ì§€ì—°ë¡œë”©
â“ Memberë¥¼ ì¡°íšŒí•  ë•Œ Team(ì—°ê´€ê´€ê³„)ë„ í•¨ê»˜ ì¡°íšŒí•´ì•¼ í• ê¹Œ?  
   : ë‹¨ìˆœíˆ member ì •ë³´ë§Œ ì‚¬ìš©í•˜ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
   
â–¶ï¸ ì§€ì—° ë¡œë”© LAZYì„ ì‚¬ìš©í•´ì„œ í”„ë¡ì‹œë¡œ ì¡°íšŒ
```java
@Entity
public class Member {
    ...
    @ManyToOne(fetch = FetchType.LAZY) //ì§€ì—°ë¡œë”© ì‚¬ìš©
    @JoinColumn(name="TEAM_ID")
    private Team team;
    ...
}
...
Member m = em.find(Member.class, member1.getId()); //Member ê°ì²´ ë°˜í™˜
System.out.println("m = "+ m.getTeam().getClass()); //Team$HibernateProxyê°ì²´ ë°˜í™˜
m.getTeam().getName() // ì‹¤ì œ teamì„ ì‚¬ìš©í•˜ëŠ” ì‹œì ì— í”„ë¡ì‹œ ì´ˆê¸°í™”(DB ì¡°íšŒ)
...
```

### ì¦‰ì‹œ ë¡œë”©
â“ Memberì™€ Teamì„ ê°™ì´ ì“°ëŠ” ë¹ˆë„ê°€ ë†’ì„ ê²½ìš°ì—ëŠ” ì–´ë–»ê²Œ í•´ì•¼ í• ê¹Œ?

â–¶ï¸ ì¦‰ì‹œ ë¡œë”© EAGERë¥¼ ì‚¬ìš©í•´ì„œ í•¨ê»˜ ì¡°íšŒ
```java
@Entity
public class Member {
    ...
    @ManyToOne(fetch = FetchType.EAGER) //ì¦‰ì‹œë¡œë”© ì‚¬ìš©
    @JoinColumn(name="TEAM_ID")
    private Team team;
    ...
}
...
Member m = em.find(Member.class, member1.getId()); //Member ê°ì²´ ë°˜í™˜
System.out.println("m = "+ m.getTeam().getClass()); //Team ê°ì²´ ë°˜í™˜(í”„ë¡ì‹œê°€ ì•„ë‹Œ ì‹¤ì œ ì—”í‹°í‹°)
...
```

### â— í”„ë¡ì‹œì™€ ì¦‰ì‹œë¡œë”© ì£¼ì˜
* ê°€ê¸‰ì  ì§€ì—° ë¡œë”©ë§Œ ì‚¬ìš©(íŠ¹íˆ ì‹¤ë¬´ì—ì„œ)
* ì¦‰ì‹œ ë¡œë”©ì„ ì ìš©í•˜ë©´ ì˜ˆìƒí•˜ì§€ ëª»í•œ SQLì´ ë°œìƒ
* ì¦‰ì‹œ ë¡œë”©ì€ JPQLì—ì„œ N+1 ë¬¸ì œë¥¼ ì¼ìœ¼í‚¨ë‹¤.  
â–¶ï¸ N+1 ë¬¸ì œ ì˜ˆì‹œ
```java
public class Member {
    ...
    @ManyToOne(fetch = FetchType.EAGER) //ì¦‰ì‹œë¡œë”© ì‚¬ìš©
    @JoinColumn(name="TEAM_ID")
    private Team team;
    ...
}
...
List<Member> members = em.createQuery("select m from Member m", Member.class)
                          .getResultList();
//
//SQL: select * from Member
//SQL: select * from Team where TEAM_ID = xxx << ë©¤ë²„ ìˆ˜ë§Œí¼ ìˆ˜í–‰ë¨!!
...
```
ìœ„ JPQLì„ ê·¸ëŒ€ë¡œ ì¿¼ë¦¬ë¡œ ë²ˆì—­í•˜ê²Œ ë˜ë©´ Memberë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•œ ì¿¼ë¦¬ ìˆ˜í–‰ ì´í›„ ë°”ë¡œ Member ë‚´ë¶€ì˜ Teamì„ ê°€ì ¸ì˜¤ê¸° ìœ„í•œ ì¿¼ë¦¬ë¥¼ ë‹¤ì‹œ ìˆ˜í–‰í•˜ê²Œ ëœë‹¤ â†’ N+1(1ê°œì˜ ì¿¼ë¦¬ë¥¼ ë‚ ë¦¬ë©´ +Nê°œì˜ ì¿¼ë¦¬ê°€ ì¶”ê°€ ìˆ˜í–‰ëœë‹¤.)
* @ManyToOne, @OneToOneì€ ê¸°ë³¸ì´ ì¦‰ì‹œ ë¡œë”© -> ì§ì ‘ ì „ë¶€ LAZYë¡œ ì„¤ì •
* @OneToMany, @ManyToManyëŠ” ê¸°ë³¸ì´ ì§€ì—° ë¡œë”©

# ğŸ’¡ ì˜ì†ì„± ì „ì´: CASCADE
* íŠ¹ì • ì—”í‹°í‹°ë¥¼ ì˜ì† ìƒíƒœë¡œ ë§Œë“¤ ë•Œ ì—°ê´€ëœ ì—”í‹°í‹°ë„ í•¨ê»˜ ì˜ì† ìƒíƒœë¡œ ë§Œë“¤ê³  ì‹¶ì„ ë•Œ ì‚¬ìš©  
  ex) ë¶€ëª¨ ì—”í‹°í‹°ë¥¼ ì €ì¥í•  ë•Œ ìì‹ ì—”í‹°í‹°ë„ í•¨ê»˜ ì €ì¥
* ì˜ì†ì„± ì „ì´ëŠ” ì—°ê´€ê´€ê³„ë¥¼ ë§¤í•‘í•˜ëŠ” ê²ƒê³¼ ì•„ë¬´ ê´€ë ¨ì´ ì—†ìŒ
* ì—”í‹°í‹°ë¥¼ ì˜ì†í™”í•  ë•Œ ì—°ê´€ëœ ì—”í‹°í‹°ë„ í•¨ê»˜ ì˜ì†í™”í•˜ëŠ” í¸ë¦¬í•¨ì„ ì œê³µí•  ë¿

âœ… CASCADEì˜ ì¢…ë¥˜
* ALL: ëª¨ë‘ ì ìš©
* PERSIST: ì˜ì†
* REMOVE: ì‚­ì œ
* MERGE: ë³‘í•©
* REFRESH: REFRESH
* DETACH: DETACH

â–¶ï¸ ì˜ì†ì„± ì „ì´(CASCADE)ë¥¼ ì´ìš©í•œ ì—”í‹°í‹° ì €ì¥ ë°©ë²•
```java
@Entity
public class Parent{
    ...
    @OneToMany(mappedBy = "parent", cascade=CascadeType.ALL)//ì˜ì†ì„± ì „ì´ ì†ì„±(CASCADE)ì‚¬ìš©
    private List<Child> childList = new ArrayList<>();

    public void addChild(Child child) {
        childList.add(child);
        child.setParent(this);
    }
    ...
}
@Entity
public class Child {
    ...
    @ManyToOne
    @JoinColumn(name = "parent_id")
    private Parent parent;
    ...
}

...
Child child1 = new Child();
Child child2 = new Child();
Parent parent = new Parent();
parent.addChild(child1);
parent.addChild(child2);

em.persist(parent);// parentë§Œ persist í•´ì£¼ë‹ˆ childë„ ê°™ì´ persistëœë‹¤.
```

# ğŸ’¡ ê³ ì•„ ê°ì²´
* ê³ ì•„ ê°ì²´ ì œê±°: ë¶€ëª¨ ì—”í‹°í‹°ì™€ ì—°ê´€ê´€ê³„ê°€ ëŠì–´ì§„ ìì‹ ì—”í‹°í‹°ë¥¼ ìë™ìœ¼ë¡œ ì‚­ì œ
* ì°¸ì¡°ê°€ ì œê±°ëœ ì—”í‹°í‹°ëŠ” ë‹¤ë¥¸ ê³³ì—ì„œ ì°¸ì¡°í•˜ì§€ ì•ŠëŠ” ê³ ì•„ ê°ì²´ë¡œ ê°„ì£¼í•˜ê³  ì‚­ì œí•˜ëŠ” ê¸°ëŠ¥
* ì°¸ì¡°í•˜ëŠ” ê³³ì´ í•˜ë‚˜ì¼ ë•Œ ì‚¬ìš©í•´ì•¼í•¨!
* íŠ¹ì • ì—”í‹°í‹°ê°€ ê°œì¸ ì†Œìœ í•  ë•Œ ì‚¬ìš©
* @OneToOne, @OneToManyë§Œ ê°€ëŠ¥
* ì°¸ê³ : ê°œë…ì ìœ¼ë¡œ ë¶€ëª¨ë¥¼ ì œê±°í•˜ë©´ ìì‹ì€ ê³ ì•„ê°€ ëœë‹¤. ë”°ë¼ì„œ ê³ ì•„ ê°ì²´ ì œê±° ê¸°ëŠ¥ì„ í™œì„±í™” í•˜ë©´, ë¶€ëª¨ë¥¼ ì œê±°í•  ë•Œ ìì‹ë„ í•¨ê»˜ì œê±°ëœë‹¤. ì´ê²ƒì€ CascadeType.REMOVEì²˜ëŸ¼ ë™ì‘í•œë‹¤.

â–¶ï¸ orphanRemoval = true
```java
Child child1 = new Child();
Child child2 = new Child();
Parent parent = new Parent();
parent.addChild(child1);
parent.addChild(child2);

em.persist(parent);// parentë§Œ persist í•´ì£¼ë‹ˆ childë„ ê°™ì´ persistëœë‹¤.

em.flush();
em.clear();

Parent findParent = em.find(Parent.class, parent.getId());
findParent.getChildList().remove(0); // orphanRemoval ë™ì‘
//@OneToMany(mappedBy = "parent", cascade=CascadeType.ALL, orphanRemoval = true)
//private List<Child> childList = new ArrayList<>();
```

# ğŸ’¡ ì˜ì†ì„± ì „ì´ + ê³ ì•„ ê°ì²´, ìƒëª…ì£¼ê¸°
* CascadeType.ALL + orphanRemoval=true
* ìŠ¤ìŠ¤ë¡œ ìƒëª…ì£¼ê¸°ë¥¼ ê´€ë¦¬í•˜ëŠ” ì—”í‹°í‹°ëŠ” em.persist()ë¡œ ì˜ì†í™”, em.remove()ë¡œ ì œê±°
* ë‘ ì˜µì…˜ì„ ëª¨ë‘ í™œì„±í™” í•˜ë©´ ë¶€ëª¨ ì—”í‹°í‹°ë¥¼ í†µí•´ì„œ ìì‹ì˜ ìƒëª…ì£¼ê¸°ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŒ
* ë„ë©”ì¸ ì£¼ë„ ì„¤ê³„(DDD)ì˜ Aggregate Rootê°œë…ì„ êµ¬í˜„í•  ë•Œ ìœ ìš©
