# ğŸ’¡ ì£¼ë¬¸ ì—”í‹°í‹° ì½”ë“œ(ìƒì„±ë©”ì„œë“œ, ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§)
```java
@Entity
@Table(name = "ORDERS")
@Getter @Setter
public class Order {

    @Id
    @GeneratedValue
    @Column(name = "order_id")
    private Long id;
    
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name="member_id")
    private Member member; //ì£¼ë¬¸ íšŒì›
    
    @OneToMany(mappedBy = "order",cascade = CascadeType.ALL)
    private List<OrderItem> orderItems = new ArrayList<>();
    
    @OneToOne(fetch = FetchType.LAZY, cascade = CascadeType.ALL)
    @JoinColumn(name = "delivery_id")
    private Delivery delivery; //ë°°ì†¡ ì •ë³´

    private LocalDateTime orderDate; //ì£¼ë¬¸ ì‹œê°„
    
    @Enumerated(EnumType.STRING)
    private OrderStatus status; //ì£¼ë¬¸ìƒíƒœ [ORDER, CANCEL]

    //==ì—°ê´€ê´€ê³„ ë©”ì„œë“œ==//
    public void setMember(Member member) {
        this.member = member;
        member.getOrders().add(this);
    }
    public void addOrderItem(OrderItem orderItem) {
        orderItems.add(orderItem);
        orderItem.setOrder(this);
    }
    public void setDelivery(Delivery delivery) {
        this.delivery = delivery;
        delivery.setOrder(this);
    }

    //==ìƒì„± ë©”ì„œë“œ==//
    public static Order createOrder(Member member, 
																		Delivery delivery, 
																		OrderItem... orderItems) {
        Order order = new Order();
        order.setMember(member);
        order.setDelivery(delivery);
        for(OrderItem orderItem: orderItems) {
            order.addOrderItem(orderItem);
        }
        order.setStatus(OrderStatus.ORDER);
        order.setOrderDate(LocalDateTime.now());
        return order;
    }

    //==ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§==//
    /**
     * ì£¼ë¬¸ ì·¨ì†Œ
     */
    public void cancel() {
        if(delivery.getStatus() == DeliveryStatus.COMP) {
            throw new IllegalStateException("ì´ë¯¸ ë°°ì†¡ì™„ë£Œëœ ìƒí’ˆì€ ì·¨ì†Œê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.");
        }
        this.setStatus(OrderStatus.CANCEL);
        for(OrderItem orderItem : orderItems){
            orderItem.cancel();
        }
    }

    //==ì¡°íšŒ ë¡œì§ ==//
    /**
     * ì „ì²´ ì£¼ë¬¸ ê°€ê²© ì¡°íšŒ
     */
    public int getTotalPrice() {
        int totalPrice = 0;
        for(OrderItem orderItem : orderItems){
            totalPrice += orderItem.getTotalPrice();
        }
        return totalPrice;
    }
}
```
* ìƒì„± ë©”ì„œë“œ( createOrder() ): ì£¼ë¬¸ ì—”í‹°í‹°ë¥¼ ìƒì„±í•  ë•Œ ì‚¬ìš©í•œë‹¤. ì£¼ë¬¸ íšŒì›, ë°°ì†¡ì •ë³´, ì£¼ë¬¸ìƒí’ˆì˜ ì •ë³´ë¥¼ ë°›ì•„ì„œ ì‹¤ì œ ì£¼ë¬¸ ì—”í‹°í‹°ë¥¼ ìƒì„±í•œë‹¤.
* ì£¼ë¬¸ ì·¨ì†Œ( cancel() ): ì£¼ë¬¸ ì·¨ì†Œì‹œ ì‚¬ìš©í•œë‹¤. ì£¼ë¬¸ ìƒíƒœë¥¼ ì·¨ì†Œë¡œ ë³€ê²½í•˜ê³  ì£¼ë¬¸ìƒí’ˆì— ì£¼ë¬¸ ì·¨ì†Œë¥¼ ì•Œë¦°ë‹¤. ë§Œì•½ ì´ë¯¸ ë°°ì†¡ì„ ì™„ë£Œí•œ ìƒí’ˆì´ë©´ ì£¼ë¬¸ì„ ì·¨ì†Œí•˜ì§€ ëª»í•˜ë„ë¡ ì˜ˆì™¸ë¥¼ ë°œìƒì‹œí‚¨ë‹¤.
* ì „ì²´ ì£¼ë¬¸ ê°€ê²© ì¡°íšŒ: ì£¼ë¬¸ ì‹œ ì‚¬ìš©í•œ ì „ì²´ ì£¼ë¬¸ ê°€ê²©ì„ ì¡°íšŒí•œë‹¤. ì „ì²´ ì£¼ë¬¸ ê°€ê²©ì„ ì•Œë ¤ë©´ ê°ê°ì˜ ì£¼ë¬¸ìƒí’ˆ ê°€ê²©ì„ ì•Œì•„ì•¼ í•œë‹¤. ë¡œì§ì„ ë³´ë©´ ì—°ê´€ëœ ì£¼ë¬¸ìƒí’ˆë“¤ì˜ ê°€ê²©ì„ ì¡°íšŒí•´ì„œ ë”í•œ ê°’ì„ ë°˜í™˜í•œë‹¤. (ì‹¤ë¬´ì—ì„œëŠ” ì£¼ë¡œ ì£¼ë¬¸ì— ì „ì²´ ì£¼ë¬¸ ê°€ê²© í•„ë“œë¥¼ ë‘ê³  ì—­ì •ê·œí™” í•œë‹¤.)

# ğŸ’¡ ì£¼ë¬¸ìƒí’ˆ ì—”í‹°í‹°
```java
@Entity
@Table(name = "order_item")
@Getter @Setter
public class OrderItem {

    @Id
    @GeneratedValue
    @Column(name = "order_item_id")
    private Long id;
    
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "item_id")
    private Item item; //ì£¼ë¬¸ ìƒí’ˆ

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "order_id")
    private Order order; //ì£¼ë¬¸

    private int orderPrice;
    private int count;

    //==ìƒì„± ë©”ì„œë“œ==//
    public static OrderItem createOrderItem(Item item, int orderPrice, int count) {
        OrderItem orderItem = new OrderItem();
        orderItem.setItem(item);
        orderItem.setOrderPrice(orderPrice);
        orderItem.setCount(count);

        item.removeStock(count);
        return orderItem;
    }

    //==ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ==//
    public void cancel() {
        getItem().addStock(count); //ì¬ê³ ìˆ˜ëŸ‰ ì›ë³µ
    }

    //==ì¡°íšŒ ë¡œì§==//
    /** ì£¼ë¬¸ìƒí’ˆ ì „ì²´ ê°€ê²© ì¡°íšŒ */
    public int getTotalPrice() {
        return getOrderPrice() * getCount();
    }
}
```

# ğŸ’¡ ì£¼ë¬¸ ë¦¬í¬ì§€í† ë¦¬ ê°œë°œ
```java
@RequiredArgsConstructor
@Repository
public class OrderRepository {

    private final EntityManager em;

    public void save(Order order) {
        em.persist(order);
    }
    public Order findOne(Long id) {
        return em.find(Order.class, id);
    }

//    public List<Order> findAll(OrderSearch orderSearch) {}
}
```
* ì£¼ë¬¸ ë¦¬í¬ì§€í† ë¦¬ì—ëŠ” ì£¼ë¬¸ ì—”í‹°í‹°ë¥¼ ì €ì¥í•˜ê³  ê²€ìƒ‰í•˜ëŠ” ê¸°ëŠ¥ì´ ìˆë‹¤. 
* ë§ˆì§€ë§‰ì˜ findAll(OrderSearch orderSearch) ë©”ì„œë“œëŠ” ì¡°ê¸ˆ ë’¤ì— ìˆëŠ” ì£¼ë¬¸ ê²€ìƒ‰ ê¸°ëŠ¥ì—ì„œ ìì„¸íˆ ì•Œì•„ë³´ì.

# ğŸ’¡ ì£¼ë¬¸ ì„œë¹„ìŠ¤ ê°œë°œ
```java
@Service
@Transactional(readOnly = true)
@RequiredArgsConstructor
public class OrderService {

    private final OrderRepository orderRepository;
    private final MemberRepository memberRepository;
    private final ItemRepository itemRepository;

    /**
     * ì£¼ë¬¸
     */
    @Transactional
    public Long order(Long memberId, Long itemId, int count) {

        //ì—”í‹°í‹° ì¡°íšŒ
        Member member = memberRepository.findOne(memberId);
        Item item = itemRepository.findOne(itemId);

        //ë°°ì†¡ì •ë³´ ìƒì„±
        Delivery delivery = new Delivery();
        delivery.setAddress(member.getAddress());
        delivery.setStatus(DeliveryStatus.READY);

        //ì£¼ë¬¸ìƒí’ˆ ìƒì„±
        OrderItem orderItem = OrderItem.createOrderItem(item, item.getPrice(), count);

        //ì£¼ë¬¸ ìƒì„±
        Order order = Order.createOrder(member, delivery, orderItem);

        //ì£¼ë¬¸ ì €ì¥
        orderRepository.save(order);

        return order.getId();
    }

    /**
     * ì£¼ë¬¸ ì·¨ì†Œ
     */
    @Transactional
    public void cancelOrder(Long orderId) {
    
        //ì£¼ë¬¸ ì—”í‹°í‹° ì¡°íšŒ
        Order order = orderRepository.findOne(orderId);

        //ì£¼ë¬¸ ì·¨ì†Œ
        order.cancel();
    }

    /**
     * ì£¼ë¬¸ ê²€ìƒ‰
     */
    /*public List<Order> findOrders(OrderSearch orderSearch){

    }*/
}
```

> ğŸ“Œ ì°¸ê³   
> ì£¼ë¬¸ ì„œë¹„ìŠ¤ì˜ ì£¼ë¬¸ê³¼ ì£¼ë¬¸ ì·¨ì†Œ ë©”ì„œë“œë¥¼ ë³´ë©´ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ëŒ€ë¶€ë¶„ì´ ì—”í‹°í‹°ì— ìˆë‹¤.   
> ì„œë¹„ìŠ¤ ê³„ì¸µì€ ë‹¨ìˆœíˆ ì—”í‹°í‹°ì— í•„ìš”í•œ ìš”ì²­ì„ ìœ„ì„í•˜ëŠ” ì—­í• ì„ í•œë‹¤.   
> ì´ì²˜ëŸ¼ ì—”í‹°í‹°ê°€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ê°€ì§€ê³  ê°ì²´ ì§€í–¥ì˜ íŠ¹ì„±ì„ ì ê·¹ í™œìš©í•˜ëŠ” ê²ƒì„ ë„ë©”ì¸ ëª¨ë¸ íŒ¨í„´(http://martinfowler.com/eaaCatalog/domainModel.html)ì´ë¼ í•œë‹¤.   
> ë°˜ëŒ€ë¡œ ì—”í‹°í‹°ì—ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ê±°ì˜ ì—†ê³  ì„œë¹„ìŠ¤ ê³„ì¸µì—ì„œ ëŒ€ë¶€ë¶„ì˜ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì²˜ë¦¬í•˜ëŠ” ê²ƒì„ íŠ¸ëœì­ì…˜ ìŠ¤í¬ë¦½íŠ¸ íŒ¨í„´(http://martinfowler.com/eaaCatalog/transactionScript.html)ì´ë¼ í•œë‹¤.
