# ğŸ’¡ ìŠ¤í”„ë§ ë°ì´í„° JPA ë¦¬í¬ì§€í† ë¦¬ë¡œ ë³€ê²½
- ì´ì „ì— ì‘ì„±í–ˆë˜ ìˆœìˆ˜ JPAë¥¼ ì´ìš©í•œ ì½”ë“œë“¤ì„ ìŠ¤í”„ë§ ë°ì´í„° JPAë¡œ ë³€ê²½í•œë‹¤.
```java
public interface MemberRepository extends JpaRepository<Member, Long> {
    List<Member> findByUsername(String username);
}
```
- ì´ë ‡ê²Œë§Œ ì ìš©í•˜ë©´ Querydsl ê¸°ëŠ¥ì¸ íšŒì› searchë¥¼ ì‘ì„±í•  ìˆ˜ ì—†ë‹¤.
- ì‚¬ìš©ì ì •ì˜ ë¦¬í¬ì§€í† ë¦¬ê°€ í•„ìš”í•˜ë‹¤.

# ğŸ’¡ ì‚¬ìš©ì ì •ì˜ ë¦¬í¬ì§€í† ë¦¬
### âœ… ì‚¬ìš©ì ì •ì˜ ë¦¬í¬ì§€í† ë¦¬ ì‚¬ìš©ë²•
1. ì‚¬ìš©ì ì •ì˜ ì¸í„°í˜ì´ìŠ¤ ì‘ì„±
2. ì‚¬ìš©ì ì •ì˜ ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„
3. ìŠ¤í”„ë§ ë°ì´í„° ë¦¬í¬ì§€í† ë¦¬ì— ì‚¬ìš©ì ì •ì˜ ì¸í„°í˜ì´ìŠ¤ ìƒì†

![image](https://github.com/shin-je-woo/TIL/assets/39439576/7e7f0645-50c0-4eb8-9fb5-c851e191820b)

## 1. ì‚¬ìš©ì ì •ì˜ ì¸í„°í˜ì´ìŠ¤ ì‘ì„±
```java
public interface MemberRepositoryCustom {
    List<MemberTeamDto> search(MemberSearchCondition condition);
}
```

## 2. ì‚¬ìš©ì ì •ì˜ ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„
```java
public class MemberRepositoryImpl implements MemberRepositoryCustom {

    private final JPAQueryFactory queryFactory;

    public MemberRepositoryImpl(EntityManager em) {
        this.queryFactory = new JPAQueryFactory(em);
    }

    @Override
    public List<MemberTeamDto> search(MemberSearchCondition condition) {
        return queryFactory
                .select(new QMemberTeamDto(
                        member.id.as("memberId"),
                        member.username,
                        member.age,
                        team.id.as("teamId"),
                        team.name.as("teamName")
                ))
                .from(member)
                .leftJoin(member.team, team)
                .where(
                        usernameEq(condition.getUsername()),
                        teamNameEq(condition.getTeamName()),
                        ageGoe(condition.getAgeGoe()),
                        ageLoe(condition.getAgeLoe())
                )
                .fetch();
    }

    private BooleanExpression usernameEq(String username) {
        return hasText(username) ? member.username.eq(username) : null;
    }

    private BooleanExpression teamNameEq(String teamName) {
        return hasText(teamName) ? team.name.eq(teamName) : null;
    }

    private BooleanExpression ageGoe(Integer ageGoe) {
        return ageGoe != null ? member.age.goe(ageGoe) : null;
    }

    private BooleanExpression ageLoe(Integer ageLoe) {
        return ageLoe != null ? member.age.loe(ageLoe) : null;
    }
}
```

## 3. ìŠ¤í”„ë§ ë°ì´í„° ë¦¬í¬ì§€í† ë¦¬ì— ì‚¬ìš©ì ì •ì˜ ì¸í„°í˜ì´ìŠ¤ ìƒì†
```java
public interface MemberRepository extends JpaRepository<Member, Long>, MemberRepositoryCustom {
    List<Member> findByUsername(String username);
}
```

# ğŸ’¡ ìŠ¤í”„ë§ ë°ì´í„° í˜ì´ì§• í™œìš© - Querydsl í˜ì´ì§• ì—°ë™
- ìŠ¤í”„ë§ ë°ì´í„°ì˜ Page, Pageableì„ í™œìš©í•´ë³´ì.
- ì „ì²´ ì¹´ìš´íŠ¸ë¥¼ í•œë²ˆì— ì¡°íšŒí•˜ëŠ” ë‹¨ìˆœí•œ ë°©ë²• (fetchResults ë©”ì„œë“œê°€ deprecated ë˜ì–´ì„œ ë‹¤ë£¨ì§€ ì•Šê² ë‹¤.)
- ë°ì´í„° ë‚´ìš©ê³¼ ì „ì²´ ì¹´ìš´íŠ¸ë¥¼ ë³„ë„ë¡œ ì¡°íšŒí•˜ëŠ” ë°©ë²•
  - ì „ì²´ ì¹´ìš´íŠ¸ë¥¼ ì¡°íšŒí•  ë•Œ ì¡°ì¸ ì¿¼ë¦¬ë¥¼ ì¤„ì¼ ìˆ˜ ìˆë‹¤ë©´ ìƒë‹¹í•œ íš¨ê³¼ê°€ ìˆë‹¤.
  - ì½”ë“œë¥¼ ë¦¬í™í† ë§í•´ì„œ ë‚´ìš© ì¿¼ë¦¬ê³¼ ì „ì²´ ì¹´ìš´íŠ¸ ì¿¼ë¦¬ë¥¼ ì½ê¸° ì¢‹ê²Œ ë¶„ë¦¬í•˜ë©´ ì¢‹ë‹¤.
- (ì˜ˆì œ ì½”ë“œëŠ” ì»¤ìŠ¤í…€ ë¦¬í¬ì§€í† ë¦¬ ì¸í„°í˜ì´ìŠ¤ëŠ” ìƒëµí•˜ê³ , êµ¬ì²´ í´ë˜ìŠ¤ ë‚´ìš©ë§Œ ë‹´ëŠ”ë‹¤.)

```java
@Override
public Page<MemberTeamDto> searchPageComplex(MemberSearchCondition condition, Pageable pageable) {
    // ë‚´ìš© ì¿¼ë¦¬
    List<MemberTeamDto> content = queryFactory
            .select(new QMemberTeamDto(
                    member.id.as("memberId"),
                    member.username,
                    member.age,
                    team.id.as("teamId"),
                    team.name.as("teamName")
            ))
            .from(member)
            .leftJoin(member.team, team)
            .where(
                    usernameEq(condition.getUsername()),
                    teamNameEq(condition.getTeamName()),
                    ageGoe(condition.getAgeGoe()),
                    ageLoe(condition.getAgeLoe())
            )
            .offset(pageable.getOffset())
            .limit(pageable.getPageSize())
            .fetch();

    // ì¹´ìš´íŠ¸ ì¿¼ë¦¬
    JPAQuery<Long> countQuery = queryFactory
            .select(member.count())
            .from(member)
            .leftJoin(member.team, team)
            .where(
                    usernameEq(condition.getUsername()),
                    teamNameEq(condition.getTeamName()),
                    ageGoe(condition.getAgeGoe()),
                    ageLoe(condition.getAgeLoe())
            );

    return PageableExecutionUtils.getPage(content, pageable, countQuery::fetchOne);
}
```
- `PageableExecutionUtils.getPage(content, pageable, countQuery::fetchCount)` â†’ count ì¿¼ë¦¬ê°€ ìƒëµ ê°€ëŠ¥í•œ ê²½ìš° ìƒëµí•´ì„œ ì²˜ë¦¬
  - í˜ì´ì§€ ì‹œì‘ì´ë©´ì„œ ì»¨í…ì¸  ì‚¬ì´ì¦ˆê°€ í˜ì´ì§€ ì‚¬ì´ì¦ˆë³´ë‹¤ ì‘ì„ ë•Œ
  - ë§ˆì§€ë§‰ í˜ì´ì§€ ì¼ ë•Œ (offset + ì»¨í…ì¸  ì‚¬ì´ì¦ˆë¥¼ ë”í•´ì„œ ì „ì²´ ì‚¬ì´ì¦ˆ êµ¬í•¨, ë” ì •í™•íˆëŠ” ë§ˆì§€ë§‰ í˜ì´ì§€ ì´ë©´ì„œ ì»¨í…ì¸  ì‚¬ì´ì¦ˆê°€ í˜ì´ì§€ ì‚¬ì´ì¦ˆë³´ë‹¤ ì‘ì„ ë•Œ)
 
