# ğŸ’¡ ë°˜í™˜ íƒ€ì…
ìŠ¤í”„ë§ ë°ì´í„° JPAëŠ” ìœ ì—°í•œ ë°˜í™˜ íƒ€ì… ì§€ì›
```java
List<Member> findByUsername(String name); //ì»¬ë ‰ì…˜
Member findByUsername(String name); //ë‹¨ê±´
Optional<Member> findByUsername(String name); //ë‹¨ê±´ Optional
```
* ì»¬ë ‰ì…˜
  * ê²°ê³¼ ì—†ìŒ: ë¹ˆ ì»¬ë ‰ì…˜ ë°˜í™˜
* ë‹¨ê±´ ì¡°íšŒ
  * ê²°ê³¼ ì—†ìŒ: null ë˜ëŠ” Optional.empty() ë°˜í™˜
  * ê²°ê³¼ê°€ 2ê±´ ì´ìƒ: javax.persistence.NonUniqueResultException ì˜ˆì™¸ ë°œìƒ

> ğŸ“Œ ì°¸ê³    
> ë‹¨ê±´ìœ¼ë¡œ ì§€ì •í•œ ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ë©´ ìŠ¤í”„ë§ ë°ì´í„° JPAëŠ” ë‚´ë¶€ì—ì„œ JPQLì˜ `Query.getSingleResult()` ë©”ì„œë“œë¥¼ í˜¸ì¶œí•œë‹¤.  
> ì´ ë©”ì„œë“œë¥¼ í˜¸ì¶œí–ˆì„ ë•Œ ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìœ¼ë©´ `javax.persistence.NoResultException` ì˜ˆì™¸ê°€ ë°œìƒí•˜ëŠ”ë° ê°œë°œì ì…ì¥ì—ì„œ ë‹¤ë£¨ê¸°ê°€ ìƒë‹¹íˆ ë¶ˆí¸í•˜ë‹¤.   
> ìŠ¤í”„ë§ ë°ì´í„° JPAëŠ” ë‹¨ê±´ì„ ì¡°íšŒí•  ë•Œ ì´ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ ì˜ˆì™¸ë¥¼ ë¬´ì‹œí•˜ê³  ëŒ€ì‹ ì— null ì„ ë°˜í™˜í•œë‹¤.

# ğŸ’¡ í˜ì´ì§•ê³¼ ì •ë ¬
* JPAì—ì„œ í˜ì´ì§•ì„ ì–´ë–»ê²Œ í•  ê²ƒì¸ê°€?
* ë‹¤ìŒ ì¡°ê±´ìœ¼ë¡œ í˜ì´ì§•ê³¼ ì •ë ¬ì„ ì‚¬ìš©í•˜ëŠ” ì˜ˆì œ ì½”ë“œë¥¼ ë³´ì.
  * ê²€ìƒ‰ ì¡°ê±´: ë‚˜ì´ê°€ 10ì‚´
  * ì •ë ¬ ì¡°ê±´: ì´ë¦„ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ
  * í˜ì´ì§• ì¡°ê±´: ì²« ë²ˆì§¸ í˜ì´ì§€, í˜ì´ì§€ë‹¹ ë³´ì—¬ì¤„ ë°ì´í„°ëŠ” 3ê±´
 
## ìˆœìˆ˜ JPA í˜ì´ì§•ê³¼ ì •ë ¬
â–¶ï¸ Repository
```java
public List<Member> findByPage(int age, int offset, int limit) {
    return em.createQuery("select m from Member m where m.age = :age order by m.username desc", Member.class)
            .setParameter("age", age)
            .setFirstResult(offset)
            .setMaxResults(limit)
            .getResultList();
}
```
â–¶ï¸ TestCode
```java
@Test
public void paging() {
    //given
    memberJpaRepository.save(new Member("member1", 10));
    memberJpaRepository.save(new Member("member2", 10));
    memberJpaRepository.save(new Member("member3", 10));
    memberJpaRepository.save(new Member("member4", 10));
    memberJpaRepository.save(new Member("member5", 10));

    int age = 10;
    int offset = 0;
    int limit = 3;

    //when
    List<Member> members = memberJpaRepository.findByPage(age, offset, limit);
    long totalCount = memberJpaRepository.totalCount(age);

    //then
    assertThat(members.size()).isEqualTo(3);
    assertThat(totalCount).isEqualTo(5);
}
```

## ìŠ¤í”„ë§ ë°ì´í„° JPA í˜ì´ì§•ê³¼ ì •ë ¬
* ìŠ¤í”„ë§ ë°ì´í„° í”„ë¡œì íŠ¸ì—ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì´ í˜ì´ì§•ê³¼ ì •ë ¬ì„ ê³µí†µí™” í•´ë‘ì—ˆë‹¤.

### í˜ì´ì§•ê³¼ ì •ë ¬ íŒŒë¼ë¯¸í„°
* `org.springframework.data.domain.Sort` : ì •ë ¬ ê¸°ëŠ¥
* `org.springframework.data.domain.Pageable` : í˜ì´ì§• ê¸°ëŠ¥ (ë‚´ë¶€ì— Sort í¬í•¨)

### íŠ¹ë³„í•œ ë°˜í™˜ íƒ€ì…
* `org.springframework.data.domain.Page` : ì¶”ê°€ count ì¿¼ë¦¬ ê²°ê³¼ë¥¼ í¬í•¨í•˜ëŠ” í˜ì´ì§•
* `org.springframework.data.domain.Slice` : ì¶”ê°€ count ì¿¼ë¦¬ ì—†ì´ ë‹¤ìŒ í˜ì´ì§€ë§Œ í™•ì¸ ê°€ëŠ¥ (ë‚´ë¶€ì ìœ¼ë¡œ limit + 1ì¡°íšŒ)
* List (ìë°” ì»¬ë ‰ì…˜): ì¶”ê°€ count ì¿¼ë¦¬ ì—†ì´ ê²°ê³¼ë§Œ ë°˜í™˜

â–¶ï¸ í˜ì´ì§•ê³¼ ì •ë ¬ ì‚¬ìš© ì˜ˆì œ
```java
Page<Member> findByUsername(String name, Pageable pageable); //count ì¿¼ë¦¬ ì‚¬ìš© 
Slice<Member> findByUsername(String name, Pageable pageable); //count ì¿¼ë¦¬ ì‚¬ìš© ì•ˆ í•¨
List<Member> findByUsername(String name, Pageable pageable); //count ì¿¼ë¦¬ ì‚¬ìš© ì•ˆ í•¨
List<Member> findByUsername(String name, Sort sort);
```

â–¶ï¸ Repository
```java
public interface MemberRepository extends Repository<Member, Long> {
    Page<Member> findByAge(int age, Pageable pageable);
}
```
â–¶ï¸ TestCode
```java
@Test
public void paging() {
    //given
    memberRepository.save(new Member("member1", 10));
    memberRepository.save(new Member("member2", 10));
    memberRepository.save(new Member("member3", 10));
    memberRepository.save(new Member("member4", 10));
    memberRepository.save(new Member("member5", 10));

    //when
    PageRequest pageRequest = PageRequest.of(0, 3, Sort.by(Sort.Direction.DESC, "username"));
    Page<Member> page = memberRepository.findByAge(10, pageRequest);

    //then
    List<Member> content = page.getContent();

    assertThat(content.size()).isEqualTo(3); //ì¡°íšŒëœ ë°ì´í„° ìˆ˜
    assertThat(page.getTotalElements()).isEqualTo(5); //ì „ì²´ ë°ì´í„° ìˆ˜
    assertThat(page.getNumber()).isEqualTo(0); //í˜ì´ì§€ ë²ˆí˜¸
    assertThat(page.getTotalPages()).isEqualTo(2); //ì „ì²´ í˜ì´ì§€ ë²ˆí˜¸
    assertThat(page.isFirst()).isTrue(); //ì²«ë²ˆì§¸ í•­ëª©ì¸ê°€?
    assertThat(page.hasNext()).isTrue(); //ë‹¤ìŒ í˜ì´ì§€ê°€ ìˆëŠ”ê°€?
}
```
* ë‘ ë²ˆì§¸ íŒŒë¼ë¯¸í„°ë¡œ ë°›ì€ `Pageable` ì€ ì¸í„°í˜ì´ìŠ¤ë‹¤. 
* ë”°ë¼ì„œ ì‹¤ì œ ì‚¬ìš©í•  ë•ŒëŠ” í•´ë‹¹ ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•œ `org.springframework.data.domain.PageRequest` ê°ì²´ë¥¼ ì‚¬ìš©í•œë‹¤.
* `PageRequest` ìƒì„±ìì˜ ì²« ë²ˆì§¸ íŒŒë¼ë¯¸í„°ì—ëŠ” í˜„ì¬ í˜ì´ì§€ë¥¼, ë‘ ë²ˆì§¸ íŒŒë¼ë¯¸í„°ì—ëŠ” ì¡°íšŒí•  ë°ì´í„° ìˆ˜ë¥¼ ì…ë ¥í•œë‹¤. 
* ì—¬ê¸°ì— ì¶”ê°€ë¡œ ì •ë ¬ ì •ë³´ë„ íŒŒë¼ë¯¸í„°ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. ì°¸ê³ ë¡œ í˜ì´ì§€ëŠ” 0ë¶€í„° ì‹œì‘í•œë‹¤.

### ì°¸ê³ ) count ì¿¼ë¦¬ë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ë¶„ë¦¬í•  ìˆ˜ ìˆìŒ
â†’ ë³µì¡í•œ ì¿¼ë¦¬ì—ì„œ countì¿¼ë¦¬ëŠ” êµ³ì´ joinì„ í•  í•„ìš”ê°€ ì—†ê¸° ë•Œë¬¸ì— ë³µì¡í•œ sqlì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš°ì—ëŠ” ë¶„ë¦¬í•´ì„œ ì‚¬ìš©í•œë‹¤. 
```java
@Query(value = "select m from Member m",
       countQuery = "select count(m) from Member m")
Page<Member> findByAge(int age, Pageable pageable);
```

### í˜ì´ì§€ë¥¼ ìœ ì§€í•˜ë©´ì„œ ì—”í‹°í‹°ë¥¼ DTOë¡œ ë³€í™˜í•˜ê¸°
â†’ ì‹¤ë¬´ì—ì„œ ì—”í‹°í‹°ë¥¼ ê·¸ëŒ€ë¡œ ë°˜í™˜í•˜ëŠ” ê²ƒì€ ìœ„í—˜í•˜ë‹¤. ê·¸ë ‡ê¸° ë•Œë¬¸ì— ì—”í‹°í‹°ë¥¼ DTOë¡œ ë³€í™˜í•˜ì—¬ ë°˜í™˜í•´ì•¼ í•œë‹¤.
```java
Page<Member> page = memberRepository.findByAge(age, pageRequest);
Page<MemberDTO> dtoPage = page.map(m -> new MemberDTO(m.getId(), m.getUsername(), null));
```
