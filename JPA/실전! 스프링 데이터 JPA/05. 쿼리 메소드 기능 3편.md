# ğŸ’¡ ë²Œí¬ì„± ìˆ˜ì • ì¿¼ë¦¬
â–¶ï¸ ìˆœìˆ˜JPA
```java
public int bulkAgePlus(int age) {
    return em.createQuery("update Member m set m.age = m.age + 1 where m.age >= :age")
            .setParameter("age", age)
            .executeUpdate();
}
```

â–¶ï¸ ìŠ¤í”„ë§ ë°ì´í„° JPA
```java
@Modifying(clearAutomatically = true)
@Query("update Member m set m.age = m.age+1 where m.age >= :age")
int bulkAgePlus(@Param("age") int age);
```

â–¶ï¸ TestCode
```java
@Test
public void bulkUpdate() {
    //given
    memberRepository.save(new Member("member1", 10));
    memberRepository.save(new Member("member2", 19));
    memberRepository.save(new Member("member3", 20));
    memberRepository.save(new Member("member4", 21));
    memberRepository.save(new Member("member5", 40));

    //when
    int resultCount = memberRepository.bulkAgePlus(20);

    //then
    assertThat(resultCount).isEqualTo(3);
}
```
* ë²Œí¬ì„± ìˆ˜ì •, ì‚­ì œ ì¿¼ë¦¬ëŠ” `@Modifying` ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©
  * ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´ `org.hibernate.hql.internal.QueryExecutionRequestException: Not supported for DML operations` ì˜ˆì™¸ê°€ ë°œìƒí•œë‹¤.
* â— ë²Œí¬ì„± ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ê³  ë‚˜ì„œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™”: @Modifying(clearAutomatically = true)
  * ì´ ì˜µì…˜ ì—†ì´ íšŒì›ì„ ë‹¤ì‹œ ì¡°íšŒí•˜ë©´ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ê³¼ê±° ê°’ì´ ìºì‹±ë˜ì–´ ìˆê¸° ë•Œë¬¸ì—, ì •í•©ì„±ì´ ê¹¨ì§€ê²Œ ëœë‹¤.
  * ê°•ì œë¡œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì´ˆê¸°í™” í•´ì£¼ë˜ê°€ í•´ë‹¹ ì–´ë…¸í…Œì´ì…˜ì„ ê¼­! ì„¤ì •í•´ì£¼ë„ë¡ í•˜ì.

> ğŸ“Œ ì°¸ê³   
>  ë²Œí¬ ì—°ì‚°ì€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ë¬´ì‹œí•˜ê³  ì‹¤í–‰í•˜ê¸° ë•Œë¬¸ì—, ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ìˆëŠ” ì—”í‹°í‹°ì˜ ìƒíƒœì™€ DBì— ìˆëŠ” ì—”í‹°í‹° ìƒíƒœê°€ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆë‹¤.  
> â†’ ê¶Œì¥í•˜ëŠ” ë°©ì•ˆ  
> 1. ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì—”í‹°í‹°ê°€ ì—†ëŠ” ìƒíƒœì—ì„œ ë²Œí¬ ì—°ì‚°ì„ ë¨¼ì € ì‹¤í–‰í•œë‹¤.
> 2. ë¶€ë“ì´í•˜ê²Œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì—”í‹°í‹°ê°€ ìˆìœ¼ë©´ ë²Œí¬ ì—°ì‚° ì§í›„ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì´ˆê¸°í™” í•œë‹¤.

# ğŸ’¡ @EntityGraph
* ì—°ê´€ëœ ì—”í‹°í‹°ë“¤ì„ SQL í•œë²ˆì— ì¡°íšŒí•˜ëŠ” ë°©ë²•
* fetch joinì˜ ì–´ë…¸í…Œì´ì…˜ ë²„ì „ì´ë‹¤. (LEFT OUTER JOIN ìˆ˜í–‰)
* ë‹¤ìŒ ì¼€ì´ìŠ¤ë¥¼ ë³´ì.
* member â†” teamì€ ì§€ì—°ë¡œë”© ê´€ê³„ì´ë‹¤. ë”°ë¼ì„œ ë‹¤ìŒê³¼ ê°™ì´ teamì˜ ë°ì´í„°ë¥¼ ì¡°íšŒí•  ë•Œ ë§ˆë‹¤ ì¿¼ë¦¬ê°€ ì‹¤í–‰ëœë‹¤. (N+1 ë¬¸ì œ ë°œìƒ)
```java
@Test
void findMemberLazy() throws Exception {
    //given
    //member1 -> teamA
    //member2 -> teamB
    Team teamA = new Team("teamA");
    Team teamB = new Team("teamB");
    teamRepository.save(teamA);
    teamRepository.save(teamB);
    memberRepository.save(new Member("member1", 10, teamA));
    memberRepository.save(new Member("member2", 20, teamB));

    em.flush();
    em.clear();

    //when
    List<Member> members = memberRepository.findAll();

    //then
    for (Member member : members) {
        member.getTeam().getName(); // ì§€ì—°ë¡œë”© ë˜ë©´ì„œ N + 1 ë¬¸ì œ ë°œìƒ!
    }
}
```
* ì—°ê´€ëœ ì—”í‹°í‹°ë¥¼ í•œë²ˆì— ì¡°íšŒí•˜ë ¤ë©´ í˜ì¹˜ ì¡°ì¸ì´ í•„ìš”í•˜ë‹¤.

â–¶ï¸ JPQL í˜ì¹˜ ì¡°ì¸
```java
@Query("select m from Member m left join fetch m.team")
List<Member> findMemberFetchJoin();
```
* ìŠ¤í”„ë§ ë°ì´í„° JPAëŠ” JPAê°€ ì œê³µí•˜ëŠ” ì—”í‹°í‹° ê·¸ë˜í”„ ê¸°ëŠ¥ì„ í¸ë¦¬í•˜ê²Œ ì‚¬ìš©í•˜ê²Œ ë„ì™€ì¤€ë‹¤.
* ì´ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë©´ JPQL ì—†ì´ í˜ì¹˜ ì¡°ì¸ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. (JPQL + ì—”í‹°í‹° ê·¸ë˜í”„ë„ ê°€ëŠ¥)

â–¶ï¸ EntityGraph
```java
//ê³µí†µ ë©”ì„œë“œ ì˜¤ë²„ë¼ì´ë“œ
@Override
@EntityGraph(attributePaths = {"team"})
List<Member> findAll();

//JPQL + ì—”í‹°í‹° ê·¸ë˜í”„ 
@EntityGraph(attributePaths = {"team"})
@Query("select m from Member m")
List<Member> findMemberEntityGraph();

//ë©”ì„œë“œ ì´ë¦„ìœ¼ë¡œ ì¿¼ë¦¬ì—ì„œ íŠ¹íˆ í¸ë¦¬í•˜ë‹¤.
@EntityGraph(attributePaths = {"team"})
List<Member> findByUsername(@Param("username") String username);
```

# ğŸ’¡ JPA Hint& Lock
## 1. QueryHint
* JPA ì¿¼ë¦¬ íŒíŠ¸(SQL íŒíŠ¸ê°€ ì•„ë‹ˆë¼ JPA êµ¬í˜„ì²´ì—ê²Œ ì œê³µí•˜ëŠ” íŒíŠ¸)

â–¶ï¸ Repository
```java
@QueryHints(value = @QueryHint(name = "org.hibernate.readOnly", value = "true"))
Member findReadOnlyByUsername(String username);
```

â–¶ï¸ TestCode
```java
@Test
public void queryHint() throws Exception {
    //given
    memberRepository.save(new Member("member1", 10));
    em.flush();
    em.clear();
    
    //when
    Member member = memberRepository.findReadOnlyByUsername("member1");
    member.setUsername("member2");
    
    em.flush(); //Update Query ì‹¤í–‰X
}
```
* ì½ê¸° ì „ìš© hintë¥¼ ì ìš©í•˜ì—¬ ì¡°íšŒí–ˆê¸° ë•Œë¬¸ì— ë³€ê²½ê°ì§€(update query)ê°€ ìˆ˜í–‰ë˜ì§€ ì•ŠëŠ”ë‹¤.
* ì˜ˆì œ ì´ì™¸ì—ë„ ë‹¤ì–‘í•œ hintê°€ ìˆìœ¼ë‹ˆ ê³µì‹ ì‚¬ì´íŠ¸ë¥¼ ì°¸ê³ í•˜ì.

## 2. Lock
```java
@Lock(LockModeType.PESSIMISTIC_WRITE)
List<Member> findLockByUsername(String username);
```
* `org.springframework.data.jpa.repository.Lock` ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©
