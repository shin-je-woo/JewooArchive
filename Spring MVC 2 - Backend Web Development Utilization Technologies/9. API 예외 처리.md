# ğŸ’¡ API ì˜ˆì™¸ ì²˜ë¦¬ - ìŠ¤í”„ë§ ë¶€íŠ¸ ê¸°ë³¸ ì˜¤ë¥˜ ì²˜ë¦¬
API ì˜ˆì™¸ ì²˜ë¦¬ë„ ìŠ¤í”„ë§ ë¶€íŠ¸ê°€ ì œê³µí•˜ëŠ” ê¸°ë³¸ ì˜¤ë¥˜ ë°©ì‹ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

â–¶ï¸ BasicErrorController
```java
@Controller
@RequestMapping("${server.error.path:${error.path:/error}}")
public class BasicErrorController extends AbstractErrorController {
    @RequestMapping(produces = MediaType.TEXT_HTML_VALUE)
    public ModelAndView errorHtml(HttpServletRequest request, HttpServletResponse response) {}

    @RequestMapping
    public ResponseEntity<Map<String, Object>> error(HttpServletRequest request) {}
}
```
/error ë™ì¼í•œ ê²½ë¡œë¥¼ ì²˜ë¦¬í•˜ëŠ” errorHtml() , error() ë‘ ë©”ì„œë“œë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
* `errorHtml()` : produces = MediaType.TEXT_HTML_VALUE : í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ì˜ Accept í—¤ë” ê°’ì´ text/html ì¸ ê²½ìš°ì—ëŠ” errorHtml() ì„ í˜¸ì¶œí•´ì„œ viewë¥¼ ì œê³µí•œë‹¤.
* `error()` : ê·¸ ì™¸ ê²½ìš°ì— í˜¸ì¶œë˜ê³  ResponseEntity ë¡œ HTTP Bodyì— JSON ë°ì´í„°ë¥¼ ë°˜í™˜í•œë‹¤.

* ìŠ¤í”„ë§ ë¶€íŠ¸ê°€ ì œê³µí•˜ëŠ” BasicErrorController ëŠ” HTML í˜ì´ì§€ë¥¼ ì œê³µí•˜ëŠ” ê²½ìš°ì—ëŠ” ë§¤ìš° í¸ë¦¬í•˜ë‹¤. 4xx, 5xx ë“±ë“± ëª¨ë‘ ì˜ ì²˜ë¦¬í•´ì¤€ë‹¤. 
* ê·¸ëŸ°ë° API ì˜¤ë¥˜ ì²˜ë¦¬ëŠ” ë‹¤ë¥¸ ì°¨ì›ì˜ ì´ì•¼ê¸°ì´ë‹¤. 
* API ë§ˆë‹¤, ê°ê°ì˜ ì»¨íŠ¸ë¡¤ëŸ¬ë‚˜ ì˜ˆì™¸ë§ˆë‹¤ ì„œë¡œ ë‹¤ë¥¸ ì‘ë‹µ ê²°ê³¼ë¥¼ ì¶œë ¥í•´ì•¼ í•  ìˆ˜ë„ ìˆë‹¤.
* ì˜ˆë¥¼ ë“¤ì–´ì„œ íšŒì›ê³¼ ê´€ë ¨ëœ APIì—ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•  ë•Œ ì‘ë‹µê³¼, ìƒí’ˆê³¼ ê´€ë ¨ëœ APIì—ì„œ ë°œìƒí•˜ëŠ” ì˜ˆì™¸ì— ë”°ë¼ ê·¸ ê²°ê³¼ê°€ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆë‹¤. 

ğŸ“Œ ì •ë¦¬
>  `BasicErrorController`ë¥¼ ì´ìš©í•œ ì˜ˆì™¸ì²˜ë¦¬ëŠ” HTML í™”ë©´ì„ ì²˜ë¦¬í•  ë•Œ ì‚¬ìš©í•˜ê³ ,  
>  API ì˜¤ë¥˜ ì²˜ë¦¬ëŠ” ë’¤ì—ì„œ ì„¤ëª…í•  `@ExceptionHandler` ë¥¼ ì‚¬ìš©í•˜ì.

# ğŸ’¡ API ì˜ˆì™¸ ì²˜ë¦¬ - HandlerExceptionResolver ì‹œì‘
ìŠ¤í”„ë§MVCëŠ” ì»¨íŠ¸ë¡¤ëŸ¬(í•¸ë“¤ëŸ¬) ë°–ìœ¼ë¡œ ì˜ˆì™¸ê°€ ë˜ì ¸ì§„ ê²½ìš° ì˜ˆì™¸ë¥¼ í•´ê²°í•˜ê³ , ë™ì‘ì„ ìƒˆë¡œ ì •ì˜í•  ìˆ˜ ìˆë„ë¡ HandlerExceptionResolverë¥¼ ì œê³µí•œë‹¤.

âœ… ExceptionResolver ì ìš© ì „

![image](https://user-images.githubusercontent.com/39439576/230246516-c4d9d784-c632-434c-9767-d58b849e53ce.png)

âœ… ExceptionResolver ì ìš© í›„

![image](https://user-images.githubusercontent.com/39439576/230248173-97f7a5af-a146-4ef7-a6b1-a1a0b1be6e78.png)

â–¶ï¸ HandlerExceptionResolver - ì¸í„°í˜ì´ìŠ¤
```java
public interface HandlerExceptionResolver {

    ModelAndView resolveException(
    HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex);
}
```
* handler : í•¸ë“¤ëŸ¬(ì»¨íŠ¸ë¡¤ëŸ¬) ì •ë³´
* Exception ex : í•¸ë“¤ëŸ¬(ì»¨íŠ¸ë¡¤ëŸ¬)ì—ì„œ ë°œìƒí•œ ë°œìƒí•œ ì˜ˆì™¸

â–¶ï¸ MyHandlerExceptionResolver
```java
@Slf4j
public class MyHandlerExceptionResolver implements HandlerExceptionResolver {

    @Override
    public ModelAndView resolveException(HttpServletRequest request,
                                         HttpServletResponse response, Object handler, Exception ex) {
        try {
            if (ex instanceof IllegalArgumentException) {
                log.info("IllegalArgumentException resolver to 400");
                response.sendError(HttpServletResponse.SC_BAD_REQUEST, ex.getMessage());
                return new ModelAndView();
            }
        } catch (IOException e) {
            log.error("resolver ex", e);
        }
        return null;
    }
}
```
* ExceptionResolverëŠ” ModelAndViewë¥¼ ë°˜í™˜í•˜ëŠ”ë°, (try~catchë¥¼ í•˜ë“¯ì´) Exceptionì„ ì²˜ë¦¬í•´ì„œ ì •ìƒ íë¦„ì²˜ëŸ¼ ë³€ê²½í•˜ëŠ” ê²ƒì´ ëª©ì ì´ê¸° ë•Œë¬¸ì´ë‹¤.
* ì—¬ê¸°ì„œëŠ” IllegalArgumentExceptionì´ ë°œìƒí•˜ë©´ responsesendError(400)ì„ í˜¸ì¶œí•´ì„œ HTTP ìƒíƒœ ì½”ë“œë¥¼ 400ìœ¼ë¡œ ì§€ì •í•˜ê³  ë¹ˆ ModelAndViewë¥¼ ë°˜í™˜í•œë‹¤.

âœ… ë°˜í™˜ ê°’ì— ë”°ë¥¸ DispatcherServletì˜ ë™ì‘ ë°©ì‹
* ë¹ˆ ModelAndView: ë·°ë¥¼ ë Œë”ë§ í•˜ì§€ ì•Šê³ , ì •ìƒ íë¦„ìœ¼ë¡œ ì„œë¸”ë¦¿ì´ ë¦¬í„´ëœë‹¤.
* ModelAndView ì§€ì •: ë·°ë¥¼ ë Œë”ë§ í•œë‹¤.
* null: ë‹¤ìŒ ExceptionResolver ë¥¼ ì°¾ì•„ì„œ ì‹¤í–‰í•œë‹¤. ë§Œì•½ ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” ExceptionResolver ê°€ ì—†ìœ¼ë©´ ì˜ˆì™¸ ì²˜ë¦¬ê°€ ì•ˆë˜ê³ , ê¸°ì¡´ì— ë°œìƒí•œ ì˜ˆì™¸ë¥¼ ì„œë¸”ë¦¿ ë°–ìœ¼ë¡œ ë˜ì§„ë‹¤.

âœ… ExceptionResolver í™œìš©
* ì˜ˆì™¸ ìƒíƒœ ì½”ë“œ ë³€í™˜
  * ì˜ˆì™¸ë¥¼ response.sendError(xxx) í˜¸ì¶œë¡œ ë³€ê²½í•´ì„œ ì„œë¸”ë¦¿ì—ì„œ ìƒíƒœ ì½”ë“œì— ë”°ë¥¸ ì˜¤ë¥˜ë¥¼ ì²˜ë¦¬í•˜ë„ë¡ ìœ„ì„
  * ì´í›„ WASëŠ” ì„œë¸”ë¦¿ ì˜¤ë¥˜ í˜ì´ì§€ë¥¼ ì°¾ì•„ì„œ ë‚´ë¶€ í˜¸ì¶œ. ì˜ˆë¥¼ ë“¤ì–´ì„œ ìŠ¤í”„ë§ ë¶€íŠ¸ê°€ ê¸°ë³¸ìœ¼ë¡œ ì„¤ì •í•œ /error ê°€ í˜¸ì¶œë¨
* ë·° í…œí”Œë¦¿ ì²˜ë¦¬
  * ModelAndView ì— ê°’ì„ ì±„ì›Œì„œ ì˜ˆì™¸ì— ë”°ë¥¸ ìƒˆë¡œìš´ ì˜¤ë¥˜ í™”ë©´ ë·° ë Œë”ë§ í•´ì„œ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì œê³µ
* API ì‘ë‹µ ì²˜ë¦¬
  * HTTP ì‘ë‹µ ë°”ë””ì— ì§ì ‘ ë°ì´í„°ë¥¼ ë„£ì–´ì£¼ëŠ” ê²ƒë„ ê°€ëŠ¥í•˜ë©°, ì—¬ê¸°ì— JSON ìœ¼ë¡œ ì‘ë‹µí•˜ë©´ API ì‘ë‹µ ì²˜ë¦¬ë¥¼ í•  ìˆ˜ ìˆë‹¤.

# ğŸ’¡ API ì˜ˆì™¸ ì²˜ë¦¬ - HandlerExceptionResolver í™œìš©
#### ì˜ˆì™¸ë¥¼ ì—¬ê¸°ì„œ ë§ˆë¬´ë¦¬í•˜ê¸°
* ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ WASê¹Œì§€ ì˜ˆì™¸ê°€ ë˜ì ¸ì§€ê³ , WASì—ì„œ ì˜¤ë¥˜ í˜ì´ì§€ ì •ë³´ë¥¼ ì°¾ì•„ì„œ ë‹¤ì‹œ /error ë¥¼ í˜¸ì¶œí•˜ëŠ” ê³¼ì •ì€ ë„ˆë¬´ ë³µì¡í•˜ë‹¤.
* `ExceptionResolver` ë¥¼ í™œìš©í•˜ë©´ ì˜ˆì™¸ê°€ ë°œìƒí–ˆì„ ë•Œ ì´ëŸ° ë³µì¡í•œ ê³¼ì • ì—†ì´ ì—¬ê¸°ì—ì„œ ë¬¸ì œë¥¼ ê¹”ë”í•˜ê²Œ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤.

â–¶ï¸ ApiExceptionController - ì˜ˆì™¸ ì¶”ê°€
```java
@Slf4j
@RestController
public class ApiExceptionController {
    @GetMapping("/api/members/{id}")
    public MemberDto getMember(@PathVariable("id") String id) {
        
        if (id.equals("user-ex")) {
            throw new UserException("ì‚¬ìš©ì ì˜¤ë¥˜");
        }
        return new MemberDto(id, "hello " + id);
    }

    @Data
    @AllArgsConstructor
    static class MemberDto {
        private String memberId;
        private String name;
    }
}
```

â–¶ï¸ UserHandlerExceptionResolver - ì˜ˆì™¸ ì²˜ë¦¬
```java
@Slf4j
public class UserHandlerExceptionResolver implements HandlerExceptionResolver {
    private final ObjectMapper objectMapper = new ObjectMapper();

    @Override
    public ModelAndView resolveException(HttpServletRequest request,
                                         HttpServletResponse response, Object handler, Exception ex) {
        try {
            if (ex instanceof UserException) {
                log.info("UserException resolver to 400");
                String acceptHeader = request.getHeader("accept");
                response.setStatus(HttpServletResponse.SC_BAD_REQUEST);
                if ("application/json".equals(acceptHeader)) {
                    Map<String, Object> errorResult = new HashMap<>();
                    errorResult.put("ex", ex.getClass());
                    errorResult.put("message", ex.getMessage());
                    
                    String result = objectMapper.writeValueAsString(errorResult);
                    response.setContentType("application/json");
                    response.setCharacterEncoding("utf-8");
                    response.getWriter().write(result);
                    return new ModelAndView();
                } else {
                    //TEXT/HTML
                    return new ModelAndView("error/500");
                }
            }
        } catch (IOException e) {
            log.error("resolver ex", e);
        }
        return null;
    }
}
```

* HTTP ìš”ì²­ í•´ë”ì˜ ACCEPT ê°’ì´ application/json ì´ë©´ JSONìœ¼ë¡œ ì˜¤ë¥˜ë¥¼ ë‚´ë ¤ì¤€ë‹¤.
* ê·¸ ì™¸ ê²½ìš°ì—ëŠ” error/500ì— ìˆëŠ” HTML ì˜¤ë¥˜ í˜ì´ì§€ë¥¼ ë³´ì—¬ì¤€ë‹¤.

â–¶ï¸ WebConfigì— UserHandlerExceptionResolver ì„¤ì • ì¶”ê°€
```java
@Configuration
public class WebConfig implements WebMvcConfigurer {

    @Override
    public void extendHandlerExceptionResolvers(List<HandlerExceptionResolver> resolvers) {
        resolvers.add(new MyHandlerExceptionResolver());
        resolvers.add(new UserHandlerExceptionResolver());
    }
}
```

ğŸ“Œ ì •ë¦¬
* `ExceptionResolver` ë¥¼ ì‚¬ìš©í•˜ë©´ ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•´ë„ `ExceptionResolver` ì—ì„œ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•´ë²„ë¦°ë‹¤.
* ë”°ë¼ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•´ë„ ì„œë¸”ë¦¿ ì»¨í…Œì´ë„ˆê¹Œì§€ ì˜ˆì™¸ê°€ ì „ë‹¬ë˜ì§€ ì•Šê³ , ìŠ¤í”„ë§ MVCì—ì„œ ì˜ˆì™¸ ì²˜ë¦¬ëŠ” ëì´ ë‚œë‹¤.
* ì´ë ‡ê²Œ ì˜ˆì™¸ë¥¼ ì´ê³³ì—ì„œ ëª¨ë‘ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì´ í•µì‹¬ì´ë‹¤.

# ğŸ’¡ ìŠ¤í”„ë§ì´ ê¸°ë³¸ìœ¼ë¡œ ì œê³µí•˜ëŠ” ExceptionResolver
#### HandlerExceptionResolverComposite ì— ë‹¤ìŒ ìˆœì„œë¡œ ë“±ë¡
1. ExceptionHandlerExceptionResolver
2. ResponseStatusExceptionResolver
3. DefaultHandlerExceptionResolver â†’ ìš°ì„  ìˆœìœ„ê°€ ê°€ì¥ ë‚®ë‹¤.

* `ExceptionHandlerExceptionResolver`: `@ExceptionHandler`ì„ ì²˜ë¦¬í•œë‹¤.
  * API ì˜ˆì™¸ ì²˜ë¦¬ëŠ” ëŒ€ë¶€ë¶„ ì´ ê¸°ëŠ¥ìœ¼ë¡œ í•´ê²°í•œë‹¤.
* `ResponseStatusExceptionResolver`: HTTP ìƒíƒœ ì½”ë“œë¥¼ ì§€ì •í•´ì¤€ë‹¤.
  * ì˜ˆ) @ResponseStatus(value = HttpStatus.NOT_FOUND) 
* `DefaultHandlerExceptionResolver`: ìŠ¤í”„ë§ ë‚´ë¶€ ê¸°ë³¸ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•œë‹¤.

# ğŸ’¡ API ì˜ˆì™¸ ì²˜ë¦¬ - @ExceptionHandler

