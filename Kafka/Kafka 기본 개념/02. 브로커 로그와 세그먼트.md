# 💡 로그와 세그먼트

![image](https://github.com/user-attachments/assets/9ae47dfc-ec48-4df4-830f-59e06de37c54)

- `log.segment.bytes` : 바이트 단위의 최대 세그먼트 크기 지정. 기본 값은 1GB.
- `log.roll.ms(hours)` : 세그먼트가 신규 생성된 이후 다음 파일로 넘어가는 시간 주기. 기본 값은 7일.
- 참고로, log파일의 파일명은 해당 log파일에 저장된 맨 처음 offset 번호이다.
- 가장 마지막 세그먼트 파일(쓰기가 일어나고 있는 파일)을 액티브 세그먼트라고 부른다.
- 액티브 세그먼트는 브로커의 삭제 대상에 포함되지 않는다.
- 액티브 세그먼트가 아닌 세그먼트는 retention 옵션에 따라 삭제 대상으로 지정된다.

# 💡 세그먼트 삭제, cleanup.policy=delete, 세그먼트 통째로 삭제

- 카프카에서 데이터는 세그먼트 단위로 삭제가 발생하기 때문에 로그 단위(레코드 단위)로 개별 삭제는 불가능하다.
- 또한, 로그(레코드)의 메시지 키, 메시지 값, 오프셋, 헤더 등 이미 적재된 데이터에 대해서 수정 또한 불가능하기 때문에 데이터를 적재할 때(프로듀서) 또는 데이터를 사용할 때(컨슈머) 데이터를 검증하는 것이 좋다.

### 관련 옵션
- `retention.ms(minutes, hours)` : 세그먼트를 보유할 최대 기간. 기본 값은 7일.
- `retention.bytes` : 파티션당 로그 적재 바이트 값. 기본 값은 -1 (지정하지 않음)
- `log.retention.check.interval.ms`: 세그먼트가 삭제 영역에 들어왔는지 확인하는 간격. 기본 값은 5분.

# 💡 세그먼트 삭제, cleanup.policy=compact, 압축하기

![image](https://github.com/user-attachments/assets/c7c1c2cb-4288-48c0-885f-e921cf234c91)

- 토픽 압축 정책은 일반적으로 생각하는 zip과 같은 압축(compression)과는 다른 개념이다.
- 여기서 압축이란 메시지 키 별로 해당 메시지 키의 레코드 중 오래된 데이터를 삭제하는 정책을 뜻한다.
- 그렇기 때문에 삭제(delete) 정책과 다르게 일부 레코드만 삭제가 될 수 있다.
- 압축은 액티브 세그먼트를 제외한 데이터가 대상이다.

### 테일/헤드 영역, 클린/더티 로그

![image](https://github.com/user-attachments/assets/e71f8424-7ccd-4b65-b31c-aefa4348ece2)

- 테일 영역 : 압축 정책에 의해 압축이 완료된 레코드들. 클린(clean)로그 라고도 부른다. 중복 메시지 키가 없다.
- 헤드 영역 : 압축 정책이 되기 전 레코드들. 더티(dirty)로그 라고도 부른다. 중복된 메시지 키가 있다.

### `min.cleanable.dirty.ratio`

![image](https://github.com/user-attachments/assets/5dab2d84-c2a4-4289-b09b-a149e72b600c)


- 데이터의 압축 시작 시점은 `min.cleanable.dirty.ratio` 옵션값을 따른다.
- `min.cleanable.dirty.ratio` 옵션 값은 액티브 세그먼트를 제외한 세그먼트에 남아 있는 테일 영역의 레코드 개수와 헤드 영역의 레코드 개수의 비율을 뜻한다.
- 예를 들어 0.5로 설정한다면 테일 영역의 레코드 개수가 헤드 영역의 레코드 개수와 동일할 경우 압축이 실행된다.
- 0.9와 같이 크게 설정하면 한번 압축을 할 때 많은 데이터가 줄어들므로 압축 효과가 좋다.
- 그러나 0.9 비율이 될 때까지 용량을 차지하므로 용량 효율이 좋지 않다.
- 반면, 0.1과 같이 작게 설정하면 압축이 자주 일어나서 가장 최신 데이터만 유지할 수 있지만 압축이 자주 발생하기 때문에 브로커에 부담을 줄 수 있다.
