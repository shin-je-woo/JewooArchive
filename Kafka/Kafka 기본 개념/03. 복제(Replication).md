# 💡 브로커의 역할 - 복제 (Replication)

![image](https://github.com/user-attachments/assets/a080d04a-7b2d-4952-82f6-c75316ad017e)

- 데이터 복제(replication)는 카프카를 장애 허용 시스템(fault tolerant system)으로 동작하도록 하는 원동력이다.
- 복제의 이유는 클러스터로 묶인 브로커 중 일부에 장애가 발생하더라도 데이터를 유실하지 않고 안전하게 사용하기 위함이다.
- 카프카의 데이터 복제는 파티션 단위로 이루어진다.
- 토픽을 생성할 때 파티션의 복제 개수 (replication factor)도 같이 설정하는데, 직접 옵션을 선택하지 않으면 브로커에 설정된 옵션 값을 따라간다.
- 복제 개수의 최솟값은 1(복제 없음)이고 최댓값은 브로커 개수만큼 설정하여 사용할 수 있다.
- 복제된 파티션은 리더(leader)와 팔로워(follower)로 구성된다.
- 프로듀서 또는 컨슈머와 직접 통신하는 파티션을 리더, 나머지 복제 데이터를 가지고 있는 파티션을 팔로워라고 부른다.
- 팔로워 파티션들은 리더 파티션의 오프셋을 확인하여 현재 자신이 가지고 있는 오프셋과 차이가 나는 경우 리더 파티션으로부터 데이터를 가져와서 자신의 파티션에 저장하는데, 이 과정을 '복제'라고 부른다.
- 파티션 복제로 인해 저장 용량이 증가한다는 단점이 있지만, 데이터를 안전하게 저장하고 사용할 수 있다는 강력한 장점이 있다.

# 💡 브로커에 장애가 발생한 경우 - 승급

![image](https://github.com/user-attachments/assets/d99cf7d3-2617-40f0-b711-fb10fa909313)

- 브로커가 다운되면 해당 브로커에 있는 리더 파티션은 사용할 수 없기 때문에 팔로워 파티션 중 하나가 리더 파티션 지위를 넘겨받는다.
- 이를 통해 데이터가 유실되지 않고 컨슈머나 프로듀서와 데이터를 주고받도록 동작할 수 있다.
- 운영 시에는 데이터 종류마다 다른 복제 개수를 설정하고 상황에 따라서는 토픽마다 복제 개수를 다르게 설정하여 운영하기도 한다.
- 데이터가 일부 유실되어도 무관하고 데이터 처리 속도가 중요하다면 1 또는 2로 설정한다.
- 금융 정보와 같이 유실이 일어나면 안되는 데이터의 경우 복제 개수를 3으로 설정하기도 한다.

# 💡 ISR (In-Sync-Replicas)

![image](https://github.com/user-attachments/assets/0631a7fb-a54b-4238-97ee-70ea3d716589)

- ISR은 리더 파티션과 팔로워 파티션이 모두 싱크가 된 상태를 뜻한다.
- 복제 개수가 2인 토픽을 가정해 보자. 이 토픽에는 리더 파티션 1개와 팔로워 파티션 1개가 존재할 것이다.
- 리더 파티션에 0 부터 3의 오프셋이 있다고 가정할 때, 팔로워 파티션에 동기화가 완료되려면 0 부터 3 까지 오프셋이 존재해야 한다.
- 동기화가 완료됐다는 의미는 리더 파티션의 모든 데이터가 팔로워 파티션에 복제된 상태를 말하기 때문이다.

![image](https://github.com/user-attachments/assets/9d4e682c-880d-418d-a55e-481e32d3c461)

- 만약, 리더 파티션의 데이터를 모두 복제하지 못한 팔로워 파티션이 리더 파티션으로 승급되면 데이터가 유실될 수 있다. 
- 유실이 발생하더라도 서비스를 중단하지 않고 지속적으로 토픽을 사용하고 싶다면 ISR이 아닌 팔로워 파티션을 리더로 선출하도록 설정할 수 있다.

### 관련옵션
- `unclean.leader.election.enable=true` : 유실을 감수함. 복제가 안된 팔로워 파티션을 리더로 승급.
- `unclean.leader.election.enable=false` : 유실을 감수하지 않음. 해당 브로커가 복구될 때까지 중단.
