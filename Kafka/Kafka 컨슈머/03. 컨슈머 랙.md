# 💡 컨슈머 랙

- 컨슈머 랙(LAG)은 파티션의 최신 오프셋(LOG-END-OFFSET)과 컨슈머 오프셋(CURRENT- OFFSET) 간의 차이다.
- 컨슈머 랙은 컨슈머가 정상 동작하는지 여부를 확인할 수 있기 때문에 필수적으로 모니터링해야 하는 지표이다.
- 컨슈머 랙은 컨슈머 그룹과 토픽, 파티션 별로 생성된다. ex) 한 개의 토픽에 3개의 파티션이 있고 1개의 컨슈머 그룹이 토픽을 구독하여 데이터를 가져가면 컨슈머 랙은 총 3개이다.
- 프로듀서가 보내는 데이터 양 > 컨슈머 데이터 처리량 -> 컨슈머 랙 증가
- 프로듀서가 보내는 데이터 양 < 컨슈머 데이터 처리량 -> 컨슈머 랙 감소 ( 최솟값은 0으로 지연 없음을 의미)

![image](https://github.com/user-attachments/assets/847d7189-ca0d-4ed8-8376-a6e28f6d68f4)

# 💡 컨슈머 랙 모니터링

- 컨슈머 랙을 모니터링함으로써 컨슈머의 장애를 확인하고 파티션의 개수를 정할 수 있다.

## 처리량 이슈: 프로듀서의 데이터양이 늘어난 경우

- 프로듀서의 데이터양이 늘어날 경우 컨슈머 랙이 늘어날 수 있다.
- 이 경우 파티션과 컨슈머 갯수를 늘려 컨슈머 랙을 줄일 수 있다.

![image](https://github.com/user-attachments/assets/f29c2f1b-eab8-4530-bb35-043d977da92f)

## 파티션 이슈: 컨슈머의 장애로 인해 컨슈머 랙이 증가하는 경우

- 프로듀서의 데이터가 일정함에도 불구하고 컨슈머의 장애로 인해 컨슈머 랙이 증가할 수 있다.
- 컨슈머 랙을 모니터링하면 이러한 경우에 대처가 가능하다.

![image](https://github.com/user-attachments/assets/328fef12-7063-488a-91d2-1cefa9420607)

# 💡 컨슈머 랙을 모니터링하는 방법 3가지

## 1. 카프카 명령어 사용

- kafka-consumer-groups.sh 명령어를 사용해 특정 컨슈머 그룹의 상태를 확인할 수 있다.
- 그러나, 명령어를 사용하는 방식은 일회성에 그치고 지표를 지속적으로 기록하고 모니터링하기에는 부족하다. 이런 이유로 주로 테스트용 카프카에서 사용된다.

```
kafka-consumer-groups.sh --bootstrap-server my-kafka:9092 --group test-group --describe
```

![image](https://github.com/user-attachments/assets/177e6779-96d0-4f25-aa41-306e7819ff3b)

## 2. metrics() 메서드 사용

- 컨슈머 애플리케이션에서 KafkaConsumer 인스턴스의 metrics() 메서드를 활용하면 컨슈머 랙 지표를 확인할 수 있다.
- 컨슈머 인스턴스가 제공하는 컨슈머 랙 관련 모니터링 지표는 3가지로 records-lag- max, records-lag, records-lag-avg이다.
- 하지만 metrics() 메서드는 다음과 같이 세 가지 문제점이 있다.
  - 컨슈머가 실행하므로 컨슈머에 장애가 발생하는 경우 더 이상 컨슈머 랙을 모니터링할 수 없다.
  - 모든 컨슈머 애플리케이션에 모니터링 코드를 중복 작성해야 한다.
  - 카프카 서드 파티 애플리케이션의 컨슈머 랙 모니터링 불가
 
## 3. 외부 모니터링 툴 사용

- 컨슈머 랙을 모니터링하는 가장 최선의 방법은 외부 모니터링 툴을 사용하는 것이다.
- 데이터 독(Datadog), 컨플루언트 컨트롤 센터(Confluent Control Center)와 같은 카프카 클러스터 종합 모니터링 툴을 사용하면 카프카 운영에 필요한 다양한 지표를 모니터링할 수 있다.
- 컨슈머 랙 모니터링만을 위한 툴로 오픈소스로 공개되어 있는 버로우(Burrow)가 있다.

