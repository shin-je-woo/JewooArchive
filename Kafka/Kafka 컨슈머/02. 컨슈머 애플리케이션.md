# ğŸ’¡ ì»¨ìŠˆë¨¸ êµ¬í˜„í•˜ê¸°

```java
public class SimpleConsumer {
    private static final Logger logger = LoggerFactory.getLogger(SimpleConsumer.class);
    private static final String TOPIC_NAME = "test";
    private static final String BOOTSTRAP_SERVERS = "my-kafka:9092";
    private static final String GROUP_ID = "test-group";

    public static void main(String[] args) {
        Properties configs = new Properties();
        configs.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, BOOTSTRAP_SERVERS);
        configs.put(ConsumerConfig.GROUP_ID_CONFIG, GROUP_ID);
        configs.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);
        configs.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);

        try (KafkaConsumer<String, String> consumer = new KafkaConsumer<>(configs)) {
            consumer.subscribe(List.of(TOPIC_NAME));
            while (true) {
                ConsumerRecords<String, String> records = consumer.poll(Duration.ofSeconds(1));
                for (ConsumerRecord<String, String> record : records) {
                    logger.info("record:{}", record);
                }
            }
        }
    }
}
```

- ë¬´í•œë£¨í”„ì—ì„œ poll() ë©”ì„œë“œë¥¼ ì‚¬ìš©í•´ ì»¨ìŠˆë¨¸ ë ˆì½”ë“œë¥¼ ë°›ì•„ì™€ ì²˜ë¦¬í•œë‹¤.
- CLIì—ì„œ ë ˆì½”ë“œë¥¼ í”„ë¡œë“€ìŠ¤í•˜ë©´ ì•„ë˜ ì´ë¯¸ì§€ì™€ ê°™ì´ ì»¨ìŠˆë¨¸ê°€ ë ˆì½”ë“œë¥¼ ì²˜ë¦¬í•˜ëŠ” ëª¨ìŠµì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

![image](https://github.com/user-attachments/assets/21720429-e27e-4c93-99a6-846c282f7d33)

![image](https://github.com/user-attachments/assets/92858c09-fe6e-4902-acbd-d4908d98fa10)

# ğŸ’¡ ìˆ˜ë™ ì»¤ë°‹ ì»¨ìŠˆë¨¸

- ìˆ˜ë™ìœ¼ë¡œ ì˜¤í”„ì…‹ì„ ì»¤ë°‹í•˜ê³  ì‹¶ë‹¤ë©´ ì»¨ìŠˆë¨¸ì˜ ì„¤ì •ì„ ë°”ê¿”ì•¼ í•œë‹¤.
- ì»¨ìŠˆë¨¸ì˜ ì˜µì…˜ ì¤‘ `enable.auto.commit` ì„¤ì •ì„ falseë¡œ í•œë‹¤.
- ìë°” ì½”ë“œë¡œëŠ” ì•„ë˜ ê·¸ëŸ¼ì²˜ëŸ¼ ì…ë ¥í•˜ë©´ ëœë‹¤.

```java
configs.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, false);
```

## ë™ê¸° ì˜¤í”„ì…‹ ì»¤ë°‹ ì»¨ìŠˆë¨¸

- poll() ë©”ì„œë“œê°€ í˜¸ì¶œëœ ì´í›„ commitSync() ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ì—¬ ì˜¤í”„ì…‹ ì»¤ë°‹ì„ ëª…ì‹œì ìœ¼ë¡œ ìˆ˜í–‰í•  ìˆ˜ ìˆë‹¤.
- commitSync()ëŠ” poll() ë©”ì„œë“œë¡œ ë°›ì€ ê°€ì¥ ë§ˆì§€ë§‰ ë ˆì½”ë“œì˜ ì˜¤í”„ì…‹ì„ ê¸°ì¤€ìœ¼ë¡œ ì»¤ë°‹í•œë‹¤.
- ë™ê¸° ì˜¤í”„ì…‹ ì»¤ë°‹ì„ ì‚¬ìš©í•  ê²½ìš° poll() ë©”ì„œë“œë¡œ ë°›ì€ ëª¨ë“  ë ˆì½”ë“œ ì²˜ë¦¬ê°€ ëë‚œ ì´í›„ commitSync() ë©”ì„œë“œë¥¼ í˜¸ì¶œí•´ì•¼ í•œë‹¤.
- ë™ê¸° ì˜¤í”„ì…‹ ì»¤ë°‹ì„ ì‚¬ìš©í•  ê²½ìš° ì»¤ë°‹ ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ëŠ” ë™ì•ˆ ë°ì´í„° ì²˜ë¦¬ê°€ ì¼ì‹œì ìœ¼ë¡œ ì¤‘ë‹¨ëœë‹¤. 

```java
try (KafkaConsumer<String, String> consumer = new KafkaConsumer<>(configs)) {
    consumer.subscribe(List.of(TOPIC_NAME));
    while (true) {
        ConsumerRecords<String, String> records = consumer.poll(Duration.ofSeconds(1));
        for (ConsumerRecord<String, String> record : records) {
            logger.info("record:{}", record);
        }
        consumer.commitSync(); // ë™ê¸° ì˜¤í”„ì…‹ ì»¤ë°‹
    }
}
```

- ì•„ë˜ì™€ ê°™ì´ ë ˆì½”ë“œë¥¼ ì²˜ë¦¬í•  ë•Œë§ˆë‹¤ ì»¤ë°‹í•˜ëŠ” ë°©ë²•ë„ ìˆê¸´ í•˜ì§€ë§Œ, ê¶Œì¥ë˜ì§„ ì•ŠëŠ”ë‹¤.
- ë§¤ë²ˆ ë ˆì½”ë“œë¥¼ ì²˜ë¦¬í•  ë•Œë§ˆë‹¤ ë¸Œë¡œì»¤ì— ë¶€ë‹´ì´ ë˜ê¸° ë•Œë¬¸ì´ë‹¤.

```java
try (KafkaConsumer<String, String> consumer = new KafkaConsumer<>(configs)) {
    consumer.subscribe(List.of(TOPIC_NAME));
    while (true) {
        ConsumerRecords<String, String> records = consumer.poll(Duration.ofSeconds(1));
        Map<TopicPartition, OffsetAndMetadata> currentOffset = new HashMap<>();

        for (ConsumerRecord<String, String> record : records) {
            logger.info("record:{}", record);
            currentOffset.put(
                    new TopicPartition(record.topic(), record.partition()),
                    new OffsetAndMetadata(record.offset() + 1, null));
            consumer.commitSync(currentOffset); // ë™ê¸° ì˜¤í”„ì…‹ ì»¤ë°‹
        }
    }
}
```

## ë¹„ë™ê¸° ì˜¤í”„ì…‹ ì»¤ë°‹ ì»¨ìŠˆë¨¸

- ë™ê¸° ì˜¤í”„ì…‹ ì»¤ë°‹ì„ ì‚¬ìš©í•  ê²½ìš° ì»¤ë°‹ ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ëŠ” ë™ì•ˆ ë°ì´í„° ì²˜ë¦¬ê°€ ì¼ì‹œì ìœ¼ë¡œ ì¤‘ë‹¨ ë˜ê¸° ë•Œë¬¸ì— ë” ë§ì€ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ì„œëŠ” ë¹„ë™ê¸° ì˜¤í”„ì…‹ ì»¤ë°‹ì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤.
- ë¹„ë™ê¸° ì˜¤í”„ì…‹ ì»¤ë°‹ì€ commitAsync() ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ì—¬ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

```java
//...
import org.apache.kafka.clients.consumer.OffsetCommitCallback;

public class ConsumerCommitCallback implements OffsetCommitCallback {

    private final static Logger logger = LoggerFactory.getLogger(ConsumerCommitCallback.class);

    @Override
    public void onComplete(Map<TopicPartition, OffsetAndMetadata> offsets, Exception exception) {
        if (exception != null) {
            logger.error(exception.getMessage(), exception);
        } else {
            logger.info("offset commit success");
        }
    }
}
```

```java
try (KafkaConsumer<String, String> consumer = new KafkaConsumer<>(configs)) {
    consumer.subscribe(List.of(TOPIC_NAME));
    while (true) {
        ConsumerRecords<String, String> records = consumer.poll(Duration.ofSeconds(1));
        for (ConsumerRecord<String, String> record : records) {
            logger.info("record:{}", record);
        }
        consumer.commitAsync(new ConsumerCommitCallback()); // ë¹„ë™ê¸° ì˜¤í”„ì…‹ ì»¤ë°‹
    }
}
```

# ğŸ’¡ ë¦¬ë°¸ëŸ°ìŠ¤ ë¦¬ìŠ¤ë„ˆë¥¼ ê°€ì§„ ì»¨ìŠˆë¨¸

- ë¦¬ë°¸ëŸ°ìŠ¤ ë°œìƒ ê°ì§€ë¥¼ ìœ„í•´ ì¹´í”„ì¹´ëŠ” ConsumerRebalancedListener ì¸í„°í˜ì´ìŠ¤ë¥¼ ì§€ì›í•œë‹¤.
- ConsumerRebalanceListner ì¸í„°í˜ì´ìŠ¤ë¡œ êµ¬í˜„ëœ í´ë˜ìŠ¤ëŠ” onPartitionAssigned(), onPartitionRevoked() ë©”ì„œë“œë¡œ ì´ë¤„ì§„ë‹¤.
- `onPartitionAssigned()`: ë¦¬ë°¸ëŸ°ìŠ¤ê°€ ëë‚œ ë’¤ íŒŒí‹°ì…˜ì´ í• ë‹¹ ë˜ë©´ í˜¸ì¶œë˜ëŠ” ë©”ì„œë“œ
- `onPartitionRevoked()`: ë¦¬ë°¸ëŸ°ìŠ¤ ì‹œì‘ë˜ê¸° ì§ì „ì— í˜¸ì¶œë˜ëŠ” ë©”ì„œë“œ. ë§ˆì§€ë§‰ìœ¼ë¡œ ì²˜ë¦¬í•œ ë ˆì½”ë“œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì»¤ë°‹ì„ í•˜ê¸° ìœ„í•´ì„œëŠ” ë¦¬ë°¸ëŸ°ìŠ¤ê°€ ì‹œì‘í•˜ê¸° ì§ì „ì— ì»¤ë°‹ì„ í•˜ë©´ ë˜ë¯€ë¡œ onPartitionRevoked() ë©”ì„œë“œì— ì»¤ë°‹ì„ êµ¬í˜„í•˜ì—¬ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤.

```java
public class RebalanceListener implements ConsumerRebalanceListener {
    private final static Logger logger = LoggerFactory.getLogger(RebalanceListener.class);

    @Override
    public void onPartitionsRevoked(Collection<TopicPartition> partitions) {
        logger.warn("Partitions are revoked : {}", partitions.toString());
    }

    @Override
    public void onPartitionsAssigned(Collection<TopicPartition> partitions) {
        logger.warn("Partitions are assigned : {}", partitions.toString());
    }
}
```

```java
try (KafkaConsumer<String, String> consumer = new KafkaConsumer<>(configs)) {
    consumer.subscribe(List.of(TOPIC_NAME), new RebalanceListener()); // ConsumerRebalanceListener í• ë‹¹
    while (true) {
        ConsumerRecords<String, String> records = consumer.poll(Duration.ofSeconds(1));
        for (ConsumerRecord<String, String> record : records) {
            logger.info("{}", record);
        }
    }
}
```

- consumerê°€ í† í”½ì„ subsribeí•  ë•Œ rebalanceListenerë¥¼ í• ë‹¹í•´ì¤€ë‹¤.
- ì»¨ìŠˆë¨¸ë¥¼ ì‹¤í–‰í•´ì„œ ì»¨ìŠˆë¨¸ ê·¸ë£¹ì´ ì–´ë–»ê²Œ ë¦¬ë°¸ëŸ°ì‹± í•˜ëŠ”ì§€ í™•ì¸í•´ë³´ì.

1. ì»¨ìŠˆë¨¸ë¥¼ í•˜ë‚˜ ì‹¤í–‰í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì´ 0,1,2,3ë²ˆ íŒŒí‹°ì…˜ì— í• ë‹¹ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

![image](https://github.com/user-attachments/assets/aa3f0e93-df26-4de0-a79b-773222f01f10)

2. ì´ ìƒíƒœë¡œ ì»¨ìŠˆë¨¸ë¥¼ í•˜ë‚˜ ë” ì‹¤í–‰í•˜ë©´ ìƒˆë¡œ ì‹¤í–‰ëœ ì»¨ìŠˆë¨¸ì— 0,1ë²ˆ íŒŒí‹°ì…˜ì— í™œë‹¹ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

![image](https://github.com/user-attachments/assets/1c65fa4f-54aa-48ef-b56e-4ddddfbe4f72)

3. ë‘ ë²ˆì§¸ ì»¨ìŠˆë¨¸ê°€ ì‹¤í–‰ëœ ì‹œì ì— í•´ë‹¹ ì»¨ìŠˆë¨¸ ê·¸ë£¹ì˜ ê¸°ì¡´ ì»¨ìŠˆë¨¸ì—ì„œ ë¦¬ë°¸ëŸ°ì‹±ì´ ë°œìƒí•œë‹¤.

![image](https://github.com/user-attachments/assets/71f67ba2-d1b5-4078-8a7f-347cde7f2e42)

![image](https://github.com/user-attachments/assets/cdc32b69-8587-4bba-8f6f-bef665647ec7)

4. ì´ ìƒíƒœì—ì„œ ë§¨ ì²˜ìŒ ì‹¤í–‰í•œ ì»¨ìŠˆë¨¸ë¥¼ ì¢…ë£Œí•˜ë©´ ë‘ ë²ˆì§¸ ì‹¤í–‰í•œ ì»¨ìŠˆë¨¸ì—ì„œ ë¦¬ë°¸ëŸ°ì‹±ì´ ë°œìƒí•œë‹¤.

![image](https://github.com/user-attachments/assets/ab0c3168-55a0-426a-b26c-34edaccd5ebf)

![image](https://github.com/user-attachments/assets/86abeb6e-92cc-4e1c-8bc6-eb466b5efa28)

- ì¦‰, ë¦¬ë°¸ëŸ°ì‹±ì„ í†µí•´ íŒŒí‹°ì…˜ì„ ì»¨ìŠˆë¨¸ ê·¸ë£¹ì— ì ì ˆíˆ ë¶„ë°°í•˜ê³  ìˆìŒì„ ì•Œ ìˆ˜ ìˆê³ , ConsumerRebalanceListenerë¥¼ í†µí•´ ë¦¬ë°¸ëŸ°ì‹± ì „/í›„ë¡œ ì ì ˆí•œ ì²˜ë¦¬ë¥¼ í•  ìˆ˜ ìˆìŒì„ ì•Œ ìˆ˜ ìˆë‹¤.

# ğŸ’¡ ì»¨ìŠˆë¨¸ì˜ ì•ˆì „í•œ ì¢…ë£Œ

- ì»¨ìŠˆë¨¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì€ ì•ˆì „í•˜ê²Œ ì¢…ë£Œë˜ì–´ì•¼ í•œë‹¤.
- ì •ìƒì ìœ¼ë¡œ ì¢…ë£Œë˜ì§€ ì•Šì€ ì»¨ìŠˆë¨¸ëŠ” ì„¸ì…˜ íƒ€ì„ì•„ì›ƒì´ ë°œìƒí•  ë•Œê¹Œì§€ ì»¨ìŠˆë¨¸ ê·¸ë£¹ì— ë‚¨ê²Œ ëœë‹¤.
- ì•ˆì „í•œ ì¢…ë£Œë¥¼ ìœ„í•´ì„œëŠ” KafkaConsumer í´ë˜ìŠ¤ì˜ wakeup() ë©”ì„œë“œë¥¼ ì‚¬ìš©í•œë‹¤.
- wakeup() ë©”ì„œë“œê°€ ì‹¤í–‰ëœ ì´í›„ poll() ë©”ì„œë“œê°€ í˜¸ì¶œë˜ë©´ WakeupException ì˜ˆì™¸ê°€ ë°œìƒí•œë‹¤.
- Wakeup Exception ì˜ˆì™¸ë¥¼ ë°›ì€ ë’¤ì—ëŠ” ë°ì´í„° ì²˜ë¦¬ë¥¼ ìœ„í•´ ì‚¬ìš©í•œ ìì›ë“¤ì„ í•´ì œí•˜ë©´ ëœë‹¤.

1. wakeup() ë©”ì„œë“œê°€ ì‹¤í–‰
2. poll() ë©”ì„œë“œê°€ í˜¸ì¶œ
3. WakeupException ì˜ˆì™¸ê°€ ë°œìƒ
4. ì˜ˆì™¸ ë°›ìœ¼ë©´ ë°ì´í„° ì²˜ë¦¬ë¥¼ ìœ„í•´ ì‚¬ìš©í•œ ìì›ë“¤ì„ í•´ì œ

```java
public class ConsumerShutdownHook {
    private final static Logger logger = LoggerFactory.getLogger(ConsumerShutdownHook.class);
    private final static String TOPIC_NAME = "test";
    private final static String BOOTSTRAP_SERVERS = "my-kafka:9092";
    private final static String GROUP_ID = "test-group";
    private static KafkaConsumer<String, String> consumer;

    public static void main(String[] args) {
        Runtime.getRuntime().addShutdownHook(new ShutdownHookThread()); // ìë°” ëŸ°íƒ€ì„ ì…§ë‹¤ìš´ í›… ë“±ë¡

        Properties configs = new Properties();
        configs.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, BOOTSTRAP_SERVERS);
        configs.put(ConsumerConfig.GROUP_ID_CONFIG, GROUP_ID);
        configs.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());
        configs.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());
        configs.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, false);

        consumer = new KafkaConsumer<>(configs);
        consumer.subscribe(List.of(TOPIC_NAME));

        try {
            while (true) {
                ConsumerRecords<String, String> records = consumer.poll(Duration.ofSeconds(1));
                for (ConsumerRecord<String, String> record : records) {
                    logger.info("{}", record);
                }
                consumer.commitSync();
            }
        } catch (WakeupException e) {
            // ì»¨ìŠˆë¨¸ì˜ wakeup()ì´ í˜¸ì¶œë˜ë©´ WakeupException ì˜ˆì™¸ ë°œìƒ
            // ì—¬ê¸°ì„œ í•„ìš”í•œ ì²˜ë¦¬ (ìì› í•´ì œ ë“±ë“±..)
            logger.warn("Wakeup consumer");
        } finally {
            logger.warn("Consumer close");
            consumer.close();
        }
    }

    static class ShutdownHookThread extends Thread {
        @Override
        public void run() {
            logger.info("Shutdown hook");
            consumer.wakeup();
        }
    }
}
```
