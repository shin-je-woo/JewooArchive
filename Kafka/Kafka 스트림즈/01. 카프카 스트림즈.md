# 💡 카프카 스트림즈

![image](https://github.com/user-attachments/assets/623fe517-9c28-4bd3-afa8-c9f7e827a50d)

- 카프카 스트림즈는 토픽에 적재된 데이터를 실시간으로 변환하여 다른 토픽에 적재하는 라이브러리이다.
- 스트림즈 애플리케이션 또는 카프카 브로커의 장애가 발생하더라도 정확히 한번만 처리(exactly once)할 수 있도록 장애 허용 시스템(fault tolerant system)을 가지고 있어서 데이터 처리 안정성이 매우 뛰어나다.
- Topic으로 들어오는 데이터를 소비(consuming)하여 Kafka Streams에서 제공하는 처리 로직을 적용하여 집계하거나 재가공 후 다른 Topic으로 발행하거나, Kafka Connect를 이용하여 DB에 적재하는 등의 스트림 처리 기능을 제공한다.

### 프로듀서, 컨슈머가 아닌 스트림즈를 사용해야 하는 이유

- 스트림 데이터 처리에 있어 필요한 다양한 기능을 스트림즈DSL로 제공하며 필요하다면 프로세서 API를 사용하여 기능을 확장할 수 있기 때문이다.
- 컨슈머와 프로듀서를 조합하여 스트림즈가 제공하는 기능과 유사하게 만들 수 있지만, 스트림즈의 단 한 번의 데이터 처리, 장애 허용 시스템 등의 특징들은 컨슈머와 프로듀서의 조합만으로는 완벽하게 구현하기는 어렵다.
- 다만, 스트림즈가 제공하지 못하는 기능을 구현할 때는 컨슈머와 프로듀서를 조합하여 구현하면 좋다.
- 예를 들어, 소스 토픽(사용하는 토픽)과 싱크 토픽(저장하는 토픽)의 카프카 클러스터가 서로 다른 경우는 스트림즈가 지원하지 않으므로 이때는 컨슈머와 프로듀서 조합으로 직접 클러스터를 지정하는 방식으로 개발할 수 있다.

# 💡 스트림즈 내부 구조

![image](https://github.com/user-attachments/assets/4b3266b6-0e8a-4088-96a9-dc6989996021)

- 스트림즈 애플리케이션은 내부적으로 스레드를 1개 이상 생성할 수 있으며, 스레드는 1개 이상의 태스크를 가진다.
- 스트림즈의 태스크(task)는 스트림즈 애플리케이션을 실행하면 생기는 데이터 처리 최소 단위이다.
- 만약 3개의 파티션으로 이루어진 토픽을 처리하는 스트림즈 애플리케이션을 실행하면 내부에 3개의 태스크가 생긴다.
- 컨슈머의 병렬처리를 위해 컨슈머 그룹으로 이루어진 컨슈머 스레드를 여러개 실행하는 것과 비슷하다고 볼 수 있다.
- 카프카 스트림즈는 컨슈머 스레드를 늘리는 방법과 동일하게 병렬처리를 위해 파티션과 스트림즈 스레드(또는 프로세스) 개수를 늘림으로써 처리량을 늘릴 수 있다.

# 💡 프로세서와 스트림

![image](https://github.com/user-attachments/assets/7f0b9f94-05c7-4eda-8c1a-2c3a58145c33)

- 카프카 스트림즈에서는 토폴로지를 이루는 노드를 프로세서(processor)라고 부르고, 노드와 노드를 이은 선을 스트림(stream)이라고 부른다.
- 스트림은 토픽의 데이터를 뜻하는데, 프로듀서와 컨슈머에서 활용했던 레코드와 동일하다.
- 프로세서에는 소스 프로세서, 스트림 프로세서, 싱크 프로세서 3가지가 있다.
- Source Processor는 하나 이상의 토픽에서 데이터를 가져오는 역할을 한다. Kafka topic으로부터 데이터를 읽고 하나 이상의 Stream Processor로 전송한다.
- Stream Processor는 변환, 분기처리와 같은 데이터 처리 로직을 수행한다.
- Sink Processor는 처리한 데이터를 카프카로 다시 내보내는 역할을 한다. 이 데이터는 토픽으로 저장되거나 Kafka Connect를 이용하여 DB에 저장할 수도 있다.

# 💡 스트림즈DSL과 프로세서API

- 스트림즈 애플리케이션은 스트림즈DSL(Domain Specific Language)과 프로세서 API 2가지 방법으로 개발 가능하다.
- 스트림즈 DSL은 스트림 프로세싱에 쓰일 만한 다양한 기능들을 자체 API로 만들어 놓았기 때문에 대부분의 변환 로직을 어렵지 않게 개발할 수 있다.
- 만약 스트림즈DSL에서 제공하지 않는 일부 기능들의 경우 프로세서 API를 사용하여 구현할 수 있다.
- 스트림즈DSL과 프로세서 API가 구현할 수 있는 종류는 다음과 같다.

### 스트림즈DSL로 구현하는 데이터 처리 예시

- 메시지 값을 기반으로 토픽 분기 처리
- 지난 10분간 들어온 데이터의 개수 집계

###  프로세서API로 구현하는 데이터 처리 예시

- 메시지 값의 종류에 따라 토픽을 가변적으로 전송
- 일정한 시간 간격으로 데이터 처리

# 💡 스트림즈 주요 옵션

## 필수 옵션 (default 값이 없음)

- `bootstrap.servers`: 대상 카프카 클러스터에 속한 브로커의 호스트 이름: 포트를 1개 이상 작성한다. 2개 이상 브로커 정보를 입력하여 일부 브로커에 이슈가 발생하더라도 접속하는 데에 이슈가 없도록 설정 가능하다.
- `application.id`: 스트림즈 애플리케이션을 구분하기 위한 고유한 아이디를 설정한다. 다른 로직을 가진 스트림즈 애플리케이션들은 서로 다른 application.id 값을 가져야 한다.

## 선택 옵션 (default 값 있음)

- `default.key.serde`: 레코드의 메시지 키를 직렬화, 역직렬화하는 클래스를 지정한다. 기본값은 바이트 직렬화, 역직렬화 클래스인 Serdes.ByteArray().getClass().getName()이다.
- `default.value.serde`: 레코드의 메시지 값을 직렬화, 역직렬화하는 클래스를 지정한다. 기본값은 바이트 직렬화, 역직렬화 클래스인 Serdes.ByteArray().getClass().getName()이다.
- `num.stream.threads`: 스트림 프로세싱 실행 시 실행될 스레드 개수를 지정한다. 기본값은 1이다.
- `state.dir`: 상태기반 데이터 처리를 할 때 데이터를 저장할 디렉토리를 지정한다. 기본값은 /tmp/kafka-streams이다.
