# 💡 멱등성 프로듀서의 필요성

- 프로듀서가 카프카에 데이터를 전송할 때 네트워크 오류로 인해서 중복된 메시지가 전송될 수 있다.

![image](https://github.com/user-attachments/assets/f5d2e9b0-371e-49b2-b6df-0d3840c0a3aa)

- 정상 요청
  - 카프카에 데이터를 생성하면 카프카가 로그에 데이터 커밋
  - 그 후 프로듀서에게 수신 확인 전달
- 중복 요청
  - 카프카에 데이터를 생성하면 카프카가 로그에 데이터 커밋
  - 수신 확인 반환할 때 ACK을 프로듀서에게 전달하지 못한다. (네트워크 등의 이슈)
  - ACK을 받지 못한 프로듀서는 재시도를 하게 된다.
  - 똑같은 메시지를 보내면 카프카는 새로운 요청으로 여겨서 로그에 중복 커밋하고, ACK을 보내게 된다.
  - 프로듀서 입장에서는 두 개의 요청 중 하나만 성공했고 카프카가 수신 확인을 반환했지만 카프카는 실제로 메시지 두 개를 커밋 한 것이다.
 
# 💡 멱등성 프로듀서

- 위와 같은 문제를 해결하기 위해서 멱등 프로듀서를 사용한다.
- 네트워크 오류 등의 이슈에도 중복을 허용하지 않는다.

![image](https://github.com/user-attachments/assets/c9481ecc-cadd-493b-ade3-2534cc3f3fcf)

- 멱등성 프로듀서는 동일한 데이터를 여러 번 전송하더라도 카프카 클러스터에 단 한번만 저장됨을 보장한다.
- 멱등성 프로듀서는 정확히 한번 전달(exactly once delivery)을 지원한다.
- 카프카 3.0에서부터는 멱등성 프로듀서가 기본으로 적용된다.

### 멱등성 프로듀서의 동작

- 멱등성 프로듀서는 기본 프로듀서와 달리 데이터를 브로커로 전달할 때 PID(Producer Unique ID)와 시퀀스 넘버(squence number)를 함께 전달한다.
- 카프카 브로커는 프로듀서의 PID와 시퀀스 넘버를 확인하여 동일한 메시지인지 확인한다.
- 동일한 메시지일 경우 정확히 한번만 데이터를 적재한다.

### 주의점

- 멱등성 프로듀서는 동일한 세션에서만 정확히 한번 전달을 보장한다.
- 동일한 세션이란 PID의 생명주기를 뜻한다.
- 만약 프로듀서에 이슈가 발생해 프로듀서를 재시작하게 되면 PID가 달라진다.
- 동일한 데이터를 전송하더라도 PID가 달라지면 브로커는 다른 메시지라고 인식한다.
- 즉, 멱등성 프로듀서는 프로듀서가 재시작되지 않을 경우에만 정확히 한번 전달하는 것을 보장한다.
