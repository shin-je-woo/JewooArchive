# 💡 ISR(In-Sync-Replicas)

![image](https://github.com/user-attachments/assets/54c39753-4a83-47e4-bd31-776e559a2d57)

- ISR은 리더 파티션과 팔로워 파티션이 모두 싱크가 된 상태를 뜻한다.
- 복제 개수가 2인 토픽을 가정해 보자.
- 이 토픽에는 리더 파티션 1개와 팔로워 파티션 1개가 존재할 것이다.
- 리더 파티션에 0부터 3의 오프셋이 있다고 가정할 때, 팔로워 파티션에 동기화가 완료되려면 0부터 3까지 오프셋이 존재해야 한다.
- 동기화가 완료됐다는 의미는 리더 파티션의 모든 데이터가 팔로워 파티션에 복제된 상태를 말하기 때문이다.

![image](https://github.com/user-attachments/assets/41e76dfa-0447-43bc-b9fb-f54b8bdc676d)

- ISR이라는 용어가 나온 이유는 팔로워 파티션이 리더 파티션으로부터 데이터를 복제하는 데에 시간이 걸리기 때문이다.
- 프로듀서가 특정 파티션에 데이터를 저장하는 작업은 리더 파티션을 통해 처리한다.
- 이때 리더 파티션에 새로운 레코드가 추가되어 오프셋이 증가하면 팔로워 파티션이 위치한 브로커는 리더 파티션의 데이터를 복제한다.
- 리더 파티션에 데이터가 적재된 이후 팔로워 파티션이 복제하는 시간차 때문에 리더 파티션과 팔로워 파티션 간에 오프셋 차이가 발생한다.

# 💡 acks 옵션

- 카프카 프로듀서의 acks옵션은 0, 1, all(또는 -1) 값을 가질 수 있다.
- 이 옵션을 통해 프로듀서가 전송한 데이터를 카프카 클러스터에 얼마나 신뢰성 높게 저장할지 지정할 수 있다.
- 복제 개수가 1 인경우 acks옵션에 따른 성능 변화는 크지 않다.
- 그러나 안정적으로 데이터를 운영하기 위해서는 복제 개수를 2 이상으로 운영하는 경우가 대부분이기 때문에 여기서는 복제 개수는 2 이상인 경우에 각 acks별 동작 방식에 대해 알아본다.

## acks=0

![image](https://github.com/user-attachments/assets/c483bcff-ca20-446b-9402-5b8a5bc5b276)

- acks를 0으로 설정하는 것은 프로듀서가 리더 파티션으로 데이터를 전송했을 때 리더 파티션으로 데이터가 저장되었는지 확인하지 않는다는 뜻이다.
- 리더 파티션은 데이터가 저장된 이후에 데이터가 몇 번째 오프셋에 저장되었는지 리턴하는데, acks가 0으로 설정되어 있다면 프로듀서는 리더 파티션에 데이터가 저장되었는지 여부에 대한 응답 값을 받지 않는다.
- 데이터의 전송 속도는 acks를 1 또는 all로 했을 경우보다 훨씬 빠르다.
- 데이터가 일부 유실이 발생하더라도 전송 속도가 중요한 경우에는 이 옵션값을 사용하면 좋다. ex) GPS좌표값

## acks=1

![image](https://github.com/user-attachments/assets/bbf6cbe9-0754-4a7b-bac2-dc1f6f58175d)

- acks를 1로 설정할 경우 프로듀서는 보낸 데이터가 리더 파티션에만 정상적으로 적재되었는지 확인한다.
- 만약 리더 파티션에 정상적으로 적재되지 않았다면 리더 파티션에 적재될 때까지 재시도할 수 있다.
- 그러나, 리더 파티션에 적재되었음을 보장하더라도 데이터는 유실될 수 있다.
- 왜냐하면 복제 개수를 2 이상으로 운영할 경우 리더 파티션에 적재가 완료되어도 팔로워 파티션에는 아직 데이터가 동기화되지 않을 수 있기 때문이다.
- 팔로워 파티션이 데이터를 복제하기 직전에 리더 파티션이 있는 브로커에 장애가 발생하면 동기화되지 못한 데이터가 유실될 수 있다.

## acks=-1(all)

![image](https://github.com/user-attachments/assets/47f145e0-811d-46a7-9dc0-5630f25bcccc)

- acks를 all 또는 -1로 설정할 경우 프로듀서는 보낸 데이터가 리더 파티션과 팔로워 파티션에 모두 정상적으로 적재되었는지 확인한다.
- 리더 파티션뿐만 아니라 팔로워 파티션까지 데이터가 적재되었는지 확인하기 때문에 0 또는 1 옵션보다도 속도가 느리다.
- 그럼에도 불구하고 팔로우 파티션에 데이터가 정상 적재되었는지 기다리기 때문에 일부 브로커에 장애가 발생하더라도 프로듀서는 안전하게 데이터를 전송하고 저장할 수 있음을 보장할 수 있다.
- acks를 all로 설정할 경우에는 토픽 단위로 설정 가능한 `min.insync.replicas` 옵션값에 따라 데이터의 안정성이 달라진다.

# 💡 min.insync.replicas

- min.insync.replicas 옵션은 프로듀서가 리더 파티션과 팔로워 파티션에 데이터가 적재되었는지 확인하기 위한 최소 ISR그룹의 파티션 개수이다.
- 예를 들어, min.insync.replicas의 옵션값이 1이라면 ISR 중 최소 1개 이상의 파티션에 데이터가 적재되었음을 확인하는 것이다.
- 이 경우 acks를 1로 했을 때와 동일한 동작 하는데, 왜냐하면 ISR 중 가장 처음 적재가 완료되는 파티션은 리더 파티션이기 때문이다.

## acks=-1(all), min.insync.replicas=2

![image](https://github.com/user-attachments/assets/0f7f1984-b4c7-4afd-879a-4085c4e400ce)

- min.insync.replicas의 옵션값을 2로 설정했을 때부터 acks를 all로 설정하는 의미가 있다.
- 이 경우 ISR의 2개 이상의 파티션에 데이터가 정상 적재되었음을 확인한다는 뜻이다.
- ISR의 2개 이상의 파티션에 적재되었음을 확인한다는 뜻은 적어도 리더 파티션과 1개의 팔로워 파티션에 데이터가 정상적으로 적재되었음을 보장한다.
- 실제 카프카 클러스터를 운영하면서 브로커가 동시에 2개가 중단되는 일은 극히 드물기 때문에 리더 파티션과 팔로워 파티션 1개에 데이터가 적재되었다면 데이터는 유실되지 않는다고 볼 수 있다.
- acks는 프로듀서 옵션, min.insync.replicas는 토픽 옵션이라는 점을 기억하자.
