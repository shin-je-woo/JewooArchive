# ğŸ’¡ í”„ë¡œë“€ì„œ API êµ¬í˜„í•˜ê¸°

ë¨¼ì € build.gradleì— ì¹´í”„ì¹´ í´ë¼ì´ì–¸íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì¶”ê°€í•œë‹¤.

```
dependencies {
    //...
    implementation 'org.apache.kafka:kafka-clients:2.5.0'
}
```

ë‹¤ìŒì€ ê°„ë‹¨í•œ í”„ë¡œë“€ì„œ API ì‚¬ìš©ë²•ì´ë‹¤.

```java
public class SimpleProducer {
    private static final Logger logger = LoggerFactory.getLogger(SimpleProducer.class);
    private static final String TOPIC_NAME = "test";
    private static final String BOOTSTRAP_SERVERS = "my-kafka:9092";

    public static void main(String[] args) {
        // ì¹´í”„ì¹´ í”„ë¡œë“€ì„œ ì„¤ì •í•˜ê¸°
        // 3ê°€ì§€ í•„ìˆ˜ê°’ì€ ë°˜ë“œì‹œ í¬í•¨í•´ì•¼ í•¨. bootstrap.servers, key.serializer, value.serializer
        Properties configs = new Properties();
        configs.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, BOOTSTRAP_SERVERS);
        configs.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());
        configs.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());

        try (KafkaProducer<String, String> producer = new KafkaProducer<>(configs)) {
            // ê¸°ë³¸ ì „ì†¡
            ProducerRecord<String, String> record = new ProducerRecord<>(TOPIC_NAME, "jewooValue");
            producer.send(record);

            // ë©”ì‹œì§€ í‚¤ë¥¼ ì§€ì •í•˜ì—¬ ë ˆì½”ë“œ ì „ì†¡
            ProducerRecord<String, String> record2 = new ProducerRecord<>(TOPIC_NAME, "jewoo2", "jewooValue2"); // í‚¤ê°€ ìˆëŠ” ë ˆì½”ë“œ
            producer.send(record2);

            // íŒŒí‹°ì…˜ì„ ì§€ì •í•˜ì—¬ ë ˆì½”ë“œ ì „ì†¡
            int partitionNo = 0;
            ProducerRecord<String, String> record = new ProducerRecord<>(TOPIC_NAME, partitionNo, "jewoos3", "jewoosValue3"); // íŠ¹ì • íŒŒí‹°ì…˜ìœ¼ë¡œ ì „ì†¡í•˜ëŠ” ë ˆì½”ë“œ
            producer.send(record);
        }
    }
}
```

- ë©”ì‹œì§€ í‚¤ê°€ í¬í•¨ëœ ë ˆì½”ë“œë¥¼ ì „ì†¡í•˜ê³  ì‹¶ë‹¤ë©´ ProducerRecord ìƒì„± ì‹œ íŒŒë¼ë¯¸í„°ë¡œ ì¶”ê°€í•´ì•¼ í•œë‹¤.
- í† í”½ ì´ë¦„, ë©”ì‹œì§€ í‚¤, ë©”ì‹œì§€ ê°’ì„ ìˆœì„œëŒ€ë¡œ íŒŒë¼ë¯¸í„°ë¡œ ë„£ê³  ìƒì„±í–ˆì„ ê²½ìš° ë©”ì‹œì§€ í‚¤ê°€ ì§€ì •ëœë‹¤.
- íŒŒí‹°ì…˜ì„ ì§ì ‘ ì§€ì •í•˜ê³  ì‹¶ë‹¤ë©´ í† í”½ ì´ë¦„, íŒŒí‹°ì…˜ ë²ˆí˜¸, ë©”ì‹œì§€ í‚¤, ë©”ì‹œì§€ ê°’ì„ ìˆœì„œëŒ€ë¡œ íŒŒë¼ë¯¸í„°ë¡œ ë„£ê³  ë ˆì½”ë“œë¥¼ ìƒì„±í•˜ë©´ ëœë‹¤.
- íŒŒí‹°ì…˜ ë²ˆí˜¸ëŠ” í† í”½ì— ì¡´ì¬í•˜ëŠ” íŒŒí‹°ì…˜ ë²ˆí˜¸ë¡œ ì„¤ì •í•´ì•¼ í•œë‹¤.

# ğŸ’¡ ì»¤ìŠ¤í…€ íŒŒí‹°ì…”ë„ˆ

- í”„ë¡œë“€ì„œ ì‚¬ìš©í™˜ê²½ì— ë”°ë¼ íŠ¹ì • ë°ì´í„°ë¥¼ ê°€ì§€ëŠ” ë ˆì½”ë“œë¥¼ íŠ¹ì • íŒŒí‹°ì…˜ìœ¼ë¡œ ë³´ë‚´ì•¼ í•  ë•Œê°€ ìˆë‹¤.
- ì˜ˆë¥¼ ë“¤ì–´, jewooKeyë¼ëŠ” í‚¤ë¥¼ ê°€ì§„ ë©”ì‹œì§€ê°€ 0ë²ˆ íŒŒí‹°ì…˜ìœ¼ë¡œ ë“¤ì–´ê°€ì•¼ í•œë‹¤ê³  ê°€ì •í•˜ì.
- ê¸°ë³¸ ì„¤ì • íŒŒí‹°ì…”ë„ˆë¥¼ ì‚¬ìš©í•  ê²½ìš° ë©”ì‹œì§€ í‚¤ì˜ í•´ì‹œê°’ì„ íŒŒí‹°ì…˜ì— ë§¤ì¹­í•˜ì—¬ ë°ì´í„°ë¥¼ ì „ì†¡í•˜ë¯€ë¡œ ì–´ëŠ íŒŒí‹°ì…˜ì— ë“¤ì–´ê°ˆì§€ ì•Œ ìˆ˜ ì—†ë‹¤.
- ì´ ë•Œ, `Partitioner` ì¸í„°í˜ì´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ì ì •ì˜ íŒŒí‹°ì…”ë„ˆë¥¼ ìƒì„±í•˜ë©´ jewooKeyë¼ëŠ” í‚¤ë¥¼ ê°€ì§„ ë©”ì‹œì§€ì— ëŒ€í•´ì„œ ë¬´ì¡°ê±´ 0ë²ˆ íŒŒí‹°ì…˜ìœ¼ë¡œ ì§€ì •í•˜ë„ë¡ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.
- ì´ë ‡ê²Œ ì§€ì •í•  ê²½ìš° í† í”½ì˜ íŒŒí‹°ì…˜ ê°œìˆ˜ê°€ ë³€ê²½ë˜ë”ë¼ë„ jewooKeyë¼ëŠ” í‚¤ë¥¼ ê°€ì§„ ë©”ì‹œì§€ëŠ” íŒŒí‹°ì…˜ 0ë²ˆì— ì ì¬ëœë‹¤.

```java
public class CustomPartitioner implements Partitioner {

    @Override
    public int partition(String topic, Object key, byte[] keyBytes, Object value, byte[] valueBytes, Cluster cluster) {

        if (keyBytes == null) {
            throw new InvalidRecordException("Need message key");
        }

        // keyê°€ jewooKeyì¼ ê²½ìš° 0ë²ˆ íŒŒí‹°ì…˜ìœ¼ë¡œ ì „ì†¡
        if (key instanceof String && key.equals("jewooKey")) {
            return 0;
        }

        // ì•„ë‹ ê²½ìš° í•´ì‹œê°’ìœ¼ë¡œ íŒŒí‹°ì…˜ ê³„ì‚°
        List<PartitionInfo> partitions = cluster.partitionsForTopic(topic);
        int numPartitions = partitions.size();
        return Utils.toPositive(Utils.murmur2(keyBytes)) % numPartitions;
    }

    @Override
    public void close() {

    }

    @Override
    public void configure(Map<String, ?> configs) {

    }
}
```

```java
public class ProducerWithCustomPartitioner {
    private final static String TOPIC_NAME = "test";
    private final static String BOOTSTRAP_SERVERS = "my-kafka:9092";

    public static void main(String[] args) {
        Properties configs = new Properties();
        configs.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, BOOTSTRAP_SERVERS);
        configs.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());
        configs.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());
        configs.put(ProducerConfig.PARTITIONER_CLASS_CONFIG, CustomPartitioner.class.getName()); // ì»¤ìŠ¤í…€ íŒŒí‹°ì…”ë„ˆ ì„¤ì •

        try (KafkaProducer<String, String> producer = new KafkaProducer<>(configs)) {
            ProducerRecord<String, String> record = new ProducerRecord<>(TOPIC_NAME, "jewooKey", "jewooValue");
            producer.send(record);
        }
    }
}
```

# ğŸ’¡ ë ˆì½”ë“œ ì „ì†¡ ê²°ê³¼ í™•ì¸í•˜ê¸°

- ì§€ê¸ˆê¹Œì§€ ì‘ì„±í•œ ì½”ë“œëŠ” í”„ë¡œë“€ì„œê°€ ë¸Œë¡œì»¤ë¡œ ë©”ì‹œì§€ë¥¼ ë³´ë‚¸ í›„ ì„±ê³µì ìœ¼ë¡œ ë„ì°©í–ˆëŠ”ì§€ê¹Œì§€ëŠ” í™•ì¸í•˜ì§€ ì•ŠëŠ” í”„ë¡œë“€ì„œì˜ ì½”ë“œì´ë‹¤.
- ë¸Œë¡œì»¤ê°€ ì‚´ì•„ìˆë‹¤ë©´ í”„ë¡œë“€ì„œëŠ” ë©”ì‹œì§€ ì „ì†¡ì— ì‹¤íŒ¨í•˜ë”ë¼ë„ ìë™ìœ¼ë¡œ ì¬ì „ì†¡í•˜ê¸° ë•Œë¬¸ì— ëŒ€ë¶€ë¶„ì˜ ê²½ìš° ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì§€ë§Œ, ì¼ë¶€ ë©”ì‹œì§€ê°€ ì†ì‹¤ë  ìˆ˜ë„ ìˆë‹¤.
- ë”°ë¼ì„œ, ì ì ˆí•˜ê²Œ ê²°ê³¼ë¥¼ í™•ì¸í•˜ëŠ” ì½”ë“œê°€ í•„ìš”í•˜ë‹¤.

## ë™ê¸° ë°©ì‹

- KafkaProducerì˜ send() ë©”ì„œë“œëŠ” Futureê°ì²´ë¥¼ ë°˜í™˜í•œë‹¤.
- ì´ ê°ì²´ëŠ” RecordMetadataì˜ ë¹„ë™ê¸° ê²°ê³¼ë¥¼ í‘œí˜„í•˜ëŠ” ê²ƒìœ¼ë¡œ ProducerRecordê°€ ì¹´í”„ì¹´ ë¸Œë¡œì»¤ì— ì •ìƒì ìœ¼ë¡œ ì ì¬ë˜ì—ˆëŠ”ì§€ì— ëŒ€í•œ ë°ì´í„°ê°€ í¬í•¨ë˜ì–´ ìˆë‹¤.
- ë‹¤ìŒ ì½”ë“œì™€ ê°™ì´ get() ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ë©´ í”„ë¡œë“€ì„œë¡œ ë³´ë‚¸ ë°ì´í„°ì˜ ê²°ê³¼ë¥¼ ë™ê¸°ì ìœ¼ë¡œ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë‹¤.

```java
public class ProducerWithSyncCallback {
    private final static Logger logger = LoggerFactory.getLogger(ProducerWithSyncCallback.class);
    private final static String TOPIC_NAME = "test";
    private final static String BOOTSTRAP_SERVERS = "my-kafka:9092";

    public static void main(String[] args) {
        Properties configs = new Properties();
        configs.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, BOOTSTRAP_SERVERS);
        configs.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());
        configs.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());

        try (KafkaProducer<String, String> producer = new KafkaProducer<>(configs)) {
            ProducerRecord<String, String> record = new ProducerRecord<>(TOPIC_NAME, "jewoo", "jewoosValue");
            Future<RecordMetadata> future = producer.send(record);
            RecordMetadata metadata = future.get(); // ë™ê¸°ì ìœ¼ë¡œ ê²°ê³¼ í™•ì¸í•˜ê¸°
            logger.info("Partition={}, Offset={}", metadata.partition(), metadata.offset());
        } catch (Exception e) {
            logger.error(e.getMessage(), e);
        }
    }
}
```

![image](https://github.com/user-attachments/assets/c46b2f35-bbda-4cab-96d0-b1955d723c4c)

## ë¹„ë™ê¸° ë°©ì‹

- ì•ì˜ ë™ê¸° ë°©ì‹ìœ¼ë¡œ ê²°ê³¼ë¥¼ í™•ì¸ í•  ê²½ìš°, í”„ë¡œë“€ì„œê°€ ë³´ë‚¸ ëª¨ë“  ë©”ì‹œì§€ì— ëŒ€í•´ ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ë©° ìŠ¤ë ˆë“œë“¤ì´ ì •ì§€í•œë‹¤ë©´ íš¨ìœ¨ì„±ì´ ë–¨ì–´ì§€ê²Œ ëœë‹¤.
- í•˜ì§€ë§Œ ë¹„ë™ê¸°ì ìœ¼ë¡œ ê²°ê³¼ë¥¼ í™•ì¸í•˜ê²Œ ëœë‹¤ë©´ ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ì§€ ì•Šê³  ë°”ë¡œ ë‹¤ìŒ ì¼ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ë”ìš± íš¨ìœ¨ì ì´ë‹¤.
- ì•„ë˜ì˜ ì½”ë“œì—ì„œ í”„ë¡œë“€ì„œëŠ” send() ë©”ì„œë“œì— ì½œë°±ê³¼ ê°™ì´ í˜¸ì¶œí•˜ê³  ì¹´í”„ì¹´ ë¸Œë¡œì»¤ì—ì„œ ì‘ë‹µì„ ë°›ìœ¼ë©´ ì½œë°±ëœë‹¤.

```java
//...
import org.apache.kafka.clients.producer.Callback;

public class ProducerCallback implements Callback {
    private final static Logger logger = LoggerFactory.getLogger(ProducerCallback.class);

    @Override
    public void onCompletion(RecordMetadata metadata, Exception exception) {
        if (exception != null) {
            logger.error(exception.getMessage(), exception);
        } else {
            logger.info("Partition={}, Offset={}", metadata.partition(), metadata.offset());
        }
    }
}
```

```java
public class ProducerWithAsyncCallback {
    private final static String TOPIC_NAME = "test";
    private final static String BOOTSTRAP_SERVERS = "my-kafka:9092";

    public static void main(String[] args) {
        Properties configs = new Properties();
        configs.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, BOOTSTRAP_SERVERS);
        configs.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());
        configs.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());

        try (KafkaProducer<String, String> producer = new KafkaProducer<>(configs)) {
            ProducerRecord<String, String> record = new ProducerRecord<>(TOPIC_NAME, "jewoo", "jewooValue");
            producer.send(record, new ProducerCallback()); // send()ì— Callback ì§€ì •í•˜ê¸°
        }
    }
}
```

![image](https://github.com/user-attachments/assets/92d4bc4a-365b-482c-96af-7b100789a69a)

- ì‹¤í–‰ ê²°ê³¼ë¥¼ ë³´ë©´ ë™ê¸°ë°©ì‹ê³¼ ë‹¤ë¥´ê²Œ mainìŠ¤ë ˆë“œê°€ ì•„ë‹Œ íŠ¹ë³„í•œ ìŠ¤ë ˆë“œì—ì„œ ì½œë°±ì´ ìˆ˜í–‰ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
- ì˜ˆì œì—ì„œëŠ” ì˜ˆì™¸ ì²˜ë¦¬ë¥¼ ë‹¨ìˆœí•˜ê²Œ ë¡œê·¸ë¥¼ ì¶œë ¥í–ˆì§€ë§Œ, ì‹¤ì œ ìš´ì˜í™˜ê²½ì—ì„œëŠ” ì ì ˆí•˜ê²Œ ì˜ˆì™¸ì²˜ë¦¬ê°€ í•„ìš”í•˜ë‹¤.
