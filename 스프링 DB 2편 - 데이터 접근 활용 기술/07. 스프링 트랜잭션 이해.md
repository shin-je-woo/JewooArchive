# π’΅ νΈλμ­μ… μ μ© ν™•μΈ
`@Transactional` μ€ νΈλμ­μ… κ΄€λ ¨ μ½”λ“κ°€ λμ— λ³΄μ΄μ§€ μ•κ³ , AOPλ¥Ό κΈ°λ°μΌλ΅ λ™μ‘ν•κΈ° λ•λ¬Έμ— μ‹¤μ  νΈλμ­μ…μ μ μ©μ—¬λ¶€λ¥Ό ν™•μΈν•κΈ° μ–΄λ µλ‹¤.
```java
@Slf4j
@SpringBootTest
public class TxBasicTest {

    @Autowired
    BasicService basicService;

    @Test
    void proxyCheck() {
        //BasicService$$EnhancerBySpringCGLIB...
        log.info("aop class = {}", basicService.getClass());
        assertThat(AopUtils.isAopProxy(basicService)).isTrue();
    }

    @Test
    void txTest() {
        basicService.tx();
        basicService.nonTx();
    }

    @TestConfiguration
    static class txApplyBasicConfig {
        @Bean
        BasicService basicService() {
            return new BasicService(); // @Transactionalμ΄ μ„ μ–Έλμ–΄ μμΌλ―€λ΅ ν”„λ΅μ‹ κ°μ²΄κ°€ BeanμΌλ΅ λ“±λ΅λλ‹¤.
        }
    }

    @Slf4j
    static class BasicService {

        @Transactional
        public void tx() {
            log.info("call tx");
            boolean txActive = TransactionSynchronizationManager.isActualTransactionActive();
            log.info("tx active = {}", txActive);
            // tx active=true
        }

        public void nonTx() {
            log.info("call nonTx");
            boolean txActive = TransactionSynchronizationManager.isActualTransactionActive();
            log.info("tx active = {}", txActive);
            // tx active=false
        }
    }
}
```

### `AopUtils.isAopProxy()`
* `@Transactional` μ„ λ©”μ„λ“λ‚ ν΄λμ¤μ— λ¶™μ΄λ©΄ ν•΄λ‹Ή κ°μ²΄λ” νΈλμ­μ… AOP μ μ© λ€μƒμ΄ λλ‹¤.
* μ‹¤μ  κ°μ²΄ λ€μ‹ μ— νΈλμ­μ…μ„ μ²λ¦¬ν•΄μ£Όλ” ν”„λ΅μ‹ κ°μ²΄κ°€ μ¤ν”„λ§ λΉμ— λ“±λ΅λλ‹¤. 
* κ·Έλ¦¬κ³  μ£Όμ…μ„ λ°›μ„ λ•λ„ μ‹¤μ  κ°μ²΄ λ€μ‹ μ— ν”„λ΅μ‹ κ°μ²΄κ°€ μ£Όμ…λλ‹¤.

### `basicService.tx()` νΈμ¶
* ν΄λΌμ΄μ–ΈνΈκ°€ `basicService.tx()` λ¥Ό νΈμ¶ν•λ©΄, ν”„λ΅μ‹μ `tx()` κ°€ νΈμ¶λλ‹¤. 
* μ—¬κΈ°μ„ ν”„λ΅μ‹λ” `tx()` λ©”μ„λ“κ°€ νΈλμ­μ…μ„ μ‚¬μ©ν•  μ μλ”μ§€ ν™•μΈν•΄λ³Έλ‹¤. 
* `tx()` λ©”μ„λ“μ—λ” `@Transactional` μ΄ λ¶™μ–΄ μμΌλ―€λ΅ νΈλμ­μ… μ μ© λ€μƒμ΄λ‹¤.
* λ”°λΌμ„ νΈλμ­μ…μ„ μ‹μ‘ν• λ‹¤μμ— μ‹¤μ  `basicService.tx()` λ¥Ό νΈμ¶ν•λ‹¤.
* κ·Έλ¦¬κ³  μ‹¤μ  `basicService.tx()` μ νΈμ¶μ΄ λλ‚μ„ ν”„λ΅μ‹λ΅ μ μ–΄κ°€ λμ•„μ¤λ©΄ ν”„λ΅μ‹λ” νΈλμ­μ… λ΅μ§μ„ μ»¤λ°‹ν•κ±°λ‚ λ΅¤λ°±ν•΄μ„ νΈλμ­μ…μ„ μΆ…λ£ν•λ‹¤.

### `basicService.nonTx()` νΈμ¶
* ν΄λΌμ΄μ–ΈνΈκ°€ `basicService.nonTx()` λ¥Ό νΈμ¶ν•λ©΄, νΈλμ­μ… ν”„λ΅μ‹μ `nonTx()` κ°€ νΈμ¶λλ‹¤.
* μ—¬κΈ°μ„ `nonTx()` λ©”μ„λ“κ°€ νΈλμ­μ…μ„ μ‚¬μ©ν•  μ μλ”μ§€ ν™•μΈν•΄λ³Έλ‹¤. 
* `nonTx()` μ—λ” `@Transactional` μ΄ μ—†μΌλ―€λ΅ μ μ© λ€μƒμ΄ μ•„λ‹λ‹¤.
* λ”°λΌμ„ νΈλμ­μ…μ„ μ‹μ‘ν•μ§€ μ•κ³ , `basicService.nonTx()` λ¥Ό νΈμ¶ν•κ³  μΆ…λ£ν•λ‹¤.

### `TransactionSynchronizationManager.isActualTransactionActive()`
* ν„μ¬ μ“°λ λ“μ— νΈλμ­μ…μ΄ μ μ©λμ–΄ μλ”μ§€ ν™•μΈν•  μ μλ” κΈ°λ¥μ΄λ‹¤. 
* κ²°κ³Όκ°€ true μ΄λ©΄ νΈλμ­μ…μ΄ μ μ©λμ–΄ μλ” κ²ƒμ΄λ‹¤. νΈλμ­μ…μ μ μ© μ—¬λ¶€λ¥Ό κ°€μ¥ ν™•μ‹¤ν•κ² ν™•μΈν•  μ μλ‹¤.

## νΈλμ­μ… AOP ν”„λ΅μ‹
![image](https://github.com/shin-je-woo/TIL/assets/39439576/868a0304-6687-494e-824b-0fcf6e511abf)
* `@Transactional` μ• λ…Έν…μ΄μ…μ΄ νΉμ • ν΄λμ¤λ‚ λ©”μ„λ“μ— ν•λ‚λΌλ„ μμΌλ©΄ μμΌλ©΄ νΈλμ­μ… AOPλ” ν”„λ΅μ‹λ¥Ό λ§λ“¤μ–΄μ„ μ¤ν”„λ§ μ»¨ν…μ΄λ„μ— λ“±λ΅ν•λ‹¤. 
* ν”„λ΅μ‹λ” λ‚΄λ¶€μ— μ‹¤μ  κ°μ²΄λ¥Ό μ°Έμ΅°ν•κ² λλ‹¤. 
* μ—¬κΈ°μ„ ν•µμ‹¬μ€ μ‹¤μ  κ°μ²΄ λ€μ‹ μ— ν”„λ΅μ‹κ°€ μ¤ν”„λ§ μ»¨ν…μ΄λ„μ— λ“±λ΅λμ—λ‹¤λ” μ μ΄λ‹¤.
* μ¤ν”„λ§ μ»¨ν…μ΄λ„μ—λ” μ‹¤μ  κ°μ²΄ λ€μ‹ μ— ν”„λ΅μ‹κ°€ μ¤ν”„λ§ λΉμΌλ΅ λ“±λ΅λμ–΄ μκΈ° λ•λ¬Έμ— ν”„λ΅μ‹λ¥Ό μμ΅΄κ΄€κ³„ μ£Όμ…ν•λ‹¤.
* ν”„λ΅μ‹λ” μ‹¤μ  κ°μ²΄λ¥Ό μƒμ†ν•΄μ„ λ§λ“¤μ–΄μ§€κΈ° λ•λ¬Έμ— λ‹¤ν•μ„±μ„ ν™μ©ν•  μ μλ‹¤.

# π’΅ νΈλμ­μ… μ μ© μ„μΉ
### μ°μ„ μμ„, ν΄λμ¤μ— μ μ©ν•λ©΄ λ©”μ„λ“λ” μλ™ μ μ©
* μ¤ν”„λ§μ—μ„ μ°μ„ μμ„λ” ν•­μƒ λ” κµ¬μ²΄μ μ΄κ³  μμ„Έν• κ²ƒμ΄ λ†’μ€ μ°μ„ μμ„λ¥Ό κ°€μ§„λ‹¤. 
* μ΄κ²ƒλ§ κΈ°μ–µν•λ©΄ μ¤ν”„λ§μ—μ„ λ°μƒν•λ” λ€λ¶€λ¶„μ μ°μ„ μμ„λ¥Ό μ‰½κ² κΈ°μ–µν•  μ μλ‹¤.
* μλ¥Ό λ“¤μ–΄μ„ λ©”μ„λ“μ™€ ν΄λμ¤μ— μ• λ…Έν…μ΄μ…μ„ λ¶™μΌ μ μλ‹¤λ©΄ λ” κµ¬μ²΄μ μΈ λ©”μ„λ“κ°€ λ” λ†’μ€ μ°μ„ μμ„λ¥Ό κ°€μ§„λ‹¤.
1. ν΄λμ¤μ λ©”μ„λ“ (μ°μ„ μμ„κ°€ κ°€μ¥ λ†’λ‹¤.)
2. ν΄λμ¤μ νƒ€μ…
3. μΈν„°νμ΄μ¤μ λ©”μ„λ“
4. μΈν„°νμ΄μ¤μ νƒ€μ… (μ°μ„ μμ„κ°€ κ°€μ¥ λ‚®λ‹¤.)
* AOPλ¥Ό μ μ©ν•λ” λ°©μ‹μ— λ”°λΌμ„ μΈν„°νμ΄μ¤μ— μ• λ…Έν…μ΄μ…μ„ λ‘λ©΄ AOPκ°€ μ μ©μ΄ λμ§€ μ•λ” κ²½μ°λ„ μκΈ° λ•λ¬Έμ— κ°€κΈ‰μ  κµ¬μ²΄ ν΄λμ¤μ— `@Transactional` μ„ μ‚¬μ©ν•μ.

# π’΅ public λ©”μ„λ“λ§ νΈλμ­μ… μ μ©
* μ¤ν”„λ§μ νΈλμ­μ… AOP κΈ°λ¥μ€ public λ©”μ„λ“μ—λ§ νΈλμ­μ…μ„ μ μ©ν•λ„λ΅ κΈ°λ³Έ μ„¤μ • λμ–΄μλ‹¤.
* κ·Έλμ„ `protected` , `private` , `package-visible` μ—λ” νΈλμ­μ…μ΄ μ μ©λμ§€ μ•λ”λ‹¤.
* ν΄λμ¤ λ λ²¨μ— νΈλμ­μ…μ„ μ μ©ν•λ©΄ λ¨λ“  λ©”μ„λ“μ— νΈλμ­μ…μ΄ κ±Έλ¦΄ μ μλ‹¤. 
* κ·Έλ¬λ©΄ νΈλμ­μ…μ„ μλ„ν•μ§€ μ•μ€ λ©”μ„λ“κΉμ§€ νΈλμ­μ…μ΄ μ μ©λ  μ μλ‹¤.
* νΈλμ­μ…μ€ μ£Όλ΅ λΉ„μ¦λ‹μ¤ λ΅μ§μ μ‹μ‘μ μ— κ±ΈκΈ° λ•λ¬Έμ— μ™Έλ¶€μ— μ—΄μ–΄μ¤€ κ³³μ„ μ‹μ‘μ μΌλ΅ μ‚¬μ©ν•λ‹¤. 
* μ΄λ° μ΄μ λ΅ `public` λ©”μ„λ“μ—λ§ νΈλμ­μ…μ„ μ μ©ν•λ„λ΅ μ„¤μ •λμ–΄ μλ‹¤.
* μ°Έκ³ λ΅ `public` μ΄ μ•„λ‹ λ©”μ„λ“μ— `@Transactional` μ΄ λ¶™μ–΄ μμΌλ©΄ μμ™Έκ°€ λ°μƒν•μ§€λ” μ•κ³ , νΈλμ­μ… μ μ©λ§ λ¬΄μ‹λλ‹¤.
