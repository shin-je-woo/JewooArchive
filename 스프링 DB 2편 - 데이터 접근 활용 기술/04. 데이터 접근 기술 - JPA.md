# ğŸ’¡ JPA - ORM
* ìŠ¤í”„ë§ì´ DI ì»¨í…Œì´ë„ˆë¥¼ í¬í•¨í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì „ë°˜ì˜ ë‹¤ì–‘í•œ ê¸°ëŠ¥ì„ ì œê³µí•œë‹¤ë©´, **JPAëŠ” ORM ë°ì´í„° ì ‘ê·¼ ê¸°ìˆ **ì„ ì œê³µí•œë‹¤.
* JdbcTemplateì´ë‚˜ MyBatis ê°™ì€ SQL ë§¤í¼ ê¸°ìˆ ì€ SQLì„ ê°œë°œìê°€ ì§ì ‘ ì‘ì„±í•´ì•¼ í•˜ì§€ë§Œ, JPAë¥¼ ì‚¬ìš©í•˜ë©´ SQLë„ JPAê°€ ëŒ€ì‹  ì‘ì„±í•˜ê³  ì²˜ë¦¬í•´ì¤€ë‹¤.
* ì‹¤ë¬´ì—ì„œëŠ” JPAë¥¼ ë”ìš± í¸ë¦¬í•˜ê²Œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ìŠ¤í”„ë§ ë°ì´í„° JPAì™€ Querydslì´ë¼ëŠ” ê¸°ìˆ ì„ í•¨ê»˜ ì‚¬ìš©í•œë‹¤.

### Object-relational mapping(ê°ì²´ ê´€ê³„ ë§¤í•‘)
* ê°ì²´ëŠ” ê°ì²´ëŒ€ë¡œ ì„¤ê³„
* ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤ëŠ” ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤ëŒ€ë¡œ ì„¤ê³„
* ORM í”„ë ˆì„ì›Œí¬ê°€ ì¤‘ê°„ì—ì„œ ë§¤í•‘

# ğŸ’¡ JPA ì ìš©
* JPAì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ ë¶€ë¶„ì€ ê°ì²´ì™€ í…Œì´ë¸”ì„ ë§¤í•‘í•˜ëŠ” ê²ƒì´ë‹¤.
* JPAê°€ ì œê³µí•˜ëŠ” ì• ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•´ì„œ Item ê°ì²´ì™€ í…Œì´ë¸”ì„ ë§¤í•‘í•´ë³´ì.

â–¶ï¸ Item ì—”í‹°í‹°
```java
@Data
@Entity
public class Item {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(name = "item_name", length = 10) // ìƒëµê°€ëŠ¥
    private String itemName;
    private Integer price;
    private Integer quantity;

    public Item() {
    }

    public Item(String itemName, Integer price, Integer quantity) {
        this.itemName = itemName;
        this.price = price;
        this.quantity = quantity;
    }
}
```
* `@Entity` : JPAê°€ ì‚¬ìš©í•˜ëŠ” ê°ì²´ë¼ëŠ” ëœ»ì´ë‹¤. ì´ ì—ë…¸í…Œì´ì…˜ì´ ìˆì–´ì•¼ JPAê°€ ì¸ì‹í•  ìˆ˜ ìˆë‹¤.
* `@Id` : í…Œì´ë¸”ì˜ PKì™€ í•´ë‹¹ í•„ë“œë¥¼ ë§¤í•‘í•œë‹¤.
* `@GeneratedValue(strategy = GenerationType.IDENTITY)` : PK ìƒì„± ê°’ì„ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ìƒì„±í•˜ëŠ” IDENTITY ë°©ì‹ì„ ì‚¬ìš©í•œë‹¤. ì˜ˆ) MySQL auto increment
* `@Column` : ê°ì²´ì˜ í•„ë“œë¥¼ í…Œì´ë¸”ì˜ ì»¬ëŸ¼ê³¼ ë§¤í•‘í•œë‹¤.
* JPAëŠ” public ë˜ëŠ” protected ì˜ ê¸°ë³¸ ìƒì„±ìê°€ í•„ìˆ˜ì´ë‹¤.

â–¶ï¸ ë¦¬í¬ì§€í† ë¦¬ ì½”ë“œ
```java
@Slf4j
@Repository
@Transactional
public class JpaItemRepositoryV1 implements ItemRepository {

    private final EntityManager em;

    public JpaItemRepositoryV1(EntityManager em) {
        this.em = em;
    }

    @Override
    public Item save(Item item) {
        em.persist(item);
        return item;
    }

    @Override
    public void update(Long itemId, ItemUpdateDto updateParam) {
        Item findItem = em.find(Item.class, itemId);
        findItem.setItemName(updateParam.getItemName());
        findItem.setPrice(updateParam.getPrice());
        findItem.setQuantity(updateParam.getQuantity());
    }

    @Override
    public Optional<Item> findById(Long id) {
        Item item = em.find(Item.class, id);
        return Optional.ofNullable(item);
    }

    @Override
    public List<Item> findAll(ItemSearchCond cond) {
        String jpql = "select i from Item i";
        //ë™ì  ì¿¼ë¦¬ ìƒëµ
        TypedQuery<Item> query = em.createQuery(jpql, Item.class);
        return query.getResultList();
    }
}
```
#### `private final EntityManager em`
* ìŠ¤í”„ë§ì„ í†µí•´ ì—”í‹°í‹° ë§¤ë‹ˆì €( `EntityManager` ) ë¥¼ ì£¼ì…ë°›ì€ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
* JPAì˜ ëª¨ë“  ë™ì‘ì€ ì—”í‹°í‹° ë§¤ë‹ˆì €ë¥¼ í†µí•´ì„œ ì´ë£¨ì–´ì§„ë‹¤. 
* ì—”í‹°í‹° ë§¤ë‹ˆì €ëŠ” ë‚´ë¶€ì— ë°ì´í„°ì†ŒìŠ¤ë¥¼ ê°€ì§€ê³  ìˆê³ , ë°ì´í„°ë² ì´ìŠ¤ì— ì ‘ê·¼í•  ìˆ˜ ìˆë‹¤.

#### `@Transactional`
* JPAì˜ ëª¨ë“  ë°ì´í„° ë³€ê²½(ë“±ë¡, ìˆ˜ì •, ì‚­ì œ)ì€ íŠ¸ëœì­ì…˜ ì•ˆì—ì„œ ì´ë£¨ì–´ì ¸ì•¼ í•œë‹¤.
* ì˜ˆì œì—ì„œëŠ” ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ì—†ì–´ì„œ ì„œë¹„ìŠ¤ ê³„ì¸µì—ì„œ íŠ¸ëœì­ì…˜ì„ ê±¸ì§€ ì•Šê³  ë¦¬í¬ì§€í† ë¦¬ì— ê±¸ì—ˆë‹¤.
* ì¼ë°˜ì ìœ¼ë¡œëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì‹œì‘í•˜ëŠ” ì„œë¹„ìŠ¤ ê³„ì¸µì— íŠ¸ëœì­ì…˜ì„ ê±¸ì–´ì£¼ëŠ” ê²ƒì´ ë§ë‹¤.

# ğŸ’¡ ë¦¬í¬ì§€í† ë¦¬ ë¶„ì„
## save() - ì €ì¥
* `em.persist(item)` : JPAì—ì„œ ê°ì²´ë¥¼ í…Œì´ë¸”ì— ì €ì¥í•  ë•ŒëŠ” ì—”í‹°í‹° ë§¤ë‹ˆì €ê°€ ì œê³µí•˜ëŠ” `persist()` ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ë©´ ëœë‹¤.
```sql
insert into item (item_name, price, quantity) values (?, ?, ?)
```
* JPAê°€ ë§Œë“¤ì–´ì„œ ì‹¤í–‰í•œ SQLì„ ë³´ë©´ id ì— ê°’ì´ ë¹ ì ¸ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
* PK ìƒì„±ì „ëµì„ `IDENTITY` ë¡œ ì„¤ì •í–ˆê¸° ë•Œë¬¸ì´ë‹¤.
* ì¿¼ë¦¬ ì‹¤í–‰ ì´í›„ ê°ì²´ì˜ id í•„ë“œì— DBê°€ ìƒì„±í•œ PK ê°’ì´ ë“¤ì–´ê°€ê²Œ ëœë‹¤. (JPAê°€ INSERT SQL ì‹¤í–‰ ì´í›„ì— ìƒì„±ëœ ID ê²°ê³¼ë¥¼ ë„£ì–´ì¤€ë‹¤.)

## update() - ìˆ˜ì •
```sql
update item set item_name=?, price=?, quantity=? where id=?
```
* `em.update()` ê°™ì€ ë©”ì„œë“œë¥¼ ì „í˜€ í˜¸ì¶œí•˜ì§€ ì•Šì•˜ë‹¤. ê·¸ëŸ°ë° ì–´ë–»ê²Œ UPDATE SQLì´ ì‹¤í–‰ë˜ëŠ” ê²ƒì¼ê¹Œ?
* JPAëŠ” íŠ¸ëœì­ì…˜ì´ ì»¤ë°‹ë˜ëŠ” ì‹œì ì— ë³€ê²½ëœ ì—”í‹°í‹° ê°ì²´ê°€ ìˆëŠ”ì§€ í™•ì¸í•œë‹¤. íŠ¹ì • ì—”í‹°í‹° ê°ì²´ê°€ ë³€ê²½ëœ ê²½ìš°ì—ëŠ” UPDATE SQLì„ ì‹¤í–‰í•œë‹¤.

## findById() - ë‹¨ê±´ ì¡°íšŒ
* JPAì—ì„œ ì—”í‹°í‹° ê°ì²´ë¥¼ PKë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¡°íšŒí•  ë•ŒëŠ” `find()` ë¥¼ ì‚¬ìš©í•˜ê³  íŒŒë¼ë¯¸í„°ë¡œ ì¡°íšŒ íƒ€ì…ê³¼ PK ê°’ì„ ì£¼ë©´ ëœë‹¤.
* ê·¸ëŸ¬ë©´ JPAê°€ ì¡°íšŒ SQLì„ ë§Œë“¤ì–´ì„œ ì‹¤í–‰í•˜ê³ , ê²°ê³¼ë¥¼ ê°ì²´ë¡œ ë°”ë¡œ ë³€í™˜í•´ì¤€ë‹¤.

## findAll() , JPQL ì‚¬ìš© - ëª©ë¡ ì¡°íšŒ
* JPAëŠ” **JPQL(Java Persistence Query Language)**ì´ë¼ëŠ” ê°ì²´ì§€í–¥ ì¿¼ë¦¬ ì–¸ì–´ë¥¼ ì œê³µí•œë‹¤.
* ì£¼ë¡œ ì—¬ëŸ¬ ë°ì´í„°ë¥¼ ë³µì¡í•œ ì¡°ê±´ìœ¼ë¡œ ì¡°íšŒí•  ë•Œ ì‚¬ìš©í•œë‹¤.
* SQLì´ í…Œì´ë¸”ì„ ëŒ€ìƒìœ¼ë¡œ í•œë‹¤ë©´, JPQLì€ ì—”í‹°í‹° ê°ì²´ë¥¼ ëŒ€ìƒìœ¼ë¡œ SQLì„ ì‹¤í–‰í•œë‹¤ ìƒê°í•˜ë©´ ëœë‹¤.
* JPQLì„ ì‹¤í–‰í•˜ë©´ ê·¸ ì•ˆì— í¬í•¨ëœ ì—”í‹°í‹° ê°ì²´ì˜ ë§¤í•‘ ì •ë³´ë¥¼ í™œìš©í•´ì„œ SQLì„ ë§Œë“¤ê²Œ ëœë‹¤.

> JPAë¥¼ ì‚¬ìš©í•´ë„ ë™ì  ì¿¼ë¦¬ ë¬¸ì œê°€ ë‚¨ì•„ìˆëŠ”ë°, Querydslì´ë¼ëŠ” ê¸°ìˆ ì„ í™œìš©í•˜ë©´ ê¹”ë”í•˜ê²Œ í•´ê²°í•  ìˆ˜ ìˆë‹¤.

# ğŸ’¡ JPA ì ìš©2 - ì˜ˆì™¸ ë³€í™˜
* `EntityManager` ëŠ” ìˆœìˆ˜í•œ JPA ê¸°ìˆ ì´ê³ , ìŠ¤í”„ë§ê³¼ëŠ” ê´€ê³„ê°€ ì—†ë‹¤. ë”°ë¼ì„œ ì—”í‹°í‹° ë§¤ë‹ˆì €ëŠ” ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ JPA ê´€ë ¨ ì˜ˆì™¸ë¥¼ ë°œìƒì‹œí‚¨ë‹¤.
* JPAëŠ” `PersistenceException` ê³¼ ê·¸ í•˜ìœ„ ì˜ˆì™¸ë¥¼ ë°œìƒì‹œí‚¨ë‹¤.
* JPA ì˜ˆì™¸ë¥¼ ìŠ¤í”„ë§ ì˜ˆì™¸ ì¶”ìƒí™”( `DataAccessException` )ë¡œ ë³€í™˜í•˜ë ¤ë©´ `@Repository` ê°€ í•„ìš”í•˜ë‹¤.

### ğŸ“Œ @Repositoryì˜ ê¸°ëŠ¥
* `@Repository` ê°€ ë¶™ì€ í´ë˜ìŠ¤ëŠ” ì»´í¬ë„ŒíŠ¸ ìŠ¤ìº”ì˜ ëŒ€ìƒì´ ëœë‹¤.
* `@Repository` ê°€ ë¶™ì€ í´ë˜ìŠ¤ëŠ” ì˜ˆì™¸ ë³€í™˜ AOPì˜ ì ìš© ëŒ€ìƒì´ ëœë‹¤.
* ìŠ¤í”„ë§ê³¼ JPAë¥¼ í•¨ê»˜ ì‚¬ìš©í•˜ëŠ” ê²½ìš° ìŠ¤í”„ë§ì€ JPA ì˜ˆì™¸ ë³€í™˜ê¸° ( `PersistenceExceptionTranslator` )ë¥¼ ë“±ë¡í•œë‹¤.
* ì˜ˆì™¸ ë³€í™˜ AOP í”„ë¡ì‹œëŠ” JPA ê´€ë ¨ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ JPA ì˜ˆì™¸ ë³€í™˜ê¸°ë¥¼ í†µí•´ ë°œìƒí•œ ì˜ˆì™¸ë¥¼ ìŠ¤í”„ë§ ë°ì´í„° ì ‘ê·¼ ì˜ˆì™¸ë¡œ ë³€í™˜í•œë‹¤.

![image](https://github.com/shin-je-woo/TIL/assets/39439576/e6ae2a63-6379-4b45-a095-de9eb796ec70)
* ê²°ê³¼ì ìœ¼ë¡œ ë¦¬í¬ì§€í† ë¦¬ì— `@Repository` ì• ë…¸í…Œì´ì…˜ë§Œ ìˆìœ¼ë©´ ìŠ¤í”„ë§ì´ ì˜ˆì™¸ ë³€í™˜ì„ ì²˜ë¦¬í•˜ëŠ” AOPë¥¼ ë§Œë“¤ì–´ì¤€ë‹¤.
