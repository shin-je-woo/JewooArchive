# 💡 예외와 트랜잭션 커밋, 롤백 - 기본
예외가 발생했는데, 내부에서 예외를 처리하지 못하고 트랜잭션 범위( `@Transactional이 적용된 AOP` ) 밖으로 예외를 던지면 어떻게 될까?
![image](https://github.com/shin-je-woo/TIL/assets/39439576/89175ec3-35c7-4f36-8b4c-8ae17447f088)
- 예외 발생시 스프링 트랜잭션 AOP는 예외의 종류에 따라 트랜잭션을 커밋하거나 롤백한다.
- 언체크 예외인 `RuntimeException` , `Error` 와 그 하위 예외가 발생하면 트랜잭션을 롤백한다.
- 체크 예외인 `Exception` 과 그 하위 예외가 발생하면 트랜잭션을 커밋한다.
- 물론 정상 응답(리턴)하면 트랜잭션을 커밋한다.

### ✅ rollbackFor 옵션
- 기본 정책에 추가로 어떤 예외가 발생할 때 롤백할 지 지정할 수 있다.
```java
@Transactional(rollbackFor = Exception.class)
```
- 체크 예외인 Exception 이 발생해도 커밋 대신 롤백된다.

# 💡 예외와 트랜잭션 커밋, 롤백 - 활용
- 스프링은 왜 체크 예외는 커밋하고, 언체크(런타임) 예외는 롤백할까?
- 스프링은 기본적으로 체크 예외는 비즈니스 의미가 있을 때 사용하고, 런타임(언체크) 예외는 복구 불가능한 예외로 가정한다.
- 참고로 이런 정책을 꼭 따를 필요는 없다. `rollbackFor` 옵션을 사용해서 체크 예외도 롤백해도 된다.

### 비즈니스 예외?
주문을 하는데 상황에 따라 다음과 같이 조치한다.
- **정상**: 주문시 결제를 성공하면 주문 데이터를 저장하고 결제 상태를 완료로 처리한다.
- **시스템 예외**: 주문시 내부에 복구 불가능한 예외가 발생하면 전체 데이터를 롤백한다.
- **비즈니스 예외**: 주문시 결제 잔고가 부족하면 주문 데이터를 저장하고, 결제 상태를 대기로 처리한다. 이 경우 고객에게 잔고 부족을 알리고 별도의 계좌로 입금하도록 안내한다.

이때 결제 잔고가 부족하면 `NotEnoughMoneyException` 이라는 체크 예외가 발생한다고 가정하자.  
이 예외는 시스템은 정상 동작했지만, 비즈니스 상황에서 문제가 되기 때문에 발생한 예외이다. 이런 예외를 비즈니스 예외라 한다.  
그리고 비즈니스 예외는 매우 중요하고, 반드시 처리해야 하는 경우가 많으므로 체크 예외를 고려할 수 있다.  
- 잔고 부족은 체크 예외가 발생하지만, 결제 상태를 대기 상태로 두고 `Order` 데이터는 커밋되기를 기대한다.
- `NotEnoughMoneyException` 은 시스템에 문제가 발생한 것이 아니라, 비즈니스 문제 상황을 예외를 통해 알려준다.
- 마치 예외가 리턴 값 처럼 사용된다. 따라서 이 경우 롤백하면 `Order` 자체가 사라지기 때문에 커밋해야한다.
- 물론, `rollbackFor` 옵션을 이용해 체크 예외도 롤백할 수 있다는 점을 기억하자. (비즈니스 요구사항에 따라 적절하게 사용하자)
