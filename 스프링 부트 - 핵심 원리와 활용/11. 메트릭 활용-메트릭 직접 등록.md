# Previous
- CPU ì‚¬ìš©ëŸ‰, ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰, í†°ìº£ ì“°ë ˆë“œ, DB ì»¤ë„¥ì…˜ í’€ê³¼ ê°™ì´ ê³µí†µìœ¼ë¡œ ì‚¬ìš©ë˜ëŠ” ê¸°ìˆ  ë©”íŠ¸ë¦­ì€ ì´ë¯¸ ë“±ë¡ë˜ì–´ ìžˆë‹¤.
- ë” ë‚˜ì•„ê°€ì„œ ë¹„ì¦ˆë‹ˆìŠ¤ì— íŠ¹í™”ëœ ë¶€ë¶„ì„ ëª¨ë‹ˆí„°ë§ í•˜ê³  ì‹¶ìœ¼ë©´ ì–´ë–»ê²Œ í•´ì•¼í• ê¹Œ?
- ì˜ˆë¥¼ ë“¤ì–´ì„œ ì£¼ë¬¸ìˆ˜, ì·¨ì†Œìˆ˜, ìž¬ê³  ìˆ˜ëŸ‰ ê°™ì€ ë©”íŠ¸ë¦­ë“¤ì´ ìžˆë‹¤.
- ì´ ë¶€ë¶„ì€ ê³µí†µìœ¼ë¡œ ë§Œë“¤ ìˆ˜ ìžˆëŠ” ë¶€ë¶„ì€ ì•„ë‹ˆê³ , ê°ê°ì˜ ë¹„ì¦ˆë‹ˆìŠ¤ì— íŠ¹í™”ëœ ë¶€ë¶„ë“¤ì´ë‹¤.
- ë¹„ì¦ˆë‹ˆìŠ¤ì— ê´€í•œ ë¶€ë¶„ì€ ê° ë¹„ì¦ˆë‹ˆìŠ¤ ë§ˆë‹¤ êµ¬í˜„ì´ ë‹¤ë¥´ë‹¤. ë”°ë¼ì„œ ë¹„ì¦ˆë‹ˆìŠ¤ ë©”íŠ¸ë¦­ì€ ì§ì ‘ ë“±ë¡í•˜ê³  í™•ì¸í•´ì•¼ í•œë‹¤.
- ì˜ˆì œë¥¼ í†µí•´ ë¹„ì¦ˆë‹ˆìŠ¤ì˜ ì‹¤ì‹œê°„ ì£¼ë¬¸ìˆ˜, ì·¨ì†Œìˆ˜, ì‹¤ì‹œê°„ ìž¬ê³  ìˆ˜ëŸ‰ì„ ë©”íŠ¸ë¦­ìœ¼ë¡œ ë“±ë¡í•˜ê³  í™•ì¸í•´ë³´ìž.
  - ê°ê°ì˜ ë©”íŠ¸ë¦­ì€ ë‹¤ìŒê³¼ ê°™ì´ ì •ì˜í•œë‹¤.
  - ì£¼ë¬¸ìˆ˜, ì·¨ì†Œìˆ˜ â†’ ê³„ì† ì¦ê°€í•˜ë¯€ë¡œ ì¹´ìš´í„°
  - ìž¬ê³  ìˆ˜ëŸ‰ â†’ ì¦ê°€í•˜ê±°ë‚˜ ê°ì†Œí•˜ë¯€ë¡œ ê²Œì´ì§€

### MeterRegistry
- ë§ˆì´í¬ë¡œë¯¸í„° ê¸°ëŠ¥ì„ ì œê³µí•˜ëŠ” í•µì‹¬ ì»´í¬ë„ŒíŠ¸

# ðŸ’¡ ì¹´ìš´í„° ë©”íŠ¸ë¦­ ë“±ë¡
- ë‹¨ì¡°ë¡­ê²Œ ì¦ê°€í•˜ëŠ” ë‹¨ì¼ ëˆ„ì  ì¸¡ì •í•­ëª©
  - ë‹¨ì¼ ê°’
  - ë³´í†µ í•˜ë‚˜ì”© ì¦ê°€
  - ëˆ„ì ì´ë¯€ë¡œ ì „ì²´ ê°’ì„ í¬í•¨(total)
  - í”„ë¡œë©”í…Œìš°ìŠ¤ì—ì„œëŠ” ì¼ë°˜ì ìœ¼ë¡œ ì¹´ìš´í„°ì˜ ì´ë¦„ ë§ˆì§€ë§‰ì— _total ì„ ë¶™ì—¬ì„œ my_order_total ê°™ì´ í‘œí˜„í•¨
- ê°’ì„ ì¦ê°€í•˜ê±°ë‚˜ 0ìœ¼ë¡œ ì´ˆê¸°í™” í•˜ëŠ” ê²ƒë§Œ ê°€ëŠ¥
- ë§ˆì´í¬ë¡œë¯¸í„°ì—ì„œ ê°’ì„ ê°ì†Œí•˜ëŠ” ê¸°ëŠ¥ë„ ì§€ì›í•˜ì§€ë§Œ, ëª©ì ì— ë§žì§€ ì•ŠìŒ
- ì˜ˆ) HTTP ìš”ì²­ìˆ˜

â–¶ï¸ OrderService
```java
@Slf4j
public class OrderServiceV1 implements OrderService {

    private final MeterRegistry registry;
    private AtomicInteger stock = new AtomicInteger(100);

    public OrderServiceV1(MeterRegistry registry) {
        this.registry = registry;
    }

    @Override
    public void order() {
        log.info("ì£¼ë¬¸");
        stock.decrementAndGet();

        Counter.builder("my.order")
                .tag("class", this.getClass().getName())
                .tag("method", "order")
                .description("order")
                .register(registry).increment();
    }

    @Override
    public void cancel() {
        log.info("ì·¨ì†Œ");
        stock.incrementAndGet();

        Counter.builder("my.order")
                .tag("class", this.getClass().getName())
                .tag("method", "cancel")
                .description("cancel")
                .register(registry).increment();
    }

    @Override
    public AtomicInteger getStock() {
        return stock;
    }
}
```
- `Counter.builder(name)` ë¥¼ í†µí•´ì„œ ì¹´ìš´í„°ë¥¼ ìƒì„±í•œë‹¤. `name` ì—ëŠ” ë©”íŠ¸ë¦­ ì´ë¦„ì„ ì§€ì •í•œë‹¤.
- `tag` ë¥¼ ì‚¬ìš©í–ˆëŠ”ë°, í”„ë¡œë©”í…Œìš°ìŠ¤ì—ì„œ í•„í„°í•  ìˆ˜ ìžˆëŠ” ë ˆì´ë¸”ë¡œ ì‚¬ìš©ëœë‹¤.
- ì£¼ë¬¸ê³¼ ì·¨ì†ŒëŠ” ë©”íŠ¸ë¦­ ì´ë¦„ì€ ê°™ê³  `tag` ë¡œ êµ¬ë¶„í•œë‹¤.
- `register(registry)` : ë§Œë“  ì¹´ìš´í„°ë¥¼ `MeterRegistry` ì— ë“±ë¡í•œë‹¤. ì´ë ‡ê²Œ ë“±ë¡í•´ì•¼ ì‹¤ì œ ë™ìž‘í•œë‹¤.
- `increment()` : ì¹´ìš´í„°ì˜ ê°’ì„ í•˜ë‚˜ ì¦ê°€í•œë‹¤.

â–¶ï¸ ì„¤ì • - ë¹ˆ ë“±ë¡
```java
@Configuration
public class OrderConfigV1 {

    @Bean
    OrderService orderService(MeterRegistry registry) {
        return new OrderServiceV1(registry);
    }
}
```
- ì´ë ‡ê²Œ ì„¤ì •í•˜ê³  ì• í”Œë¦¬ì¼€ì´ì…˜ìœ¼ë¡œ í•´ë‹¹ ê¸°ëŠ¥ë“¤ì„ ì‹¤í–‰í•˜ë©´ ë©”íŠ¸ë¦­ì´ ìƒì„±ëœë‹¤.

## ë©”íŠ¸ë¦­ í™•ì¸
â–¶ï¸ ì•¡ì¶”ì—ì´í„° ë©”íŠ¸ë¦­ í™•ì¸ - `http://localhost:8080/actuator/metrics/my.order`
![image](https://github.com/shin-je-woo/TIL/assets/39439576/306b2355-d3a2-4f26-9763-f44701f72c71)

â–¶ï¸ í”„ë¡œë©”í…Œìš°ìŠ¤ í¬ë§· ë§¤íŠ¸ë¦­ í™•ì¸ - `http://localhost:8080/actuator/prometheus`
![image](https://github.com/shin-je-woo/TIL/assets/39439576/7fd9c547-d1c4-4a65-b9da-dca08bdf41d7)

## ê·¸ë¼íŒŒë‚˜ì— ë“±ë¡
- PromQLì— ë‹¤ìŒê³¼ ê°™ì´ ë“±ë¡í•´ì„œ í™•ì¸í•´ë³´ìž.
- ì°¸ê³ ë¡œ ì¹´ìš´í„°ëŠ” ê³„ì†í•´ì„œ ì¦ê°€í•˜ëŠ” ê°’ì´ê¸° ë•Œë¬¸ì— íŠ¹ì • ì‹œê°„ì— ì–¼ë§ˆë‚˜ ì¦ê°€í–ˆëŠ”ì§€ í™•ì¸í•˜ë ¤ë©´ `increase()` , `rate()` ê°™ì€ í•¨ìˆ˜ì™€ í•¨ê»˜ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤.
- increase(my_order_total{method="order"}[1m])
- increase(my_order_total{method="cancel"}[1m])

![image](https://github.com/shin-je-woo/TIL/assets/39439576/a21cc09c-b7eb-45da-8ab5-a9c3c473a4bf)

# ðŸ’¡ ì¹´ìš´í„° ë©”íŠ¸ë¦­ ë“±ë¡ - @Counted
- ì•žì„œ ë³¸ ì½”ë“œëŠ” ë©”íŠ¸ë¦­ ê´€ë¦¬ ì½”ë“œê°€ í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ê³¼ ì„žì—¬ìžˆëŠ” ë¬¸ì œê°€ ìžˆë‹¤.
- ìŠ¤í”„ë§ AOPë¥¼ ì‚¬ìš©í•˜ë©´ ë©”íŠ¸ë¦­ ê´€ë¦¬ ì½”ë“œë¥¼ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ê³¼ ë¶„ë¦¬í•  ìˆ˜ ìžˆë‹¤.
- ë§ˆì´í¬ë¡œë¯¸í„°ëŠ” í•„ìš”í•œ AOP êµ¬ì„±ìš”ì†Œë¥¼ ì´ë¯¸ ë‹¤ ë§Œë“¤ì–´ë‘ì—ˆë‹¤.

â–¶ï¸ OrderService
```java
@Slf4j
public class OrderServiceV2 implements OrderService {

    private AtomicInteger stock = new AtomicInteger(100);

    @Counted("my.order")
    @Override
    public void order() {
        log.info("ì£¼ë¬¸");
        stock.decrementAndGet();
    }

    @Counted("my.order")
    @Override
    public void cancel() {
        log.info("ì·¨ì†Œ");
        stock.incrementAndGet();
    }

    @Override
    public AtomicInteger getStock() {
        return stock;
    }
}
```
- `@Counted` ì• ë…¸í…Œì´ì…˜ì„ ì¸¡ì •ì„ ì›í•˜ëŠ” ë©”ì„œë“œì— ì ìš©í•œë‹¤. ì£¼ë¬¸ê³¼ ì·¨ì†Œ ë©”ì„œë“œì— ì ìš©í–ˆë‹¤.
- ê·¸ë¦¬ê³  ë©”íŠ¸ë¦­ ì´ë¦„ì„ ì§€ì •í•˜ë©´ ëœë‹¤. ì—¬ê¸°ì„œëŠ” ì´ì „ê³¼ ê°™ì€ `my.order` ë¥¼ ì ìš©í–ˆë‹¤.
- ì°¸ê³ ë¡œ ì´ë ‡ê²Œ ì‚¬ìš©í•˜ë©´ `tag` ì— `method` ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë¶„ë¥˜í•´ì„œ ì ìš©í•œë‹¤.

â–¶ï¸ ì„¤ì • - ë¹ˆ ë“±ë¡
```java
@Configuration
public class OrderConfigV2 {

    @Bean
    public OrderService orderService() {
        return new OrderServiceV2();
    }

    @Bean
    public CountedAspect countedAspect(MeterRegistry registry) {
        return new CountedAspect(registry);
    }
}
```
- `CountedAspect` ë¥¼ ë“±ë¡í•˜ë©´ `@Counted` ë¥¼ ì¸ì§€í•´ì„œ `Counter` ë¥¼ ì‚¬ìš©í•˜ëŠ” AOPë¥¼ ì ìš©í•œë‹¤.
- ì£¼ì˜ â— `CountedAspect` ë¥¼ ë¹ˆìœ¼ë¡œ ë“±ë¡í•˜ì§€ ì•Šìœ¼ë©´ `@Counted` ê´€ë ¨ AOPê°€ ë™ìž‘í•˜ì§€ ì•ŠëŠ”ë‹¤. (`CountedAspect` í´ëž˜ìŠ¤ì— `@Aspect` ì• ë…¸í…Œì´ì…˜ì´ ìžˆë‹¤.)

# ðŸ’¡ ë©”íŠ¸ë¦­ ë“±ë¡ - @Timed
- TimerëŠ” ì¡°ê¸ˆ íŠ¹ë³„í•œ ë©”íŠ¸ë¦­ ì¸¡ì • ë„êµ¬ì¸ë°, ì‹œê°„ì„ ì¸¡ì •í•˜ëŠ”ë° ì‚¬ìš©ëœë‹¤.
- ì¹´ìš´í„°ì™€ ìœ ì‚¬í•œë°, Timer ë¥¼ ì‚¬ìš©í•˜ë©´ ì‹¤í–‰ ì‹œê°„ë„ í•¨ê»˜ ì¸¡ì •í•  ìˆ˜ ìžˆë‹¤.
- Timer ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ë‚´ìš©ì„ í•œë²ˆì— ì¸¡ì •í•´ì¤€ë‹¤.
  - `seconds_count` : ëˆ„ì  ì‹¤í–‰ ìˆ˜ - ì¹´ìš´í„°
  - `seconds_sum` : ì‹¤í–‰ ì‹œê°„ì˜ í•© - sum
  - `seconds_max` : ìµœëŒ€ ì‹¤í–‰ ì‹œê°„(ê°€ìž¥ ì˜¤ëž˜ê±¸ë¦° ì‹¤í–‰ ì‹œê°„) - ê²Œì´ì§€
    - ë‚´ë¶€ì— íƒ€ìž„ ìœˆë„ìš°ë¼ëŠ” ê°œë…ì´ ìžˆì–´ì„œ 1~3ë¶„ ë§ˆë‹¤ ìµœëŒ€ ì‹¤í–‰ ì‹œê°„ì´ ë‹¤ì‹œ ê³„ì‚°ëœë‹¤.
   
â–¶ï¸ OrderService
```java
@Slf4j
public class OrderServiceV4 implements OrderService {

    private AtomicInteger stock = new AtomicInteger(100);

    @Timed("my.order")
    @Override
    public void order() {
        log.info("ì£¼ë¬¸");
        stock.decrementAndGet();
        sleep(500);

    }

    @Timed("my.order")
    @Override
    public void cancel() {
        log.info("ì·¨ì†Œ");
        stock.incrementAndGet();
        sleep(200);
    }

    @Override
    public AtomicInteger getStock() {
        return stock;
    }

    private void sleep(int sleepms) {
        try {
            Thread.sleep(sleepms + new Random().nextInt(200));
        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        }
    }
}
```

â–¶ï¸ ì„¤ì • - ë¹ˆ ë“±ë¡
```java
@Configuration
public class OrderConfigV4 {

    @Bean
    public OrderService orderService() {
        return new OrderServiceV4();
    }

    @Bean
    public TimedAspect timedAspect(MeterRegistry registry) {
        return new TimedAspect(registry);
    }
}
```
- `TimedAspect` ë¥¼ ë¹ˆìœ¼ë¡œ ë“±ë¡í•´ì•¼ `@Timed` ì— AOPê°€ ì ìš©ëœë‹¤.

## ë©”íŠ¸ë¦­ í™•ì¸
â–¶ï¸ ì•¡ì¶”ì—ì´í„° ë©”íŠ¸ë¦­ í™•ì¸ - `http://localhost:8080/actuator/metrics/my.order`
![image](https://github.com/shin-je-woo/TIL/assets/39439576/edc9da9a-84a5-42fd-a0bd-f662672561b4)

â–¶ï¸ í”„ë¡œë©”í…Œìš°ìŠ¤ í¬ë§· ë§¤íŠ¸ë¦­ í™•ì¸ - `http://localhost:8080/actuator/prometheus`
![image](https://github.com/shin-je-woo/TIL/assets/39439576/823523cb-8f5d-4acd-8843-aa59d4abf7fa)

# ðŸ’¡ ê²Œì´ì§€ ë©”íŠ¸ë¦­ ë“±ë¡
- ê²Œì´ì§€ëŠ” ìž„ì˜ë¡œ ì˜¤ë¥´ë‚´ë¦´ ìˆ˜ ìžˆëŠ” ë‹¨ì¼ ìˆ«ìž ê°’ì„ ë‚˜íƒ€ë‚´ëŠ” ë©”íŠ¸ë¦­
- ê°’ì˜ í˜„ìž¬ ìƒíƒœë¥¼ ë³´ëŠ”ë° ì‚¬ìš©
- ê°’ì´ ì¦ê°€í•˜ê±°ë‚˜ ê°ì†Œí•  ìˆ˜ ìžˆìŒ
- ì˜ˆ) ì°¨ëŸ‰ì˜ ì†ë„, CPU ì‚¬ìš©ëŸ‰, ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰

â–¶ï¸ ì„¤ì • - ìž¬ê³  ìˆ˜ëŸ‰ì— ê²Œì´ì§€ ë©”íŠ¸ë¦­ ë“±ë¡
```java
@Slf4j
@Configuration
public class StockConfigV2 {

    @Bean
    public MeterBinder stockSize(OrderService orderService) {
        return registry -> Gauge.builder("my.stock", orderService, service -> {
            log.info("stock gauge call");
            return service.getStock().get();
        }).register(registry);
    }
}
```
