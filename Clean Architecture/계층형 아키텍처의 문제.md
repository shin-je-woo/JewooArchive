# Previous

지금까지 개발해오면서 주로 계층형 아키텍처 위에서 개발을 했다.

쓰면서도 여러가지 단점을 느꼈지만, 어떻게 풀어내야 할지 몰라서, 마감기한이 다가오는 등의 이유로 비효율적인 방법으로 코드를 작성하기도 했다.

이번 글에서는 계층형 아키텍처의 단점이 무엇인지 간단하게 정리해보려 한다.

(계층형 아키텍처가 나쁘다는 것이 아니라, 잘 못 사용하게 되면 어떤 문제가 발생하는지에 대한 글이다. 규칙에 따라 잘 구현된 계층형 아키텍처는 합리적이라고 생각한다.)

## 데이터베이스에 의존적인 설계이다.

계층형 아키텍처는 자연스레 웹 계층 -> 도메인 계층 -> 영속성 계층의 의존관계가 발생한다.

이런 이유로 계층형 아키텍처 위에서는 도메인 로직보다 데이터베이스의 구조를 먼저 생각하게 된다.

그러나, 이 방법은 잘 못 되었다. 비즈니스의 주 관점은 도메인 로직이지, 데이터베이스가 아니기 때문이다.

또한, ORM(JPA, Hibernate)을 사용하게 되면 도메인 로직과 영속성 로직을 혼용하여 사용하고 싶은 유혹이 생긴다. (도메인 로직 + 즉시로딩, 지연로딩, 캐시 플러시..)

하지만, 이렇게 되면 영속성 계층과 도메인 계층 사이에 강한 결합이 발생한다.

이는 곧 영속성 코드가 도메인 코드에 스며들어 둘 중 하나만 바꾸기 어려워진다.

## 영속성 계층이 비대해질 수 있다.

계층형 아키텍처의 흐름은 위에서 아래로 흐른다. 모든 의존관계는 아래로 향하게 되어있다.

이런 이유로 특정 계층에서는 같은 계층에 있는 컴포넌트나 아래에 있는 계층에만 접근이 가능하다.

만약 상위 계층에 있는 컴포넌트에 접근해야 한다면 간단하게 해당 컴포넌트를 계층 아래로 내려버리면 된다.

하지만, 이런 잘못된 지름길은 영속성 계층을 비대하게 만드는 결과를 낳는다.

어떤 계층에도 속하지 않는 것처럼 보이는 헬퍼 컴포넌트나 유틸리티 컴포넌트들이 아래 계층으로 내려질 가능성이 크다.

이를 방지하려면 규칙이 깨졌을 때 빌드가 실패하도록 만들어야 한다. (ex. ArchUnit)

## 유스케이스를 숨긴다.

앞에서도 얘기했지만, 계층형 아키텍처는 도메인 로직이 여러 계층에 흩어지기 쉽다.

유스케이스가 간단해서 도메인 계층을 생략하고 웹 계층에 존재할 수도 있다.

또는 영속성 계층에서 접근할 수 있도록 컴포넌트를 아래로 내렸다면 영속성 계층에 존재할 수도 있다.

또한, 계층형 아키텍처에서는 도메인 서비스의 '너비'에 관한 규칙이 없기 때문에 헤비한 도메인 계층이 발생할 수 있다.

넓은 서비스는 여러 영속성 계층에 의존성을 갖게 되고, 다시 웹 계층의 많은 컴포넌트가 이 서비스를 의존하게 된다.

결국에는 여기저기 얽힌 의존관계로 인해 코드를 해석하고 고치기 어렵게 된다.

특화된 좁은 도메인 서비스가 유스케이스 하나씩만 담당하게 하도록 하여 이런 문제가 발생하지 않도록 해야 한다.

## References

- [책] 만들면서 배우는 클린 아키텍처
