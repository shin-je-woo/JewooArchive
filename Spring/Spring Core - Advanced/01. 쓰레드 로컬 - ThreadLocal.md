# ğŸ’¡ ë™ì‹œì„± ë¬¸ì œ
- ì—¬ëŸ¬ ì“°ë ˆë“œê°€ ë™ì‹œì— ê°™ì€ ë©”ëª¨ë¦¬ ì˜ì—­(ì¼ë°˜ì ìœ¼ë¡œ ì¸ìŠ¤í„´ìŠ¤ì˜ í•„ë“œ)ì— ì ‘ê·¼í•  ë•Œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ë¬¸ì œ
- ë™ì‹œì„± ë¬¸ì œê°€ ë°œìƒí•˜ëŠ” ìƒí™©ì„ ì˜ˆì œë¥¼ í†µí•´ í™•ì¸í•´ë³´ì

â–¶ï¸ ì„œë¹„ìŠ¤ ì½”ë“œ
```java
@Slf4j
public class FieldService {

    private String nameStore;

    public String logic(String name) {
        log.info("ì €ì¥ name={} -> nameStroe={}", name, nameStore);
        nameStore = name;
        sleep(1000);
        log.info("ì¡°íšŒ nameStroe={}", nameStore);
        return nameStore;
    }

    private void sleep(int millis) {
        try {
            Thread.sleep(millis);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
}
```
- íŒŒë¼ë¯¸í„°ë¡œ ë„˜ì–´ì˜¨ `name` ì„ ê°ì²´ì˜ í•„ë“œì¸ `nameStore` ì— ì €ì¥í•œë‹¤. ê·¸ë¦¬ê³  1ì´ˆê°„ ì‰° ë‹¤ìŒ í•„ë“œì— ì €ì¥ëœ `nameStore` ë¥¼ ë°˜í™˜í•œë‹¤.

â–¶ï¸ í…ŒìŠ¤íŠ¸ ì½”ë“œ
```java
@Slf4j
public class FieldServiceTest {

    private FieldService fieldService = new FieldService();

    @Test
    void field() {
        log.info("main start");
        Runnable userA = () -> fieldService.logic("userA");
        Runnable userB = () -> fieldService.logic("userB");

        Thread threadA = new Thread(userA);
        threadA.setName("threadA");
        Thread threadB = new Thread(userB);
        threadB.setName("threadB");

        threadA.start();
//        sleep(2000); // ë™ì‹œì„± ë¬¸ì œ ë°œìƒ X
        sleep(100); // ë™ì‹œì„± ë¬¸ì œ ë°œìƒ O
        threadB.start();

        sleep(3000); // ë©”ì¸ ì“°ë ˆë“œ ì¢…ë£Œ ëŒ€ê¸°
        log.info("main exit");
    }

    private void sleep(int millis) {
        try {
            Thread.sleep(millis);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
}
```
- ìœ„ ì½”ë“œì—ì„œ `threadA` ëŠ” `userA` ë¥¼ ë°˜í™˜ë°›ê¸°ë¥¼ ê¸°ëŒ€í–ˆì§€ë§Œ, ì‹¤ì œë¡œëŠ” `userB` ë¥¼ ë°˜í™˜ë°›ê²Œ ëœë‹¤. (ì €ì¥í•œ ë°ì´í„°ì™€ ì¡°íšŒí•œ ë°ì´í„°ê°€ ë‹¤ë¥´ë‹¤.)
- ì´ì²˜ëŸ¼ ì—¬ëŸ¬ ì“°ë ˆë“œê°€ ë™ì‹œì— ê°™ì€ ì¸ìŠ¤í„´ìŠ¤ì˜ í•„ë“œ ê°’ì„ ë³€ê²½í•˜ë©´ì„œ ë°œìƒí•˜ëŠ” ë¬¸ì œë¥¼ ë™ì‹œì„± ë¬¸ì œë¼ í•œë‹¤.
- íŠ¹íˆ ìŠ¤í”„ë§ ë¹ˆê³¼ ê°™ì€ ì‹±ê¸€í†¤ ê°ì²´ì˜ í•„ë“œë¥¼ ë³€ê²½í•˜ë©° ì‚¬ìš©í•  ë•Œ ì´ëŸ¬í•œ ë™ì‹œì„± ë¬¸ì œë¥¼ ì¡°ì‹¬í•´ì•¼ í•œë‹¤.

### ğŸ“Œ ì°¸ê³ 
- ì´ëŸ° ë™ì‹œì„± ë¬¸ì œëŠ” ì§€ì—­ ë³€ìˆ˜ì—ì„œëŠ” ë°œìƒí•˜ì§€ ì•ŠëŠ”ë‹¤. ì§€ì—­ ë³€ìˆ˜ëŠ” ì“°ë ˆë“œë§ˆë‹¤ ê°ê° ë‹¤ë¥¸ ë©”ëª¨ë¦¬ ì˜ì—­ì´ í• ë‹¹ëœë‹¤.
- ë™ì‹œì„± ë¬¸ì œê°€ ë°œìƒí•˜ëŠ” ê³³ì€ ì¸ìŠ¤í„´ìŠ¤ì˜ í•„ë“œ(ì£¼ë¡œ ì‹±ê¸€í†¤ì—ì„œ ìì£¼ ë°œìƒ), ë˜ëŠ” static ê°™ì€ ê³µìš© í•„ë“œì— ì ‘ê·¼í•  ë•Œ ë°œìƒí•œë‹¤.
- ë™ì‹œì„± ë¬¸ì œëŠ” ê°’ì„ ì½ê¸°ë§Œ í•˜ë©´ ë°œìƒí•˜ì§€ ì•ŠëŠ”ë‹¤. ì–´ë””ì„ ê°€ ê°’ì„ ë³€ê²½í•˜ê¸° ë•Œë¬¸ì— ë°œìƒí•œë‹¤.

# ğŸ’¡ ThreadLocal
- ì“°ë ˆë“œ ë¡œì»¬ì€ íŠ¹ì • ì“°ë ˆë“œì˜ ì§€ì—­ ë³€ìˆ˜ ê°™ì€ ê°œë…ìœ¼ë¡œ, ì‰½ê²Œ ë§í•´ íŠ¹ì • ì“°ë ˆë“œë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ì €ì¥ì†Œë¥¼ ì˜ë¯¸
- Aë¼ëŠ” ì“°ë ˆë“œì™€ Bë¼ëŠ” ì“°ë ˆë“œê°€ ë™ì‹œì— ì ‘ê·¼í•  ë•Œ ê°ê° ë‹¤ë¥¸ ë©”ëª¨ë¦¬ì— ì ‘ê·¼í•˜ê¸° ë•Œë¬¸ì— ìœ„ì˜ ë™ì‹œì„± ë¬¸ì œë¥¼ í”¼í•  ìˆ˜ ìˆë‹¤.

![image](https://github.com/shin-je-woo/TIL/assets/39439576/f0ef6198-b8c5-4bb6-97c2-213ab31267ee)

```java
public class Thread implements Runnable {
    
    /* ThreadLocal values pertaining to this thread. This map is maintained
     * by the ThreadLocal class. */
    ThreadLocal.ThreadLocalMap threadLocals = null;
```
- `Thread` í´ë˜ìŠ¤ ì½”ë“œë¥¼ ë³´ë©´ `threadLocals` ë¼ëŠ” ë©¤ë²„ ë³€ìˆ˜ë¥¼ ê°€ì§€ê³  ìˆì–´ì„œ ì“°ë ˆë“œ ë³„ë¡œ `ThreadLocalMap` íƒ€ì…ì˜ ë³€ìˆ˜ë¥¼ ì „ì—­ì ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

## ThreadLocal ì‚¬ìš©ë°©ë²•
- `ThreadLocal` ì€ get(), set(), remove() ë©”ì„œë“œë¥¼ í†µí•´ ì¡°íšŒ, ì €ì¥, ì‚­ì œí•  ìˆ˜ ìˆë‹¤.
```java
public class ThreadLocal<T> {
    public T get() {
        Thread t = Thread.currentThread();
        ThreadLocalMap map = getMap(t);
        if (map != null) {
            ThreadLocalMap.Entry e = map.getEntry(this);
            if (e != null) {
                @SuppressWarnings("unchecked")
                T result = (T)e.value;
                return result;
            }
        }
        return setInitialValue();
    }

    public void set(T value) {
        Thread t = Thread.currentThread();
        ThreadLocalMap map = getMap(t);
        if (map != null) {
            map.set(this, value);
        } else {
            createMap(t, value);
        }
    }

    ThreadLocalMap getMap(Thread t) {
        return t.threadLocals;
    }
}
```
- get(), set() ë©”ì„œë“œë¥¼ ë³´ë©´ í˜„ì¬ `Thread` ì˜ `ThreadLocalMap` íƒ€ì…ì˜ `threadLocals` ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

## ThreadLocal ì£¼ì˜ì‚¬í•­
- WAS í™˜ê²½ì—ì„œëŠ” ëŒ€ë¶€ë¶„ ThreadPoolì„ ì‚¬ìš©í•˜ê²Œ ë˜ëŠ”ë°, ì‚¬ìš©ì´ ëë‚œ ThreadëŠ” ì˜ì›íˆ ì‚¬ë¼ì§€ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ThreadPoolì— ë°˜ë‚©í•˜ê²Œ ëœë‹¤.
- ë§Œì•½, ìš”ì²­ì´ ëë‚˜ê³  remove() ë©”ì„œë“œë¥¼ í†µí•´ `ThreadLocal` ë³€ìˆ˜ë¥¼ ì´ˆê¸°í™”í•˜ì§€ ì•Šìœ¼ë©´ ë°˜ë‚©ëœ ì“°ë ˆë“œê°€ ë‹¤ì‹œ `ThreadLocal` ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•  ë•Œ ì˜ˆìƒí•˜ì§€ ëª»í•œ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.
- ë”°ë¼ì„œ, ThreadLocal ì„ ë‹¤ ì‚¬ìš©í•˜ê³  ë‚˜ë©´ ê¼­! `ThreadLocal` ë³€ìˆ˜ë¥¼ ì´ˆê¸°í™” í•˜ì.
