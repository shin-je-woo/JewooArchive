# π’΅ Previous
- μ¤ν”„λ§ AOP λ” λ°νƒ€μ„μ— ν”„λ΅μ‹ κΈ°λ°μ AOP λ¥Ό μν–‰ν•λ‹¤κ³  ν–λ‹¤.
- ν”„λ΅μ‹ μλ™ μƒμ„±κΈ° λ•λ¶„μ— `Advisor` λ§ λ§λ“¤κ³  λΉμΌλ΅ λ“±λ΅ν•λ©΄ λλ”λ°, `@Aspect` λ΅ νΈλ¦¬ν•κ² `Advisor` λ¥Ό μƒμ„±ν•  μλ„ μλ‹¤.
- μ°Έκ³ λ΅, `@Aspect` λ¥Ό μ‚¬μ©ν•λ ¤λ©΄ `@EnableAspectJAutoProxy` λ¥Ό μ¤ν”„λ§ μ„¤μ •μ— μ¶”κ°€ν•΄μ•Ό λλ”λ°, μ¤ν”„λ§ λ¶€νΈκ°€ μλ™μΌλ΅ μ¶”κ°€ν•΄ μ¤€λ‹¤.
- μ΄λ²μ—λ” `@Aspect` λ¥Ό ν™μ©ν•μ—¬ μ¤ν”„λ§ AOP λ¥Ό κµ¬ν„ν•΄ λ³Ό κ²ƒμ΄λ‹¤.
- κ·Έλ¦¬κ³  Pointcut κ³Ό Advice λ¥Ό λ‹¤λ£¨λ” @Aspect μ κΈ°λ¥μ— λ€ν•΄μ„λ„ μ•μ•„λ³Έλ‹¤.
- μμ λ” κ°„λ‹¨ν•κ² ν΄λΌμ΄μ–ΈνΈ β†’ Service β†’ Repository κµ¬μ„±μΌλ΅ μ§„ν–‰ν•λ‹¤.

# π’΅ 1. κΈ°λ³Έ AOP κµ¬ν„
```java
@Slf4j
@Aspect
public class AspectV1 {

    @Around("execution(* com.study.advanced.aop.order..*(..))")
    public Object doLog(ProceedingJoinPoint joinPoint) throws Throwable {
        log.info("[log] {}", joinPoint.getSignature()); // join point μ‹κ·Έλ‹μ²
        return joinPoint.proceed();
    }
}
```
- `@Around` μ• λ…Έν…μ΄μ…μ κ°’μ΄ ν¬μΈνΈμ»·μ΄ λλ‹¤.
- `@Around` μ• λ…Έν…μ΄μ…μ λ©”μ„λ“μΈ doLog λ” μ–΄λ“λ°”μ΄μ¤κ°€ λλ‹¤.
- AspectJ ν‘ν„μ‹μΌλ΅ ν¬μΈνΈμ»·μ„ μ§€μ •ν–κ³ , com.study.advanced.aop.orderν¨ν‚¤μ§€μ™€ ν•μ„ ν¨ν‚¤μ§€κ°€ ν¬μΈνΈμ»·μ΄ λλ‹¤.
- `@Aspect` λ” μ»΄ν¬λ„νΈ μ¤μΊ”μ΄ λλ” κ²ƒμ€ μ•„λ‹λ‹¤. λ”°λΌμ„ AspectV1 λ¥Ό AOPλ΅ μ‚¬μ©ν•λ ¤λ©΄ μ¤ν”„λ§ λΉμΌλ΅ λ“±λ΅ν•΄μ•Ό ν•λ‹¤.

# π’΅ 2. Pointcut λ¶„λ¦¬
- `@Around` μ— ν¬μΈνΈμ»· ν‘ν„μ‹μ„ μ§μ ‘ λ„£μ„ μ λ„ μμ§€λ§, `@Pointcut` μ• λ…Έν…μ΄μ…μ„ μ‚¬μ©ν•΄μ„ ν¬μΈνΈμ»·μ„ λ¶„λ¦¬ν•  μ λ„ μλ‹¤.

```java
@Slf4j
@Aspect
public class AspectV2 {

    @Pointcut("execution(* com.study.advanced.aop.order..*(..))")
    private void allOrder() {} // pointcut signature

    @Around("allOrder()")
    public Object doLog(ProceedingJoinPoint joinPoint) throws Throwable {
        log.info("[log] {}", joinPoint.getSignature()); // join point μ‹κ·Έλ‹μ²
        return joinPoint.proceed();
    }
}
```
- μ„ μ½”λ“μ™€ κ°™μ΄ `@Pointcut` μ„ ν†µν•΄ ν¬μΈνΈμ»·μ„ λ³„λ„μ λ©”μ„λ“λ΅ λ¶„λ¦¬ν•  μ μλ‹¤.
- λ©”μ„λ“μ λ°ν™ νƒ€μ…μ€ void μ΄μ–΄μ•Ό ν•κ³ , μ½”λ“λ‚΄μ©μ€ λΉ„μ›λ‘”λ‹¤.
- λ©”μ„λ“ μ΄λ¦„κ³Ό νλΌλ―Έν„°λ¥Ό ν•©μ³μ„ ν¬μΈνΈμ»· μ‹κ·Έλ‹μ²(signature)λΌ ν•λ‹¤.
- ν¬μΈνΈμ»· μ‹κ·Έλ‹μ²λ¥Ό μ‚¬μ©ν•λ©΄ ν¬μΈνΈμ»·μ— μ΄λ¦„μ„ λ¶€μ—¬ν•  μ μλ” μ¥μ μ΄ μλ‹¤.
- μμ£Ό μ‚¬μ©ν•λ” ν¬μΈνΈμ»·μ€ μ‹κ·Έλ‹μ²λ΅ λ§λ“¤μ–΄ μ‚¬μ©ν•μ.

# π’΅ 3. Advice μ¶”κ°€
```java
@Slf4j
@Aspect
public class AspectV3 {

    @Pointcut("execution(* com.study.advanced.aop.order..*(..))")
    private void allOrder() {
    } // pointcut signature

    // ν΄λμ¤ μ΄λ¦„ ν¨ν„΄μ΄ *Service
    @Pointcut("execution(* *..*Service.*(..))")
    private void allService() {
    }

    @Around("allOrder()")
    public Object doLog(ProceedingJoinPoint joinPoint) throws Throwable {
        log.info("[log] {}", joinPoint.getSignature()); // join point μ‹κ·Έλ‹μ²
        return joinPoint.proceed();
    }

    // com.study.advanced.aop.order ν¨ν‚¤μ§€μ™€ ν•μ„ ν¨ν‚¤μ§€μ΄λ©΄μ„ ν΄λμ¤ μ΄λ¦„ ν¨ν„΄μ΄ *Service
    @Around("allOrder() && allService()")
    public Object doTransaction(ProceedingJoinPoint joinPoint) throws Throwable {
        try {
            log.info("[νΈλμ­μ… μ‹μ‘] {}", joinPoint.getSignature());
            Object result = joinPoint.proceed();
            log.info("[νΈλμ­μ… μ»¤λ°‹] {}", joinPoint.getSignature());
            return result;
        } catch (Exception e) {
            log.info("[νΈλμ­μ… λ΅¤λ°±] {}", joinPoint.getSignature());
            throw e;
        } finally {
            log.info("[λ¦¬μ†μ¤ λ¦΄λ¦¬μ¦] {}", joinPoint.getSignature());
        }
    }
}
```
- com.study.advanced.aop.order ν¨ν‚¤μ§€μ™€ κ·Έ ν•μ„ ν¨ν‚¤μ§€μ—λ” doLog() μ–΄λ“λ°”μ΄μ¤κ°€ μ μ©λλ‹¤.
- κ·Έ μ¤‘ *Service νƒ€μ…μ€ doTransaction() μ–΄λ“λ°”μ΄μ¤λ„ ν•¨κ» μ μ©λλ‹¤.
- μ¦‰, orderServiceλ” doLog(), doTransaction() μ–΄λ“λ°”μ΄μ¤κ°€ λ¨λ‘ μ μ©λκ³ , orderRepositoryλ” doLog() μ–΄λ“λ°”μ΄μ¤λ§ μ μ©λλ‹¤.
- μ°Έκ³ λ΅ `@Around("allOrder() && allService()")` μ΄λ°μ‹μΌλ΅ ν¬μΈνΈμ»· μ‹κ·Έλ‹μ²λ¥Ό μ΅°ν•©ν•  μλ„ μλ‹¤. ( && (AND), || (OR), ! (NOT) )

# π’΅ 4. ν¬μΈνΈμ»· μ°Έμ΅°
```java
public class Pointcuts {

    @Pointcut("execution(* com.study.advanced.aop.order..*(..))")
    public void allOrder() {} // pointcut signature

    // ν΄λμ¤ μ΄λ¦„ ν¨ν„΄μ΄ *Service
    @Pointcut("execution(* *..*Service.*(..))")
    public void allService() {}

    // allOrder && allService
    @Pointcut("allOrder() && allService()")
    public void orderAndService() {}
}
```
- μ„ μ½”λ“μ™€ κ°™μ΄ ν¬μΈνΈμ»·μ„ κ³µμ©μΌλ΅ μ‚¬μ©ν•κΈ° μ„ν•΄ λ³„λ„μ μ™Έλ¶€ ν΄λμ¤μ— λ¨μ•„λ‘μ–΄λ„ λλ‹¤.
- μ™Έλ¶€ ν΄λμ¤μ—μ„ μ‚¬μ©ν•κ² ν•  κ²½μ° μ ‘κ·Όμ μ–΄μλ¥Ό public μΌλ΅ μ„¤μ •ν•΄μ•Ό ν•λ‹¤.
- μ™Έλ¶€ ν΄λμ¤μ—μ„ μ‚¬μ©ν•  λ•λ” μ•„λ μ½”λ“μ™€ κ°™μ΄ ν¨ν‚¤μ§€λ…μ„ ν¬ν•¨ν• ν΄λμ¤ μ΄λ¦„κ³Ό ν¬μΈνΈμ»· μ‹κ·Έλ‹μ²λ¥Ό λ¨λ‘ μ§€μ •ν•λ©΄ λλ‹¤.

```java
@Around("com.study.advanced.aop.order.aop.Pointcuts.orderAndService()")
```

# π’΅ 5. μ–΄λ“λ°”μ΄μ¤ μμ„
- doLog() μ–΄λ“λ°”μ΄μ¤κ°€ μ•„λ‹λΌ doTransaction() μ–΄λ“λ°”μ΄μ¤λ¥Ό λ¨Όμ € μ μ©ν•λ ¤λ©΄ μ–΄λ–»κ² ν•΄μ•Ό ν• κΉ?
- μ–΄λ“λ°”μ΄μ¤λ” κΈ°λ³Έμ μΌλ΅ μμ„λ¥Ό λ³΄μ¥ν•μ§€ μ•λ”λ‹¤.
- μμ„λ¥Ό μ§€μ •ν•κ³  μ‹¶μΌλ©΄ `@Aspect` μ μ© λ‹¨μ„λ΅ `org.springframework.core.annotation.@Order` μ• λ…Έν…μ΄μ…μ„ μ μ©ν•΄μ•Ό ν•λ‹¤.
- λ¬Έμ λ” μ΄κ²ƒμ„ μ–΄λ“λ°”μ΄μ¤ λ‹¨μ„κ°€ μ•„λ‹λΌ ν΄λμ¤ λ‹¨μ„λ΅ μ μ©ν•  μ μλ‹¤λ” μ μ΄λ‹¤.
- κ·Έλμ„ μ§€κΈμ²λΌ ν•λ‚μ μ• μ¤ν™νΈμ— μ—¬λ¬ μ–΄λ“λ°”μ΄μ¤κ°€ μμΌλ©΄ μμ„λ¥Ό λ³΄μ¥ λ°›μ„ μ μ—†λ‹¤.
- λ”°λΌμ„ μ• μ¤ν™νΈλ¥Ό λ³„λ„μ ν΄λμ¤λ΅ λ¶„λ¦¬ν•΄μ•Ό ν•λ‹¤.
- λ²κ±°λ΅­μ§€λ§ doLog() μ–΄λ“λ°”μ΄μ¤μ™€ doTranscation() μ–΄λ“λ°”μ΄μ¤λ¥Ό λ³„λ„μ ν΄λμ¤λ΅ λ¶„λ¦¬ν•΄μ•Ό ν•λ‹¤.

```java
@Slf4j
@Aspect
public class AspectV5Order {

    @Aspect
    @Order(2)
    public static class LogAspect {
        @Around("com.study.advanced.aop.order.aop.Pointcuts.allOrder()")
        public Object doLog(ProceedingJoinPoint joinPoint) throws Throwable {
            log.info("[log] {}", joinPoint.getSignature()); // join point μ‹κ·Έλ‹μ²
            return joinPoint.proceed();
        }
    }

    @Aspect
    @Order(1)
    public static class TxAspect {
        // com.study.advanced.aop.order ν¨ν‚¤μ§€μ™€ ν•μ„ ν¨ν‚¤μ§€μ΄λ©΄μ„ ν΄λμ¤ μ΄λ¦„ ν¨ν„΄μ΄ *Service
        @Around("com.study.advanced.aop.order.aop.Pointcuts.orderAndService()")
        public Object doTransaction(ProceedingJoinPoint joinPoint) throws Throwable {

            try {
                log.info("[νΈλμ­μ… μ‹μ‘] {}", joinPoint.getSignature());
                Object result = joinPoint.proceed();
                log.info("[νΈλμ­μ… μ»¤λ°‹] {}", joinPoint.getSignature());
                return result;
            } catch (Exception e) {
                log.info("[νΈλμ­μ… λ΅¤λ°±] {}", joinPoint.getSignature());
                throw e;
            } finally {
                log.info("[λ¦¬μ†μ¤ λ¦΄λ¦¬μ¦] {}", joinPoint.getSignature());
            }
        }
    }
}
```
- ν•λ‚μ μ• μ¤ν™νΈ μ•μ— μλ μ–΄λ“λ°”μ΄μ¤λ¥Ό LogAspect , TxAspect μ• μ¤ν™νΈλ΅ κ°κ° λ¶„λ¦¬ν–λ‹¤.
- κ·Έλ¦¬κ³  κ° μ• μ¤ν™νΈμ— `@Order` μ• λ…Έν…μ΄μ…μ„ ν†µν•΄ μ‹¤ν–‰ μμ„λ¥Ό μ μ©ν–λ‹¤.

# π’΅ 6. μ–΄λ“λ°”μ΄μ¤ μΆ…λ¥
### @Around
- νƒ€κ² λ©”μ„λ“ μ‹¤ν–‰ μ „ν›„μ— μ‘μ—…μ„ μν–‰ν•λ” κ°€μ¥ κ°•λ ¥ν• μ–΄λ“λ°”μ΄μ¤μ΄λ‹¤.
- μ΅°μΈ ν¬μΈνΈ μ‹¤ν–‰ μ—¬λ¶€ μ„ νƒ, λ°ν™ κ°’ λ³€ν™, μμ™Έ λ³€ν™ λ“±μ΄ κ°€λ¥ν•λ‹¤.
- β— @Around λ” `ProceedingJoinPoint.proceed()` λ¥Ό νΈμ¶ν•΄μ•Ό λ‹¤μ μ–΄λ“λ°”μ΄μ¤λ‚ νƒ€μΌ“μ΄ νΈμ¶λλ‹¤. λ§μ•½ νΈμ¶ν•μ§€ μ•μΌλ©΄ λ‹¤μ λ€μƒμ΄ νΈμ¶λμ§€ μ•λ”λ‹¤.
- @Around λ¥Ό μ μ™Έν• λ‚λ¨Έμ§€ μ–΄λ“λ°”μ΄μ¤λ“¤μ€ @Around κ°€ ν•  μ μλ” μΌμ μΌλ¶€λ§ μ κ³µν•λ‹¤.
```java
@Around("com.study.advanced.aop.order.aop.Pointcuts.orderAndService()")
public Object doTransaction(ProceedingJoinPoint joinPoint) throws Throwable {
    log.info("{}, {}" joinPoint.getSignature());
    joinPoint.proceed();
}
```

### @Before
- νƒ€κ² λ©”μ„λ“ νΈμ¶ μ „μ— μ‹¤ν–‰λλ‹¤.
- μ–΄λ“λ°”μ΄μ¤κ°€ μΆ…λ£λλ©΄ μλ™μΌλ΅ Targetμ„ νΈμ¶ν•λ‹¤.
```java
@Before("com.study.advanced.aop.order.aop.Pointcuts.orderAndService()")
public void doBefore(JoinPoint joinPoint) {
    log.info("[before] {}", joinPoint.getSignature());
}
```

### @AfterReturning
- νƒ€κ² λ©”μ„λ“κ°€ λ°ν™λ ν›„ μ‹¤ν–‰λλ‹¤. (μ •μƒ μ™„λ£)
- returning μ†μ„±λ…κ³Ό λ©”μ„λ“ νλΌλ―Έν„°λ…μ΄ μΌμΉν•΄μ•Ό ν•λ‹¤.
```java
@AfterReturning(value = "com.study.advanced.aop.order.aop.Pointcuts.orderAndService()", returning = "result")
public void doReturn(JoinPoint joinPoint, Object result) {
    log.info("[return] {} return={}", joinPoint.getSignature(), result);
}
```

### @AfterThrowing
- νƒ€κ² λ©”μ„λ“κ°€ μμ™Έλ¥Ό λμ§€λ” κ²½μ° μ‹¤ν–‰λλ‹¤.
- throwing μ†μ„±λ…κ³Ό λ©”μ„λ“ νλΌλ―Έν„°λ…μ΄ μΌμΉν•΄μ•Ό ν•λ‹¤.
```java
@AfterThrowing(value = "com.study.advanced.aop.order.aop.Pointcuts.orderAndService()", throwing = "ex")
public void doThrowing(JoinPoint joinPoint, Exception ex) {
    log.info("[exception] {} message={}", joinPoint.getSignature(), ex.getMessage());
}
```

### @After
- νƒ€κ² λ©”μ„λ“ μ •μƒμ™„λ£ λλ” μμ™Έμ— κ΄€κ³„μ—†μ΄ μ‹¤ν–‰λλ‹¤. finallyμ™€ μ μ‚¬ν•λ‹¤.
- μΌλ°μ μΌλ΅ λ¦¬μ†μ¤λ¥Ό ν•΄μ ν•  λ• μ‚¬μ©ν•λ‹¤.
```java
@After("com.study.advanced.aop.order.aop.Pointcuts.orderAndService()")
public void doAfter(JoinPoint joinPoint) {
    log.info("[after] {}", joinPoint.getSignature());
}
```

## JoinPoint μ™€ ProceedingJoinpoint
- μ¤ν”„λ§ AOP ν”„λ΅μ‹ κ°μ²΄λ” μ‹¤μ κ°μ²΄(Target)μ™€ Advisor λ¥Ό μ•κ³  μλ‹¤.
- μ΄ λ• ν”„λ΅μ‹κ°μ²΄μ λ©”μ„λ“κ°€ νΈμ¶λλ©΄ μ‹¤μ  κ°μ²΄ + λ©”μ„λ“ μ •λ³΄λ¥Ό νλΌλ―Έν„°λ΅ λ„κΈ°λ©° Advice λ¥Ό μ‹¤ν–‰ν•λ‹¤.
- Advice μ—μ„λ” μ΄ μ •λ³΄λ¥Ό JoinPoint λΌλ” νλΌλ―Έν„°λ΅ μ΅°νν•μ—¬ μ‚¬μ©ν•λ‹¤.
- λ¨λ“  μ–΄λ“λ°”μ΄μ¤λ” `org.aspectj.lang.JoinPoint` λ¥Ό μ²«λ²μ§Έ νλΌλ―Έν„°μ— μ‚¬μ©ν•  μ μλ‹¤. (μƒλµν•΄λ„ λλ‹¤.)
- λ‹¨, `@Around` λ” `ProceedingJoinPoint` μ„ μ‚¬μ©ν•΄μ•Ό ν•λ‹¤.

### β… JoinPoint μΈν„°νμ΄μ¤μ μ£Όμ” κΈ°λ¥
- getArgs() : λ©”μ„λ“ μΈμλ¥Ό λ°ν™ν•λ‹¤.
- getThis() : ν”„λ΅μ‹ κ°μ²΄λ¥Ό λ°ν™ν•λ‹¤.
- getTarget() : λ€μƒ κ°μ²΄λ¥Ό λ°ν™ν•λ‹¤.
- getSignature() : μ΅°μ–Έλλ” λ©”μ„λ“μ— λ€ν• μ„¤λ…μ„ λ°ν™ν•λ‹¤,
- toString() : μ΅°μ–Έλλ” λ°©λ²•μ— λ€ν• μ μ©ν• μ„¤λ…μ„ μΈμ‡„ν•λ‹¤.

### β…ProceedingJoinPoint μΈν„°νμ΄μ¤μ μ£Όμ” κΈ°λ¥
- proceed() : λ‹¤μ μ–΄λ“λ°”μ΄μ¤λ‚ νƒ€μΌ“μ„ νΈμ¶ν•λ‹¤.

## @Around μ™Έμ— λ‹¤λ¥Έ μ–΄λ“λ°”μ΄μ¤κ°€ μ΅΄μ¬ν•λ” μ΄μ 
- `@Around` κ°€ κ°€μ¥ λ§μ€ κΈ°λ¥μ„ μν–‰ν•  μ μλ” μ–΄λ“λ°”μ΄μ¤λ΅, μ΄κ²ƒλ§ μ‚¬μ©ν•λ©΄ λ  κ²ƒ κ°™λ‹¤.
- κ·Έλ°λ° `@Around` λ” `joinPoint.proceed()` λ΅ νƒ€μΌ“μ΄ νΈμ¶λμ§€ μ•λ” μΉλ…μ μΈ λ²„κ·Έκ°€ λ°μƒν•  μ μλ‹¤.
- `@Before` μ™€ κ°™μ€ μ–΄λ“λ°”μ΄μ¤λ” `joinPoint.proceed()` λ¥Ό νΈμ¶ν•λ” κ³ λ―Όμ„ ν•μ§€ μ•μ•„λ„ λλ‹¤.
- κ·Έλ¦¬κ³  `@Before` μ• λ…Έν…μ΄μ…λ§ λ΄λ„ ν•΄λ‹Ή μ–΄λ“λ°”μ΄μ¤κ°€ νƒ€κ² νΈμ¶ μ „μ— μ–΄λ–¤ κΈ°λ¥μ„ μν–‰ν•  κ²ƒμ„μ„ μ§μ‘ν•  μ μλ‹¤.
