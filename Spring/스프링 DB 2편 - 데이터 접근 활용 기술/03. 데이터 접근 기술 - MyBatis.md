# π’΅ MyBatis μ†κ°
* MyBatisλ” JdbcTemplateλ³΄λ‹¤ λ” λ§μ€ κΈ°λ¥μ„ μ κ³µν•λ” SQL Mapper μ΄λ‹¤.
* κΈ°λ³Έμ μΌλ΅ JdbcTemplateμ΄ μ κ³µν•λ” λ€λ¶€λ¶„μ κΈ°λ¥μ„ μ κ³µν•λ‹¤.
* JdbcTemplateκ³Ό λΉ„κµν•΄μ„ MyBatisμ κ°€μ¥ λ§¤λ ¥μ μΈ μ μ€ SQLμ„ XMLμ— νΈλ¦¬ν•κ² μ‘μ„±ν•  μ μκ³  λ™μ  μΏΌλ¦¬λ¥Ό λ§¤μ° νΈλ¦¬ν•κ² μ‘μ„±ν•  μ μλ‹¤λ” μ μ΄λ‹¤.
* JdbcTemplateμ€ μλ°” μ½”λ“λ΅ μ§μ ‘ λ™μ  μΏΌλ¦¬λ¥Ό μ‘μ„±ν•΄μ•Ό ν•λ‹¤. λ°λ©΄μ— MyBatisλ” λ™μ  μΏΌλ¦¬λ¥Ό λ§¤μ° νΈλ¦¬ν•κ² μ‘μ„±ν•  μ μλ” λ‹¤μ–‘ν• κΈ°λ¥λ“¤μ„ μ κ³µν•΄μ¤€λ‹¤.
* MyBatisλ” XMLμ— μ‘μ„±ν•κΈ° λ•λ¬Έμ— λΌμΈμ΄ κΈΈμ–΄μ Έλ„ λ¬Έμ λ”ν•κΈ°μ— λ€ν• λ¶νΈν•¨μ΄ μ—†λ‹¤.

### μ„¤μ •μ μ¥λ‹¨μ 
JdbcTemplateμ€ μ¤ν”„λ§μ— λ‚΄μ¥λ κΈ°λ¥μ΄κ³ , λ³„λ„μ μ„¤μ •μ—†μ΄ μ‚¬μ©ν•  μ μλ‹¤λ” μ¥μ μ΄ μλ‹¤. λ°λ©΄μ— MyBatisλ” μ•½κ°„μ μ„¤μ •μ΄ ν•„μ”ν•λ‹¤.

# π’΅ MyBatis μ μ©
* MyBatisλ¥Ό μ μ©ν•κΈ° μ„ν•΄μ„λ” λ§¤ν•‘ XMLμ„ νΈμ¶ν•΄μ£Όλ” λ§¤νΌ μΈν„°νμ΄μ¤κ°€ ν•„μ”ν•λ‹¤.

β–¶οΈ Mapper μΈν„°νμ΄μ¤
```java
@Mapper
public interface ItemMapper {

    void save(Item item);

    void update(@Param("id") Long id, @Param("updateParam") ItemUpdateDto updateParam);

    Optional<Item> findById(Long id);

    List<Item> findAll(ItemSearchCond itemSearch);
}
```
* λ§μ΄λ°”ν‹°μ¤ λ§¤ν•‘ XMLμ„ νΈμ¶ν•΄μ£Όλ” λ§¤νΌ μΈν„°νμ΄μ¤μ΄λ‹¤.
* λ§¤νΌ μΈν„°νμ΄μ¤μ—λ” `@Mapper` μ• λ…Έν…μ΄μ…μ„ λ¶™μ—¬μ£Όμ–΄μ•Ό ν•λ‹¤. κ·Έλμ•Ό MyBatisμ—μ„ μΈμ‹ν•  μ μλ‹¤.
* μ΄ μΈν„°νμ΄μ¤μ λ©”μ„λ“λ¥Ό νΈμ¶ν•λ©΄ λ‹¤μμ— λ³΄μ΄λ” xml μ ν•΄λ‹Ή SQLμ„ μ‹¤ν–‰ν•κ³  κ²°κ³Όλ¥Ό λλ ¤μ¤€λ‹¤.

β–¶οΈ λ§¤ν•‘ XML
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="hello.itemservice.repository.mybatis.ItemMapper">

    <!-- useGeneratedKeys : PKμƒμ„± μ „λµμ΄ IDENTITY (λ°μ΄ν„°λ² μ΄μ¤κ°€ μƒμ„±) μΌ λ• μ‚¬μ©.
     Insertκ°€ λλ‚λ©΄ item κ°μ²΄μ id μ†μ„±μ— λ°μ΄ν„°λ² μ΄μ¤κ°€ μƒμ„±ν• ν‚¤ κ°’μ΄ μ…λ ¥λ¨. -->
    <insert id="save" useGeneratedKeys="true" keyProperty="id">
        insert into item (item_name, price, quantity)
        values (#{itemName}, #{price}, #{quantity})
    </insert>

    <!-- νλΌλ―Έν„°κ°€ 2κ° μ΄μƒμ΄λ©΄ μΈν„°νμ΄μ¤μ— @Param μΌλ΅ μ΄λ¦„μ„ μ§€μ •-->
    <update id="update">
        update item
        set item_name = #{updateParam.itemName},
            price = #{updateParam.price},
            quantity = #{updateParam.quantity}
        where id = #{id}
    </update>

    <select id="findById" resultType="Item">
        select id, item_name, price, quantity
        from item
        where id = #{id}
    </select>

    <!-- resultType : SQLμ κ²°κ³Όλ¥Ό νΈλ¦¬ν•κ² κ°μ²΄λ΅ λ°”λ΅ λ³€ν™.
    application.properties μ mybatis.type-aliasespackage μ†μ„±μ— λ„λ©”μΈ ν¨ν‚¤μ§€λ¥Ό μ§€μ •ν•΄μ¤„ κ²½μ° λ„λ©”μΈ ν¨ν‚¤μ§€λ… μƒλµ κ°€λ¥-->
    <select id="findAll" resultType="Item">
        select id, item_name, price, quantity
        from item
        <where>
            <if test="itemName != null and itemName != ''">
                and item_name like concat('%', itemName, '%')
            </if>
            <if test="maxPrice != null">
                and price &lt;= #{maxPrice}
            </if>
        </where>
    </select>

</mapper>
```
* λ§¤ν•‘ XMLμ€ `src/main/resources` ν•μ„μ— λ„λ©”μΈμ ν¨ν‚¤μ§€μ™€ λ™μΌν• κ²½λ΅μ— μμ–΄μ•Ό ν•λ‹¤.
* μ°Έκ³ λ΅, XML νμΌμ„ μ›ν•λ” μ„μΉμ— λ‘κ³  μ‹¶μΌλ©΄ `application.properties` μ— λ‹¤μκ³Ό κ°™μ΄ μ„¤μ •ν•λ©΄ λλ‹¤. 
  * `mybatis.mapper-locations=classpath:mapper/**/*.xml`
  * `resources/mapper` λ¥Ό ν¬ν•¨ν• κ·Έ ν•μ„ ν΄λ”μ— μλ” XMLμ„ XML λ§¤ν•‘ νμΌλ΅ μΈμ‹ν•λ‹¤. μ΄ κ²½μ° νμΌ μ΄λ¦„μ€ μμ λ΅­κ² μ„¤μ •ν•΄λ„ λλ‹¤.
* id μ—λ” λ§¤νΌ μΈν„°νμ΄μ¤μ— μ„¤μ •ν• λ©”μ„λ“ μ΄λ¦„μ„ μ§€μ •ν•λ©΄ λλ‹¤.
* νλΌλ―Έν„°λ” `#{}` λ¬Έλ²•μ„ μ‚¬μ©ν•λ©΄ λλ‹¤. κ·Έλ¦¬κ³  λ§¤νΌμ—μ„ λ„κΈ΄ κ°μ²΄μ ν”„λ΅νΌν‹° μ΄λ¦„μ„ μ μ–΄μ£Όλ©΄ λλ‹¤.

## λ¶„μ„
* `ItemMapper` λ§¤νΌ μΈν„°νμ΄μ¤μ κµ¬ν„μ²΄κ°€ μ—†λ”λ° μ–΄λ–»κ² λ™μ‘ν–μ„κΉ?
* μ΄ λ¶€λ¶„μ€ MyBatis μ¤ν”„λ§ μ—°λ™ λ¨λ“μ—μ„ μλ™μΌλ΅ μ²λ¦¬ν•΄μ£Όλ”λ° λ‹¤μκ³Ό κ°™λ‹¤.

![image](https://github.com/shin-je-woo/TIL/assets/39439576/6d1f2f8d-adf9-4674-a1e8-ca832b1856e2)
1. μ• ν”λ¦¬μΌ€μ΄μ… λ΅λ”© μ‹μ μ— MyBatis μ¤ν”„λ§ μ—°λ™ λ¨λ“μ€ `@Mapper` κ°€ λ¶™μ–΄μλ” μΈν„°νμ΄μ¤λ¥Ό μ΅°μ‚¬ν•λ‹¤.
2. ν•΄λ‹Ή μΈν„°νμ΄μ¤κ°€ λ°κ²¬λλ©΄ **λ™μ  ν”„λ΅μ‹** κΈ°μ μ„ μ‚¬μ©ν•΄μ„ `ItemMapper` μΈν„°νμ΄μ¤μ κµ¬ν„μ²΄λ¥Ό λ§λ“ λ‹¤.
3. μƒμ„±λ κµ¬ν„μ²΄λ¥Ό μ¤ν”„λ§ λΉμΌλ΅ λ“±λ΅ν•λ‹¤.

### λ§¤νΌ κµ¬ν„μ²΄
* μ›λ λ§μ΄λ°”ν‹°μ¤λ¥Ό μ‚¬μ©ν•λ ¤λ©΄ λ” λ²μ΅ν• μ½”λ“λ¥Ό κ±°μ³μ•Ό ν•λ”λ°, μΈν„°νμ΄μ¤ ν•λ‚λ΅ λ§¤μ° νΈλ¦¬ν•κ² μ‚¬μ©ν•  μ μλ‹¤.
* λ§¤νΌ κµ¬ν„μ²΄λ” μμ™Έ λ³€ν™κΉμ§€ μ²λ¦¬ν•΄μ¤€λ‹¤.
* MyBatisμ—μ„ λ°μƒν• μμ™Έλ¥Ό μ¤ν”„λ§ μμ™Έ μ¶”μƒν™”μΈ `DataAccessException` μ— λ§κ² λ³€ν™ν•΄μ„ λ°ν™ν•΄μ¤€λ‹¤.

### μ •λ¦¬
* λ§¤νΌ κµ¬ν„μ²΄ λ•λ¶„μ— λ§μ΄λ°”ν‹°μ¤λ¥Ό μ¤ν”„λ§μ— νΈλ¦¬ν•κ² ν†µν•©ν•΄μ„ μ‚¬μ©ν•  μ μλ‹¤.
* λ§¤νΌ κµ¬ν„μ²΄λ¥Ό μ‚¬μ©ν•λ©΄ μ¤ν”„λ§ μμ™Έ μ¶”μƒν™”λ„ ν•¨κ» μ μ©λλ‹¤.
* λ§μ΄λ°”ν‹°μ¤ μ¤ν”„λ§ μ—°λ™ λ¨λ“μ΄ λ°μ΄ν„°λ² μ΄μ¤ μ»¤λ„¥μ…, νΈλμ­μ…κ³Ό κ΄€λ ¨λ κΈ°λ¥λ„ λ™κΈ°ν™”ν•΄μ¤€λ‹¤.

# π’΅ MyBatis κΈ°λ¥ μ •λ¦¬
* λ§μ΄λ°”ν‹°μ¤κ°€ μ κ³µν•λ” μµκ³ μ κΈ°λ¥μ΄μ λ§μ΄λ°”ν‹°μ¤λ¥Ό μ‚¬μ©ν•λ” μ΄μ λ” λ°”λ΅ *8λ™μ  SQL κΈ°λ¥** λ•λ¬Έμ΄λ‹¤.
* κ³µμ‹ λ©”λ‰΄μ–Όμ—μ„ μ κ³µν•λ” μμ λ¥Ό ν†µν•΄ λ™μ  SQLμ„ μ•μ•„λ³΄μ.

### 1. if
```xml
<select id="findActiveBlogWithTitleLike" resultType="Blog">
    SELECT * FROM BLOG
    WHERE state = β€ACTIVEβ€™
    <if test="title != null">
        AND title like #{title}
    </if>
</select>
```
* ν•΄λ‹Ή μ΅°κ±΄μ— λ”°λΌ κ°’μ„ μ¶”κ°€ν• μ§€ λ§μ§€ νλ‹¨ν•λ‹¤.

### 2. choose, when, otherwise
```xml
<select id="findActiveBlogLike" resultType="Blog">
    SELECT * FROM BLOG WHERE state = β€ACTIVEβ€™
    <choose>
        <when test="title != null">
            AND title like #{title}
        </when>
        <when test="author != null and author.name != null">
            AND author_name like #{author.name}
        </when>
        <otherwise>
            AND featured = 1
        </otherwise>
    </choose>
</select>
```
* μλ°”μ switch κµ¬λ¬Έκ³Ό μ μ‚¬ν•λ‹¤.

### 3. where
```xml
<select id="findActiveBlogLike" resultType="Blog">
    SELECT * FROM BLOG
    <where>
        <if test="state != null">
            state = #{state}
        </if>
        <if test="title != null">
            AND title like #{title}
        </if>
        <if test="author != null and author.name != null">
            AND author_name like #{author.name}
        </if>
    </where>
</select>
```
* `<where>` λ” λ¬Έμ¥μ΄ μ—†μΌλ©΄ `where` λ¥Ό μ¶”κ°€ν•μ§€ μ•λ”λ‹¤. 
* λ¬Έμ¥μ΄ μμΌλ©΄ `where` λ¥Ό μ¶”κ°€ν•λ‹¤. λ§μ•½ `and` κ°€ λ¨Όμ € μ‹μ‘λλ‹¤λ©΄ `and` λ¥Ό μ§€μ΄λ‹¤.

### 4. foreach
```xml
<select id="selectPostIn" resultType="domain.blog.Post">
    SELECT *
    FROM POST P
    <where>
        <foreach item="item" index="index" collection="list"
                 open="ID in (" separator="," close=")" nullable="true">
            #{item}
        </foreach>
    </where>
</select>
````
* μ»¬λ ‰μ…μ„ λ°λ³µ μ²λ¦¬ν•  λ• μ‚¬μ©ν•λ‹¤. `where in (1,2,3,4,5,6)` μ™€ κ°™μ€ λ¬Έμ¥μ„ μ‰½κ² μ™„μ„±ν•  μ μλ‹¤.
* νλΌλ―Έν„°λ΅ List λ¥Ό μ „λ‹¬ν•λ©΄ λλ‹¤.

### 5. μ• λ…Έν…μ΄μ…μΌλ΅ SQL μ‘μ„±
```java
@Select("select id, item_name, price, quantity from item where id=#{id}")
Optional<Item> findById(Long id);
```
* XML λ€μ‹ μ— μ• λ…Έν…μ΄μ…μ— SQLμ„ μ‘μ„±ν•  μ μλ‹¤.
* `@Insert` , `@Update` , `@Delete` , `@Select` κΈ°λ¥μ΄ μ κ³µλλ‹¤.
* μ΄ κ²½μ° XMLμ—λ” `<select id="findById"> ~ </select>` λ” μ κ±°ν•΄μ•Ό ν•λ‹¤.
* λ™μ  SQLμ΄ ν•΄κ²°λμ§€ μ•μΌλ―€λ΅ κ°„λ‹¨ν• κ²½μ°μ—λ§ μ‚¬μ©ν•λ‹¤.

### 6. λ¬Έμμ—΄ λ€μ²΄(String Substitution)
```java
@Select("select * from user where ${column} = #{value}")
User findByColumn(@Param("column") String column, @Param("value") String value);
```
* νλΌλ―Έν„° λ°”μΈλ”©μ΄ μ•„λ‹λΌ λ¬Έμ κ·Έλ€λ΅λ¥Ό μ²λ¦¬ν•κ³  μ‹¶μ€ κ²½μ° `${}` λ¥Ό μ‚¬μ©ν•λ©΄ λλ‹¤.
* `${}` λ¥Ό μ‚¬μ©ν•λ©΄ SQL μΈμ μ… κ³µκ²©μ„ λ‹Ήν•  μ μλ‹¤. λ”°λΌμ„ κ°€κΈ‰μ  μ‚¬μ©ν•λ©΄ μ•λλ‹¤. μ‚¬μ©ν•λ”λΌλ„ λ§¤μ° μ£ΌμκΉκ² μ‚¬μ©ν•΄μ•Ό ν•λ‹¤.

### 7. μ¬μ‚¬μ© κ°€λ¥ν• SQL μ΅°κ°
```xml
<sql id="userColumns">${alias}.id,${alias}.username,${alias}.password</sql>

<select id="selectUsers" resultType="map">
    select
    <include refid="userColumns"><property name="alias" value="t1"/></include>,
    <include refid="userColumns"><property name="alias" value="t2"/></include>
    from some_table t1
    cross join some_table t2
</select>
```
* `<sql>` μ„ μ‚¬μ©ν•λ©΄ SQL μ½”λ“λ¥Ό μ¬μ‚¬μ© ν•  μ μλ‹¤.
* `<include>` λ¥Ό ν†µν•΄μ„ `<sql>` μ΅°κ°μ„ μ°Ύμ•„μ„ μ‚¬μ©ν•  μ μλ‹¤.
  
### 8. Result Maps
```xml
<resultMap id="userResultMap" type="User">
    <id property="id" column="user_id"/>
    <result property="username" column="user_name"/>
    <result property="password" column="hashed_password"/>
</resultMap>

<select id="selectUsers" resultMap="userResultMap">
    select user_id, user_name, hashed_password
    from some_table
    where id = #{id}
</select>
```
* μ»¬λΌλ…κ³Ό κ°μ²΄μ ν”„λ΅νΌν‹° λ…μ΄ λ‹¤λ¥Ό κ²½μ° λ³„μΉ­μ„ μ‚¬μ©ν•΄μ•Ό ν•λ‹¤.
* `resultMap` μ„ μ‚¬μ©ν•λ©΄ λ³„μΉ­ μ—†μ΄ κ°μ²΄μ— λ§¤ν•‘ν•  μ μλ‹¤.
