# ğŸ’¡ ìŠ¤í”„ë§ ì—†ì´ íŠ¸ëœì­ì…˜ ì ìš©
* ì´ë²ˆ ì¥ì—ì„œëŠ” ìŠ¤í”„ë§ ì—†ì´ íŠ¸ëœì­ì…˜ì„ ì ìš©í•´ë³´ê³ , ì–´ë–¤ ë¶ˆí¸í•¨ì´ ìˆëŠ”ì§€ í™•ì¸í•´ë³´ì.
* íŠ¸ëœì­ì…˜ì€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ìˆëŠ” ì„œë¹„ìŠ¤ ê³„ì¸µì—ì„œ ì‹œì‘í•´ì•¼ í•œë‹¤. ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ì˜ëª»ë˜ë©´ í•´ë‹¹ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ìœ¼ë¡œ ì¸í•´ ë¬¸ì œê°€ ë˜ëŠ” ë¶€ë¶„ì„ í•¨ê»˜ ë¡¤ë°±í•´ì•¼ í•˜ê¸° ë•Œë¬¸ì´ë‹¤.

![image](https://github.com/shin-je-woo/TIL/assets/39439576/c8b2667c-cf83-484b-9727-dc2b2a455a1a)
* ê·¸ëŸ°ë° `íŠ¸ëœì­ì…˜`ì„ ì‹œì‘í•˜ë ¤ë©´ `ì»¤ë„¥ì…˜`ì´ í•„ìš”í•˜ë‹¤. ê²°êµ­ ì„œë¹„ìŠ¤ ê³„ì¸µì—ì„œ ì»¤ë„¥ì…˜ì„ ë§Œë“¤ê³ , íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì´í›„ì— ì»¤ë„¥ì…˜ì„ ì¢…ë£Œí•´ì•¼ í•œë‹¤.
* ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ DB íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•˜ë ¤ë©´ **íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•˜ëŠ” ë™ì•ˆ ê°™ì€ ì»¤ë„¥ì…˜ì„ ìœ ì§€**í•´ì•¼ í•œë‹¤. ê·¸ë˜ì•¼ **ê°™ì€ ì„¸ì…˜**ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

![image](https://github.com/shin-je-woo/TIL/assets/39439576/e87fc640-2316-4929-8d8d-2727466f5d07)
* ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ê°™ì€ ì»¤ë„¥ì…˜ì„ ìœ ì§€í•˜ëŠ” ê°€ì¥ ë‹¨ìˆœí•œ ë°©ë²•ì€ ì»¤ë„¥ì…˜ì„ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬í•´ì„œ ê°™ì€ ì»¤ë„¥ì…˜ì´ ì‚¬ìš©ë˜ë„ë¡ ìœ ì§€í•˜ëŠ” ê²ƒì´ë‹¤.

â–¶ï¸ ë¦¬í¬ì§€í† ë¦¬ ì½”ë“œ
```java
@Slf4j
@RequiredArgsConstructor
public class MemberRepositoryV2 {

    private final DataSource dataSource;
    
    ...
    public Member findById(Connection conn, final String memberId) throws SQLException {
        String sql = "select * from member where member_id = ?";

        try (
                PreparedStatement pstmt = conn.prepareStatement(sql);
                //connectionì€ ì—¬ê¸°ì„œ closeí•˜ì§€ ì•ŠëŠ”ë‹¤.(íŠ¸ëœì­ì…˜ì„ ìœ ì§€í•´ì•¼ í•˜ê¸° ë•Œë¬¸)
        ) {
            pstmt.setString(1, memberId);
            try (ResultSet rs = pstmt.executeQuery();) {
                if (rs.next()) {
                    Member member = new Member();
                    member.setMemberId(rs.getString("member_id"));
                    member.setMoney(rs.getInt("money"));
                    return member;
                } else {
                    throw new NoSuchElementException("member not found memberId = " + memberId);
                }
            } catch (SQLException e) {
                log.error("error", e);
                throw e;
            }
        } catch (SQLException e) {
            log.error("error", e);
            throw e;
        }
    }
    
    public void update(Connection conn, String memberId, int money) throws SQLException {
        String sql = "update member set money = ? where member_id = ?";

        try (
                PreparedStatement pstmt = conn.prepareStatement(sql);
                //connectionì€ ì—¬ê¸°ì„œ closeí•˜ì§€ ì•ŠëŠ”ë‹¤.(íŠ¸ëœì­ì…˜ì„ ìœ ì§€í•´ì•¼ í•˜ê¸° ë•Œë¬¸)
        ) {
            pstmt.setInt(1, money);
            pstmt.setString(2, memberId);
            int resultSize = pstmt.executeUpdate();
            log.info("resultSize={}", resultSize);
        } catch (SQLException e) {
            log.error("error", e);
            throw e;
        }
    }
    ...   
}
```
* findById, update ë©”ì„œë“œëŠ” `Connection` ì„ íŒŒë¼ë¯¸í„°ë¡œ ë°›ëŠ”ë‹¤. ( Connection con = getConnection()ê³¼ ê°™ì´ ìƒˆë¡œìš´ ì»¤ë„¥ì…˜ì„ ìƒì„±í•˜ë©´ ì•ˆëœë‹¤. )
* ë˜í•œ, íŒŒë¼ë¯¸í„°ë¡œ ë°›ì€ `Connection` ì„ íŠ¸ëœì­ì…˜ ì•ˆì˜ ë‹¤ë¥¸ ë¡œì§ì—ì„œë„ ì‚¬ìš©í•´ì•¼ í•˜ë¯€ë¡œ Connectionì„ ì¢…ë£Œí•˜ì§€ ì•ŠëŠ”ë‹¤.
* Connection ì¢…ë£ŒëŠ” íŠ¸ëœì­ì…˜ì˜ commit ë˜ëŠ” rollbackì‹œì ì— ë˜ì–´ì•¼ í•œë‹¤.

â–¶ï¸ ì„œë¹„ìŠ¤ ì½”ë“œ
```java
@Slf4j
@RequiredArgsConstructor
public class MemberServiceV2 {

    private final DataSource dataSource;
    private final MemberRepositoryV2 memberRepository;

    public void accountTransfer(String fromId, String toId, int money) throws SQLException {

        try (Connection con = dataSource.getConnection()) {
            try {
                con.setAutoCommit(false); //íŠ¸ëœì­ì…˜ ì‹œì‘
                //ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ìˆ˜í–‰
                bizLogic(con, fromId, toId, money);
                con.commit(); //ì„±ê³µ ì‹œ ì»¤ë°‹
            } catch (Exception e) {
                con.rollback(); //ì‹¤íŒ¨ ì‹œ ë¡¤ë°±
                throw new IllegalStateException(e);
            } finally {
                con.setAutoCommit(true); //ì»¤ë„¥ì…˜ í’€ì„ ê³ ë ¤í•´ì„œ Connectionë°˜ë‚©í•  ë•ŒëŠ” autoCommitì„ trueë¡œ ëŒë ¤ë†“ê³  ë°˜ë‚©
            }
        }
    }

    private void bizLogic(Connection con, String fromId, String toId, int money) throws SQLException {
        Member fromMember = memberRepository.findById(con, fromId);
        Member toMember = memberRepository.findById(con, toId);

        memberRepository.update(con, fromId, fromMember.getMoney() - money);
        validation(toMember);
        memberRepository.update(con, toId, toMember.getMoney() + money);
    }

    private void validation(Member toMember) {
        if (toMember.getMemberId().equals("ex")) {
            throw new IllegalStateException("ì´ì²´ ì¤‘ ì˜ˆì™¸ ë°œìƒ");
        }
    }
}
```
* `Connection con = dataSource.getConnection();`
  * íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ê¸° ìœ„í•´ Connectionì„ ì—°ê²°í•œë‹¤.
* `con.setAutoCommit(false);` //íŠ¸ëœì­ì…˜ ì‹œì‘
  * ì»¤ë„¥ì…˜ì„ í†µí•´ ì„¸ì…˜ì— set autocommit false ê°€ ì „ë‹¬ë˜ê³ , ì´í›„ë¶€í„°ëŠ” ìˆ˜ë™ ì»¤ë°‹ ëª¨ë“œë¡œ ë™ì‘í•œë‹¤. (íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•œë‹¤.)
* `bizLogic(con, fromId, toId, money);`
  * íŠ¸ëœì­ì…˜ì´ ì‹œì‘ëœ ì»¤ë„¥ì…˜ì„ ì „ë‹¬í•˜ë©´ì„œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ìˆ˜í–‰í•œë‹¤.
  * ì´ë ‡ê²Œ ë¶„ë¦¬í•œ ì´ìœ ëŠ” íŠ¸ëœì­ì…˜ì„ ê´€ë¦¬í•˜ëŠ” ë¡œì§ê³¼ ì‹¤ì œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ êµ¬ë¶„í•˜ê¸° ìœ„í•¨ì´ë‹¤.
  * `memberRepository.update(con..)` : ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ë³´ë©´ ë¦¬í¬ì§€í† ë¦¬ë¥¼ í˜¸ì¶œí•  ë•Œ ì»¤ë„¥ì…˜ì„ ì „ë‹¬í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
* `con.commit();` //ì„±ê³µì‹œ ì»¤ë°‹
  * ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ì •ìƒ ìˆ˜í–‰ë˜ë©´ íŠ¸ëœì­ì…˜ì„ ì»¤ë°‹í•œë‹¤.
* `con.rollback();` //ì‹¤íŒ¨ì‹œ ë¡¤ë°±
  * catch(Exception e){..} ë¥¼ ì‚¬ìš©í•´ì„œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ìˆ˜í–‰ ë„ì¤‘ì— ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ íŠ¸ëœì­ì…˜ì„ ë¡¤ë°±í•œë‹¤.

# ğŸ’¡ ë¬¸ì œì 
* ì„œë¹„ìŠ¤ ì½”ë“œì—ì„œ `Connection` ì„ ì–»ê³ , í•˜ë‚˜ì˜ Connection(autocommit false)ìœ¼ë¡œ SQLì„ ìˆ˜í–‰í•˜ë©´ì„œ íŠ¸ëœì­ì…˜ì„ ì–»ì„ ìˆ˜ ìˆì—ˆë‹¤.
* í•˜ì§€ë§Œ, ë¦¬í¬ì§€í† ë¦¬ì—ì„œ Connectionì„ íŒŒë¼ë¯¸í„°ë¡œ ë°›ëŠ” ë³„ë„ì˜ ë©”ì„œë“œë¥¼ ë§Œë“¤ì–´ì•¼ í•˜ëŠ” ì ê³¼ íŠ¸ëœì­ì…˜ì„ ê´€ë¦¬í•˜ê¸° ìœ„í•´ ì„œë¹„ìŠ¤ ì½”ë“œê°€ ì§€ì €ë¶„í•´ì§€ëŠ” ë¬¸ì œê°€ ë°œìƒí–ˆë‹¤.
* ì¶”ê°€ë¡œ ì»¤ë„¥ì…˜ì„ ìœ ì§€í•˜ë„ë¡ ì½”ë“œë¥¼ ì‘ì„±í•˜ëŠ” ê²ƒë„ ì‰¬ìš´ ì¼ì€ ì•„ë‹ˆë‹¤.
* ìŠ¤í”„ë§ì€ ì´ëŸ° ë¬¸ì œë“¤ì„ í•´ê²°í•˜ëŠ” ë°©ë²•ì„ ì œê³µí•˜ê³  ìˆë‹¤. ë‹¤ìŒ ì¥ì—ì„œ ìŠ¤í”„ë§ìœ¼ë¡œ ë¬¸ì œë“¤ì„ í•˜ë‚˜ì”© í•´ê²°í•´ë³´ì.
