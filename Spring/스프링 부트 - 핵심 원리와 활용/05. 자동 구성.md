# ğŸ’¡ ìŠ¤í”„ë§ ë¶€íŠ¸ì˜ ìë™ êµ¬ì„±
- ìŠ¤í”„ë§ë¶€íŠ¸ í”„ë¡œì íŠ¸ë¥¼ ë§Œë“¤ì–´ì„œ ì‹¤í–‰í•´ë³´ë©´ ë‚´ê°€ Beanìœ¼ë¡œ ë“±ë¡í•˜ì§€ ì•Šì€ ë‹¤ì–‘í•œ Beanë“¤ì´ ë“±ë¡ë˜ëŠ” ê±¸ ì•Œ ìˆ˜ ìˆë‹¤.
- ì˜ˆë¥¼ ë“¤ì–´ JdbcTemplate, DataSource, TransactionManager ë“±ë“± ì•„ë¬´ëŸ° ì„¤ì •ì„ í•˜ì§€ ì•Šì•„ë„ ê·¸ëŒ€ë¡œ ì“¸ ìˆ˜ ìˆë‹¤.
- ì–´ë–»ê²Œ ê°€ëŠ¥í•œ ê²ƒì¼ê¹Œ?
- ìŠ¤í”„ë§ ë¶€íŠ¸ëŠ” ìì£¼ ì‚¬ìš©ë˜ëŠ” ë‹¤ì–‘í•œ ë¹ˆë“¤ì„ ìë™ìœ¼ë¡œ ë“±ë¡í•´ì£¼ëŠ” ìë™ êµ¬ì„±(Auto Configuration) ê¸°ëŠ¥ì„ ì œê³µí•œë‹¤.
- [ìŠ¤í”„ë§ ë¶€íŠ¸ê°€ ì œê³µí•˜ëŠ” ìë™ êµ¬ì„± ë§í¬](https://docs.spring.io/spring-boot/docs/current/reference/html/auto-configuration-classes.html)
- ìŠ¤í”„ë§ ë¶€íŠ¸ëŠ” ë‹¤ì–‘í•œ ìë™ êµ¬ì„±ì„ ì œê³µí•˜ê³  `spring-boot-autoconfigure` ë¼ì´ë¸ŒëŸ¬ë¦¬ì— ìë™ êµ¬ì„±ì„ ëª¨ì•„ë‘”ë‹¤.

â–¶ï¸ JdbcTemplateAutoConfiguration - JdbcTemlate ìë™ êµ¬ì„±
```java
@AutoConfiguration(after = DataSourceAutoConfiguration.class)
@ConditionalOnClass({ DataSource.class, JdbcTemplate.class })
@ConditionalOnSingleCandidate(DataSource.class)
@EnableConfigurationProperties(JdbcProperties.class)
@Import({ DatabaseInitializationDependencyConfigurer.class,
          JdbcTemplateConfiguration.class,
          NamedParameterJdbcTemplateConfiguration.class })
public class JdbcTemplateAutoConfiguration {
}
```
- `@AutoConfiguration` : ìë™ êµ¬ì„±ì„ ì‚¬ìš©í•˜ë ¤ë©´ ì´ ì• ë…¸í…Œì´ì…˜ì„ ë“±ë¡í•´ì•¼ í•œë‹¤.
  - `after` : after ì†ì„±ì€ í•´ë‹¹ ì„¤ì • ì´í›„ ì‹¤í–‰í•˜ë¼ëŠ” ëœ»ì´ë‹¤. JdbcTemplateì„ ë“±ë¡í•˜ê¸° ìœ„í•´ì„œëŠ” DataSourceê°€ ë“±ë¡ë˜ì–´ì•¼ í•˜ê¸° ë•Œë¬¸ì´ë‹¤.
- `@ConditionalOnClass` : IFë¬¸ê³¼ ìœ ì‚¬í•œ ê¸°ëŠ¥ì„ ì œê³µí•œë‹¤. ì´ëŸ° í´ë˜ìŠ¤ê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ ì„¤ì •ì´ ë™ì‘í•œë‹¤.
- `@Import ì˜ ëŒ€ìƒì´ ë˜ëŠ” JdbcTemplateConfiguration` í´ë˜ìŠ¤ì— ì‹¤ì œ JdbcTemplateì„ ë¹ˆìœ¼ë¡œ ë“±ë¡í•˜ëŠ” ì½”ë“œê°€ ìˆë‹¤.

â–¶ï¸ JdbcTemplateConfiguration - ì‹¤ì œ JdbcTemlate ë¹ˆ ë“±ë¡
```java
@Configuration(proxyBeanMethods = false)
@ConditionalOnMissingBean(JdbcOperations.class)
class JdbcTemplateConfiguration {

    @Bean
    @Primary
    JdbcTemplate jdbcTemplate(DataSource dataSource, JdbcProperties properties) {
        JdbcTemplate jdbcTemplate = new JdbcTemplate(dataSource);
        JdbcProperties.Template template = properties.getTemplate();
        jdbcTemplate.setFetchSize(template.getFetchSize());
        jdbcTemplate.setMaxRows(template.getMaxRows());
        if (template.getQueryTimeout() != null) {
            jdbcTemplate.setQueryTimeout((int) template.getQueryTimeout().getSeconds());
        }
        return jdbcTemplate;
    }

}
```
- `@ConditionalOnMissingBean` : í•´ë‹¹ ë¹ˆì´ ì—†ì„ ë–„ë§Œ ë™ì‘í•˜ë¼ëŠ” ëœ»ì´ë‹¤.
  - JdbcOperationsì€ JdbcTemplateì˜ ë¶€ëª¨ ì¸í„°í˜ì´ìŠ¤ì´ë‹¤.
  - ì¦‰, JdbcTemplateì´ ë“±ë¡ë˜ì–´ ìˆì§€ ì•Šì„ ê²½ìš°ì—ë§Œ ë¹ˆìœ¼ë¡œ ë“±ë¡í•œë‹¤.
  - ë³´í†µ ê°œë°œìê°€ ì§ì ‘ ë¹ˆì„ ë“±ë¡í•˜ë©´ ê°œë°œìê°€ ë“±ë¡í•œ ë¹ˆì„ ì‚¬ìš©í•˜ê³ , ìë™ êµ¬ì„±ì€ ë™ì‘í•˜ì§€ ì•ŠëŠ”ë‹¤.

## @Conditional
- `@Conditional` ì€ íŠ¹ì • ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ”ì§€ ì—¬ë¶€ë¥¼ êµ¬ë³„í•˜ëŠ” ê¸°ëŠ¥ì´ë‹¤.
- ì¡°ê±´ì— ë§Œì¡±í•  ë•Œë§Œ ë¹ˆìœ¼ë¡œ ë“±ë¡í•  ìˆ˜ ìˆê²Œ ë„ì™€ì¤€ë‹¤.
- ì´ëŸ° ì´ìœ ë¡œ ìŠ¤í”„ë§ ë¶€íŠ¸ì˜ ìë™ êµ¬ì„±ì—ì„œ ìì£¼ ì‚¬ìš©ëœë‹¤.
- `@Conditional` ì„ ì‚¬ìš©í•˜ë ¤ë©´ Condition ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•´ì•¼ í•œë‹¤.

```java
package org.springframework.context.annotation;

@FunctionalInterface
public interface Condition {
    boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata);
}
```
- `matches()` ë©”ì„œë“œê°€ true ë¥¼ ë°˜í™˜í•˜ë©´ ì¡°ê±´ì— ë§Œì¡±í•´ì„œ ë™ì‘í•˜ê³ , false ë¥¼ ë°˜í™˜í•˜ë©´ ë™ì‘í•˜ì§€ ì•ŠëŠ”ë‹¤.
- `ConditionContext` : ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆ, í™˜ê²½ ì •ë³´ë“±ì„ ë‹´ê³  ìˆë‹¤.
- `AnnotatedTypeMetadata` : ì• ë…¸í…Œì´ì…˜ ë©”íƒ€ ì •ë³´ë¥¼ ë‹´ê³  ìˆë‹¤.

```java
@Slf4j
public class MemoryCondition implements Condition {
    @Override
    public boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) {
        // -Dmemory=on
        String memory = context.getEnvironment().getProperty("memory");
        return "on".equals(memory);
    }
}
```
```java
@Configuration
@Conditional(MemoryCondition.class)
public class MemoryConfig {

    @Bean
    public MemoryController memoryController() {
        return new MemoryController(memoryFinder());
    }

    @Bean
    public MemoryFinder memoryFinder() {
        return new MemoryFinder();
    }
}
```
- ìœ„ ì˜ˆì œì²˜ëŸ¼ `Condition` ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ê³ , `matches()` ë©”ì„œë“œë¥¼ ì˜¤ë²„ë¼ì´ë”©í•˜ì—¬ ì¡°ê±´ì„ ì„¤ì •í•œë‹¤.
- ê·¸ í›„, ì„¤ì • í´ë˜ìŠ¤ì—ì„œ `@Conditional` ì• ë…¸í…Œì´ì…˜ìœ¼ë¡œ ì„¤ì •ì„ ì‚¬ìš©í• ì§€ ì•ˆí• ì§€ íŒë³„í•  ìˆ˜ ìˆë‹¤.

## @Conditional - ë‹¤ì–‘í•œ ê¸°ëŠ¥
- ìœ„ ì˜ˆì œì—ì„œì²˜ëŸ¼ `Condition` ì¸í„°í˜ì´ìŠ¤ë¥¼ ì§ì ‘ êµ¬í˜„í•´ë„ ë˜ì§€ë§Œ, ìŠ¤í”„ë§ì€ ì´ë¯¸ ëŒ€ë¶€ë¶„ì˜ êµ¬í˜„ì²´ë¥¼ ë§Œë“¤ì–´ ë‘ì—ˆë‹¤.
```java
@Configuration
@ConditionalOnProperty(name = "memory", havingValue = "on") // ì¶”ê°€
public class MemoryConfig {

    @Bean
    public MemoryController memoryController() {
        return new MemoryController(memoryFinder());
    }

    @Bean
    public MemoryFinder memoryFinder() {
        return new MemoryFinder();
    }
}
```
- `Condition` ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„ ëŒ€ì‹  `@ConditionalOnProperty` ì• ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í–ˆë‹¤.
- `@ConditionalOnProperty` ì€ í™˜ê²½ ì •ë³´ê°€ í•´ë‹¹ ì¡°ê±´ì— ë§Œì¡±í•˜ë©´ ë™ì‘í•˜ëŠ” ì• ë…¸í…Œì´ì…˜ì´ë‹¤.

â–¶ï¸ @ConditionalOnProperty
```java
@Conditional(OnPropertyCondition.class)
public @interface ConditionalOnProperty {
    // ...
}
```
- `@ConditionalOnProperty` ë„ ì˜ˆì œì—ì„œ ë³¸ ê²ƒì²˜ëŸ¼ ë‚´ë¶€ì—ëŠ” `@Conditional` ì„ ì‚¬ìš©í•œë‹¤.
- ë‹¹ì—°íˆ `OnPropertyCondition` í´ë˜ìŠ¤ëŠ” `Condition` ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•œë‹¤.

### ğŸ“Œ @ConditionalOnXxx [ë§í¬](https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.developing-auto-configuration.condition-annotations)
- `@ConditionalOnClass`, `@ConditionalOnMissingClass`
  - í´ë˜ìŠ¤ê°€ ìˆëŠ” ê²½ìš° ë™ì‘í•œë‹¤. ë‚˜ë¨¸ì§€ëŠ” ê·¸ ë°˜ëŒ€
- `@ConditionalOnBean`, `@ConditionalOnMissingBean`
  - ë¹ˆì´ ë“±ë¡ë˜ì–´ ìˆëŠ” ê²½ìš° ë™ì‘í•œë‹¤. ë‚˜ë¨¸ì§€ëŠ” ê·¸ ë°˜ëŒ€
- `@ConditionalOnProperty`
  - í™˜ê²½ ì •ë³´ê°€ ìˆëŠ” ê²½ìš° ë™ì‘í•œë‹¤.
- `@ConditionalOnResource`
  - ë¦¬ì†ŒìŠ¤ê°€ ìˆëŠ” ê²½ìš° ë™ì‘í•œë‹¤.
- `@ConditionalOnWebApplication`, `@ConditionalOnNotWebApplication`
  - ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì¸ ê²½ìš° ë™ì‘í•œë‹¤.
- `@ConditionalOnExpression`
  - SpEL í‘œí˜„ì‹ì— ë§Œì¡±í•˜ëŠ” ê²½ìš° ë™ì‘í•œë‹¤.
 
# ğŸ’¡ ìë™ êµ¬ì„± ì´í•´ - ìŠ¤í”„ë§ ë¶€íŠ¸ì˜ ë™ì‘
- ìŠ¤í”„ë§ ë¶€íŠ¸ëŠ” ë‹¤ìŒ ê²½ë¡œì— ìˆëŠ” íŒŒì¼ì„ ì½ì–´ì„œ ìŠ¤í”„ë§ ë¶€íŠ¸ ìë™ êµ¬ì„±ìœ¼ë¡œ ì‚¬ìš©í•œë‹¤.
- `resources/META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports`
- `spring-boot-autoconfigure` ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” ì•„ë˜ì™€ ê°™ì´ ìˆ˜ë§ì€ ìë™ êµ¬ì„± í´ë˜ìŠ¤ë“¤ì´ ì¡´ì¬í•œë‹¤.

![image](https://github.com/shin-je-woo/TIL/assets/39439576/c81ba92a-92b4-4ddc-846c-abfcade76c64)

- ìŠ¤í”„ë§ ë¶€íŠ¸ ìë™ êµ¬ì„±ì´ ë™ì‘í•˜ëŠ” ìˆœì„œëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.
- `@SpringBootApplication` â†’ `@EnableAutoConfiguration` â†’ `@Import(AutoConfigurationImportSelector.class)`
- ì—¬ê¸°ì„œ ì¤‘ìš”í•œ ì• ë…¸í…Œì´ì…˜ì€ `@EnableAutoConfiguration` ì´ë‹¤. ì´ë¦„ ê·¸ëŒ€ë¡œ ìë™ êµ¬ì„±ì„ í™œì„±í™” í•˜ëŠ” ê¸°ëŠ¥ì„ ì œê³µí•œë‹¤.

```java
@AutoConfigurationPackage
@Import(AutoConfigurationImportSelector.class)
public @interface EnableAutoConfiguration {
    // ...
}
```
- `@Import` ëŠ” ì£¼ë¡œ ìŠ¤í”„ë§ ì„¤ì • ì •ë³´ë¥¼ í¬í•¨í•  ë•Œ ì‚¬ìš©í•˜ëŠ”ë°, ì—¬ê¸°ì— `ImportSelector` ê°€ í• ë‹¹ë˜ì—ˆë‹¤.

## ImportSelector
- `@Import` ì— ì„¤ì • ì •ë³´ë¥¼ ì¶”ê°€í•˜ëŠ” ë°©ë²•ì€ 2ê°€ì§€ê°€ ìˆë‹¤.
  - ì •ì ì¸ ë°©ë²•: `@Import(í´ë˜ìŠ¤)` ëŠ” ì½”ë“œì— ëŒ€ìƒì´ ì •í™•íˆ ì§€ì •ëœë‹¤. ì„¤ì •ìœ¼ë¡œ ì‚¬ìš©í•  ëŒ€ìƒì„ ë³€ê²½í•  ìˆ˜ ì—†ë‹¤.
  - ë™ì ì¸ ë°©ë²•: `@Import(ImportSelector)` ëŠ” ì½”ë“œë¡œ í”„ë¡œê·¸ë˜ë°í•´ì„œ ì„¤ì •ìœ¼ë¡œ ì‚¬ìš©í•  ëŒ€ìƒì„ ë™ì ìœ¼ë¡œ ì„ íƒí•  ìˆ˜ ìˆë‹¤.

 ```java
package org.springframework.context.annotation;

public interface ImportSelector {
    String[] selectImports(AnnotationMetadata importingClassMetadata);
    // ...
}
```
- ì¦‰, `@Import(ImportSelector)` ì´ëŸ° ì‹ìœ¼ë¡œ `@Import` ì˜ ê°’ìœ¼ë¡œ `ImportSelector` ì˜ êµ¬í˜„ì²´ë¥¼ í• ë‹¹í•´ ì£¼ë©´ `selectImports()` ë©”ì„œë“œê°€ ì‹¤í–‰ë˜ë©´ì„œ ê²°ê³¼ë¡œ ë°˜í™˜ëœ í´ë˜ìŠ¤ë“¤ë§Œ Importë˜ëŠ” ë°©ì‹ì´ë‹¤.
- ìŠ¤í”„ë§ ë¶€íŠ¸ì˜ `@Import(AutoConfigurationImportSelector.class)` ì— ëª…ì‹œëœ `AutoConfigurationImportSelector` ì—ì„œ `resources/META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports` íŒŒì¼ì— ì €ì¥ëœ í´ë˜ìŠ¤ë“¤ì„ ì„¤ì •ì •ë³´ë¡œ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.
