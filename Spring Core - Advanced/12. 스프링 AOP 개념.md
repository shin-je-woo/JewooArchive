# 💡 핵심 기능과 부가 기능
![image](https://github.com/shin-je-woo/TIL/assets/39439576/99a99304-01ff-49fe-adc9-61066d4fb5bc)

- 애플리케이션 로직은 핵심기능과 부가기능으로 나눌 수 있다.
- 위 그림에서는 로그 추적 로직이 부가기능이다.
- 그런데 이 부가기능을 여러 곳에서 공통으로 사용하면 각 핵심기능마다 부가기능을 추가해줘야한다.
- 이 경우 코드의 중복이 발생하고, 핵심기능과 부가기능이 공존하기 때문에 유지보수가 어렵다.

![image](https://github.com/shin-je-woo/TIL/assets/39439576/e8f06832-2fb6-420b-b6cf-a14e450f5704)
- 보통 부가 기능은 여러 클래스에 걸쳐서 함께 사용된다.
- 예를 들어서 모든 애플리케이션 호출을 로깅 해야 하는 요구사항을 생각해보자.
- 이러한 부가 기능은 횡단 관심사(cross-cutting concerns)가 된다.
- 쉽게 이야기해서 하나의 부가 기능이 여러 곳에 동일하게 사용된다는 뜻이다.
- 공통 부가기능인 횡단 관심사를 별개로 관리하면서 동시에 적용하기 위해 AOP가 등장했다.

# 💡 애스펙트(Aspect)
- 애스펙트는 부가 기능과 해당 부가 기능을 어디에 적용할지 정의한 것이다.
- 이전에 알아본 `@Aspect` 가 바로 애스펙트이다.
- 그리고 스프링이 제공하는 어드바이저도 어드바이스(부가 기능)와 포인트컷(적용 대상)을 가지고 있어서 개념상 하나의 애스펙트이다.
- 애스펙트는 우리말로 해석하면 관점이라는 뜻이다.
- 이름 그대로 애플리케이션을 바라보는 관점을 횡단 관심사(cross-cutting concerns) 관점으로 보는 것이다.
- 애스펙트를 사용한 프로그래밍 방식을 **관점 지향 프로그래밍 AOP(Aspect-Oriented Programming)** 이라 한다.

![image](https://github.com/shin-je-woo/TIL/assets/39439576/a2b6978a-ab62-4f86-a6ff-cfa6e09ebf26)

### AspectJ 프레임워크
- AOP의 대표적인 구현으로 AspectJ 프레임워크가 있다.
- 물론 스프링도 AOP를 지원하지만 대부분 AspectJ의 문법을 차용하고, AspectJ가 제공하는 기능의 일부만 제공한다.

# 💡 AOP 적용 방식
- AOP를 통해 부가기능을 적용하는 데는 크게 3가지 방식이 있다.
  - 컴파일 시점
  - 클래스 로딩 시점
  - 런타임 시점(프록시)
- 이 3가지 방식을 하나씩 알아보자.

## 컴파일 시점
![image](https://github.com/shin-je-woo/TIL/assets/39439576/b1ee3611-d038-4d8d-ab45-4cca5f8fe4a8)

- `.java` 소스 코드를 컴파일러를 사용해서 `.class` 를 만드는 시점에 부가 기능 로직을 추가할 수 있다.
- 이때는 AspectJ가 제공하는 특별한 컴파일러를 사용해야 한다.
- 컴파일 된 `.class` 를 디컴파일 해보면 애스펙트 관련 호출 코드가 들어간다.
- 이렇게 원본 로직에 부가 기능 로직이 추가되는 것을 위빙(Weaving)이라 한다.
- 단점 : 컴파일 시점에 부가 기능을 적용하려면 특별한 컴파일러도 필요하고 복잡하다.

## 클래스 로딩 시점
![image](https://github.com/shin-je-woo/TIL/assets/39439576/9b6d325d-ff45-49eb-90b5-21a958210e26)

- 자바를 실행하면 `.class` 파일을 JVM 내부의 클래스 로더에 보관한다.
- 이때 중간에서 `.class` 파일을 조작한 다음 JVM에 올릴 수 있다. (자바언어 제공 - java Instrumentation)
- 이 시점에 애스펙트를 적용하는 것을 로드 타임 위빙이라 한다.
- 단점 : 로드 타임 위빙은 자바를 실행할 때 특별한 옵션( `java -javaagent` )을 통해 클래스 로더 조작기를 지정해야 하는데, 이 부분이 번거롭고 운영하기 어렵다.

## 런타임 시점
![image](https://github.com/shin-je-woo/TIL/assets/39439576/96ae33a3-84a4-49b6-a0be-35cb296f65dc)

- 런타임 시점은 컴파일을 완료하고, 클래스 로더에 클래스도 모두 적재되어 자바가 실행되고 난 다음을 말한다.
- 이 시점에서 코드를 조작할 수 없기 때문에 스프링 컨테이너의 도움을 받아 빈 후처리기로 프록시객체로 빈을 바꿔치기하여 구현한다.
- 프록시를 사용하기 때문에 AOP 기능에 일부 제약이 있다.
- 하지만 특별한 컴파일러나, 자바를 실행할 때복잡한 옵션과 클래스 로더 조작기를 설정하지 않아도 된다.

# 💡 AOP 적용 위치
- AOP는 메서드 실행 위치 뿐만 아니라 다음과 같은 다양한 위치에 적용할 수 있다.
- AOP 적용 가능 지점(Join point): 생성자, 필드 값 접근, static 메서드 접근, 메서드 실행
- AspectJ를 사용해서 컴파일 시점과 클래스 로딩 시점에 적용하는 AOP는 바이트코드를 실제 조작하기 때문에 모든 지점에 다 적용할 수 있다.
- ❗ ***프록시 방식을 사용하는 스프링 AOP는 메서드 실행 지점에만 AOP를 적용할 수 있다.***
  - 프록시는 메서드 오버라이딩 개념으로 동작한다.
  - 따라서 생성자나 static 메서드, 필드 값 접근에는 프록시 개념이 적용될 수 없다.
  - 프록시를 사용하는 **스프링 AOP의 조인 포인트는 메서드 실행으로 제한된다.**
- 프록시 방식을 사용하는 스프링 AOP는 스프링 컨테이너가 관리하는 **스프링 빈에만 AOP를 적용할 수 있다.**

# 💡 AOP 용어 정리
### 조인 포인트(Join point)
- 조인포인트란 AOP를 적용할 수 있는 지점을 말한다.
- 조인 포인트는 추상적인 개념이다. AOP를 적용할 수 있는 모든 지점이라 생각하면 된다.
- 즉, 포인트컷의 후보군이다.
- 스프링 AOP는 프록시 방식을 사용하므로 메서드 실행지점으로 조인포인트가 제한된다.

### 포인트컷(Pointcut)
- 조인 포인트 중에서 어드바이스가 적용될 위치를 정하는 기능이다.
- 주로 AspectJ 표현식을 사용해서 지정한다.
- 프록시를 사용하는 스프링 AOP는 메서드 실행 지점만 포인트컷으로 사용된다.

### 타켓(Target)
- 어드바이스를 적용할 실제 객체이다.

### 어드바이스(Advice)
- 부가기능 그 자체를 가리킨다.
- Around(주변), Before(전), After(후)와 같은 다양한 종류의 어드바이스가 있다.

### 애스펙트(Aspect)
- 어드바이스 + 포인트컷을 모듈화 한 것이다.
- @Aspect 를 생각하면 된다.
- 여러 어드바이스와 포인트 컷이 함께 존재할 수 있다.

### 어드바이저(Advisor)
- 하나의 어드바이스와 하나의 포인트 컷으로 구성된 모듈이다.
- 스프링 AOP에서만 사용되는 특별한 용어이다.

### 위빙(Weaving)
- 포인트컷으로 결정한 타켓의 조인 포인트에 어드바이스를 적용하는 것을 말한다.
- 위빙을 통해 핵심 기능 코드에 영향을 주지 않고 부가 기능을 추가 할 수 있다.
- AOP 적용을 위해 애스펙트를 실제 객체에 연결한다.
- 컴파일 타임(AspectJ compiler), 로드 타임, 런타임(스프링 AOP는 런타임 - 프록시 방식) 방식이 있다.

### AOP 프록시
- AOP 기능을 구현하기 위해 만든 프록시 객체이다.
- 스프링에서 AOP 프록시는 JDK 동적 프록시 또는 CGLIB 프록시이다.
