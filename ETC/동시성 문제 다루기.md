# Previous

ë™ì‹œì„± ë¬¸ì œë€, ë‘˜ ì´ìƒì˜ ì“°ë ˆë“œê°€ ê³µìœ ë°ì´í„°ë¥¼ ë™ì‹œì— ì œì–´í•˜ê²Œ ë˜ë©´ì„œ ë°ì´í„° ì •í•©ì„±ì´ ê¹¨ì§€ëŠ” ë¬¸ì œë¥¼ ë§í•œë‹¤. (race condition)

ì¼ë°˜ì ìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ” ìŠ¤í”„ë§, mysql, redis í™˜ê²½ì—ì„œ ë™ì‹œì„± ë¬¸ì œë¥¼ ì–´ë–»ê²Œ ë‹¤ë£¨ëŠ”ì§€ ì‘ì„±í•´ë³´ë ¤ê³  í•œë‹¤.

ê°€ì¥ í”í•œ ìƒí™©ì€ ì¬ê³ ê´€ë¦¬ í”„ë¡œê·¸ë¨ì¼ ê²ƒ ê°™ë‹¤. (ì¬ê³  ê°ì†Œ ë¡œì§ì„ í•œë²ˆì— ì—¬ëŸ¬ë²ˆ ì‹¤í–‰í•˜ê²Œ ë  ë•Œ ë™ì‹œì„± ë¬¸ì œ ë°œìƒ ê°€ëŠ¥!)

ì•Œì•„ë³¼ ìˆœì„œëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.
1. Java Synchronized í‚¤ì›Œë“œ í™œìš©
2. Mysqlì´ ì œê³µí•˜ëŠ” Lock
   - PessimisticLock
   - OptimisticLock
   - NamedLock
3. Redisë¥¼ í™œìš©í•œ ë°©ë²•
  - Lettuce (ìŠ¤í•€ë½ ë°©ì‹)
  - Redisson (pub-sub ë°©ì‹)

# ğŸ’¡ Java Synchronized í‚¤ì›Œë“œ

ê°€ì¥ í”í•˜ê²Œ ìƒê°í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì´ë‹¤.

ì¬ê³  ê°ì†Œ ë¡œì§ì„ ì‹¤í–‰í•˜ëŠ” ë©”ì„œë“œì— `synchronized` í‚¤ì›Œë“œë¥¼ ë¶™ì—¬ì„œ í•˜ë‚˜ì˜ ì“°ë ˆë“œì—ì„œ ì‘ì—…ì„ ìˆ˜í–‰ì¤‘ì¼ ë•Œ, ë‹¤ë¥¸ ì“°ë ˆë“œì—ì„œ í•´ë‹¹ ë©”ì„œë“œì— ì ‘ê·¼í•˜ì§€ ëª»í•˜ë„ë¡ ë§‰ëŠ” ë°©ë²•ì´ë‹¤.

ì´ ë°©ë²•ì€ ê°„ë‹¨í•˜ì§€ë§Œ ì—¬ëŸ¬ ë¬¸ì œë¥¼ ê°€ì§€ê³  ìˆëŠ”ë°,

1. ìŠ¤í”„ë§ì˜ `@Transactional` í‚¤ì›Œë“œì™€ ì‚¬ìš©ì‹œ ë¬¸ì œ ë°œìƒ ê°€ëŠ¥
2. scale-out í™˜ê²½ì¼ ê²½ìš° ì‚¬ìš©í•  ìˆ˜ ì—†ìŒ

ìŠ¤í”„ë§ì˜ @Transactional í‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•˜ê²Œ ë˜ë©´, ìŠ¤í”„ë§ì€ ê°œë°œìê°€ ì‘ì„±í•œ í´ë˜ìŠ¤ë¡œ ìŠ¤í”„ë§ ë¹ˆì„ ë“±ë¡í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, í”„ë¡ì‹œë¥¼ ìƒì„±í•˜ê³  í”„ë¡ì‹œë¥¼ ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë“±ë¡í•œë‹¤.

íŠ¸ëœì­ì…˜ ê´€ë ¨í•œ í”„ë¡ì‹œëŠ” í¬ê²Œ 1, 2, 3ë‹¨ê³„ê°€ ìˆëŠ”ë°

- 1 ë‹¨ê³„ì—ì„œ íŠ¸ëœì­ì…˜ ì‹œì‘
- 2 ë‹¨ê³„ì—ì„œ ì‹¤ì œ ë©”ì„œë“œ ìˆ˜í–‰
- 3 ë‹¨ê³„ì—ì„œ íŠ¸ëœì­ì…˜ ì¢…ë£Œ (ë³´í†µ ì´ ë•Œ commit ë°œìƒ)

synchronized í‚¤ì›Œë“œëŠ” 2ë‹¨ê³„ ë©”ì„œë“œì—ì„œ ì‘ì„±í•˜ê²Œ ë˜ëŠ”ë°, 2->3ë‹¨ê³„ë¡œ ë„˜ì–´ê°ˆ ë•Œ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´, 1ë²ˆ ì“°ë ˆë“œê°€ 2ë‹¨ê³„ ë©”ì„œë“œë¥¼ ìˆ˜í–‰í•˜ê³  synchronized ë©”ì„œë“œë¥¼ ë¹ ì ¸ë‚˜ì˜¤ë©´ 2ë²ˆ ì“°ë ˆë“œê°€ synchonized ë©”ì„œë“œ ì•ˆìœ¼ë¡œ ë“¤ì–´ê°€ ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ”ë°, ì´ ë•Œ 1ë²ˆ ì“°ë ˆë“œëŠ” ì•„ì§ commitì„ í•˜ì§€ ì•Šì€ ìƒíƒœì´ë¯€ë¡œ ë™ì‹œì„± ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.

```java
@Transactional
public synchronized void decrease(Long id, Long quantity) {
    Stock stock = stockRepository.findById(id).orElseThrow();
    stock.decrease(quantity);
    stockRepository.saveAndFlush(stock);
}
```

```java
@Test
void ë™ì‹œì—_100ê°œ_ìš”ì²­() throws InterruptedException {
    int threadCount = 100;
    ExecutorService executorService = Executors.newWorkStealingPool(32);
    CountDownLatch latch = new CountDownLatch(threadCount);

    for (int i=0; i<threadCount; i++) {
        executorService.submit(() -> {
            try {
                stockService.decrease(1L, 1L);
            } finally {
                latch.countDown();
            }
        });
    }

    latch.await();

    Stock stock = stockRepository.findById(1L).orElseThrow();
    // ì˜ˆìƒ : 100 - (1 * 100) = 0
    assertEquals(0, stock.getQuantity());
}
```

![image](https://github.com/shin-je-woo/TIL/assets/39439576/b823a6b4-ce71-46aa-8b8c-674565ba4a8c)

ê²°ê³¼ë¥¼ ë³´ë©´ 50ê°œëŠ” ì„±ê³µí•˜ê³ , 50ê°œëŠ” ì‹¤íŒ¨í•œ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

ì¦‰, 2 -> 3ë‹¨ê³„ì—ì„œ 50ë²ˆì˜ ë¬¸ì œê°€ ë°œìƒí•œ ê²ƒì„ ìœ ì¶”í•  ìˆ˜ ìˆë‹¤.

# ğŸ’¡ ë°ì´í„°ë² ì´ìŠ¤ê°€ ì œê³µí•˜ëŠ” Lock í™œìš©

ë°ì´í„°ë² ì´ìŠ¤ê°€ 1ê°œë§Œ ìš´ìš©ì¤‘ì´ë¼ë©´ ê°€ì¥ ê°„ë‹¨í•˜ê³  í™•ì‹¤í•˜ê²Œ ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì´ë‹¤.

## PessimisticLock

ë¹„ê´€ì ë½ì€ ì‹¤ì œ DBì— ë½ì„ ê±¸ì–´ ë°ì´í„° ì •í•©ì„±ì„ ë³´ì¥í•˜ëŠ” ë°©ë²•ì´ë‹¤.

ëª¨ë“  íŠ¸ëœì­ì…˜ì€ ì¶©ëŒì´ ë°œìƒí•œë‹¤ê³  ê°€ì •í•˜ê³  ìš°ì„  Lockì„ ê±°ëŠ” ë°©ë²•ì´ë‹¤.

ë‚™ê´€ì  ë½(Optimistic Lock)ê³¼ëŠ” ë‹¬ë¦¬ DBì˜ Lock ê¸°ëŠ¥ì„ ì´ìš©í•œë‹¤. ì£¼ë¡œ `select for update` êµ¬ë¬¸ì„ ì‚¬ìš©í•˜ê³ , ë²„ì „ ì •ë³´ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤. (ì‚¬ìš©í•˜ë„ë¡ í•  ìˆ˜ë„ ìˆë‹¤.)

ë°ë“œë½ì´ ë°œìƒí•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ì£¼ì˜í•´ì„œ ì‚¬ìš©í•´ì•¼ í•œë‹¤.

JPAì—ì„œëŠ” ì•„ë˜ì™€ ê°™ì´ `@Lock` ì• ë…¸í…Œì´ì…˜ì„ ì œê³µí•œë‹¤.

```java
@Lock(LockModeType.PESSIMISTIC_WRITE)
@Query("select s from Stock s where s.id = :id")
Optional<Stock> findByIdWithPessimisticLock(Long id);
```

## OptimisticLock

![image](https://github.com/shin-je-woo/TIL/assets/39439576/da9a9149-0408-45b7-bfc4-af011ce09777)

OptimisticLockì€ ì‹¤ì œë¡œ DBì— Lockì„ ê±°ëŠ” ë°©ì‹ì€ ì•„ë‹ˆë‹¤.

ë³´í†µ Version ì´ë¼ëŠ” ì»¬ëŸ¼ì„ ë‘ê³ , Version ì»¬ëŸ¼ì„ ì—…ë°ì´íŠ¸ ì¡°ê±´ì— ê°™ì´ ë„£ì–´ì¤€ë‹¤. (`jakarta.persistence.Version` ì• ë…¸í…Œì´ì…˜ ì œê³µ)

1ë²ˆ ì“°ë ˆë“œì—ì„œ ë²„ì „ì„ ì˜¬ë¦¬ë©´ 2ë²ˆ ì“°ë ˆë“œì—ì„œëŠ” ì‹¤íŒ¨ê°€ ë˜ê³ , ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì¬ì‹œë„ë¥¼ ì§ì ‘ ì‘ì„±í•´ì£¼ì–´ì•¼ í•œë‹¤.

```java
@Entity
@Getter
@NoArgsConstructor(access = AccessLevel.PROTECTED)
public class Stock {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private Long productId;

    private Long quantity;

    @Version
    private Long version;

    public Stock(Long productId, Long quantity) {
        this.productId = productId;
        this.quantity = quantity;
    }

    public void decrease(Long quantity) {
        if (this.quantity - quantity < 0) {
            throw new RuntimeException("ì¬ê³ ëŠ” 0ê°œ ë¯¸ë§Œì´ ë  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
        this.quantity -= quantity;
    }
}
```

```java
@Lock(LockModeType.OPTIMISTIC)
@Query("select s from Stock s where s.id = :id")
Optional<Stock> findByIdWithOptimisticLock(Long id);
```

```java
@Component
@RequiredArgsConstructor
public class OptimisticLockStockFacade {

    private final OptimisticLockStockService optimisticLockStockService;

    public void decrease(Long id, Long quantity) throws InterruptedException {
        // ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„
        while (true) {
            try {
                optimisticLockStockService.decrease(id, quantity);
                break;
            } catch (Exception e) {
                Thread.sleep(50);
            }
        }
    }
}
```

## Named Lock

Named Lockì€ ê³ ìœ í•œ ì´ë¦„ìœ¼ë¡œ ì‹ë³„ë˜ëŠ” ì ê¸ˆì´ë©° ì ê¸ˆì„ íšë“í•´ ê³µìœ  ìì› ì ‘ê·¼ì„ ë™ê¸°í™”í•  ìˆ˜ ìˆë‹¤.

metadata(ë³„ë„ì˜ ê³µê°„)ì— lockì„ ê±¸ì–´ ë‹¤ë¥¸ ì„¸ì…˜ì—ì„œëŠ” ì´ lockì„ íšë“í•  ìˆ˜ ì—†ë„ë¡ í•œë‹¤.

transactionì´ ëë‚˜ë„ ìë™ìœ¼ë¡œ lockì´ í•´ì œë˜ì§€ ì•Šê¸° ë•Œë¬¸ì— unlockì„ ìˆ˜ë™ìœ¼ë¡œ ì§„í–‰í•´ì•¼ í•œë‹¤.

```java
public interface LockRepository extends JpaRepository<Stock, Long> {

    @Query(value = "select get_lock(:key, 3000)", nativeQuery = true)
    void getLock(String key);

    @Query(value = "select release_lock(:key)", nativeQuery = true)
    void releaseLock(String key);
}
```

```java
@Component
@RequiredArgsConstructor
public class NamedLockStockFacade {

    private final LockRepository lockRepository;
    private final StockService stockService;

    @Transactional
    public void decrease(Long id, Long quantity) {
        try {
            lockRepository.getLock(id.toString());
            stockService.decrease(id, quantity);
        } finally {
            lockRepository.releaseLock(id.toString()); // lock ë°˜í™˜ í•„ìš”!
        }
    }
}
```

# ğŸ’¡ Redis í™œìš©í•˜ê¸°

## Lettuce

setnx (set if not exist) ëª…ë ¹ì–´ë¥¼ í™œìš©í•˜ì—¬ ë¶„ì‚°ë½ì„ êµ¬í˜„í•  ìˆ˜ ìˆë‹¤.

setnx ëŠ” SpinLock(í´ë§ë°©ì‹ê³¼ ìœ ì‚¬) ë°©ì‹ì´ê¸° ë•Œë¬¸ì— retry ë¡œì§ì„ ì‘ì„±í•´ì£¼ì–´ì•¼ í•œë‹¤.

SpinLockì´ë€ Lockì„ íšë“í•˜ë ¤ëŠ” ìŠ¤ë ˆë“œê°€ Lockì„ íšë“í•  ìˆ˜ ìˆëŠ”ì§€ ë°˜ë³µì ìœ¼ë¡œ ì‹œë„í•´ì„œ Lockì„ íšë“í•˜ëŠ” ë°©ì‹ì´ë‹¤.

![image](https://github.com/shin-je-woo/TIL/assets/39439576/9134036d-56c1-4c8d-b02a-f29c604b3ae4)

```java
@Component
@RequiredArgsConstructor
public class LettuceLockStockFacade {

    private final RedisLockRepository redisLockRepository;
    private final StockService stockService;

    public void decrease(Long id, Long quantity) throws InterruptedException {
        while (!redisLockRepository.lock(id)) {
            Thread.sleep(100);
        }

        try {
            stockService.decrease(id, quantity);
        } finally {
            redisLockRepository.unlock(id);
        }
    }
}
```

```java
@Component
@RequiredArgsConstructor
public class RedisLockRepository {

    private final RedisTemplate<String, Object> redisTemplate;

    public Boolean lock(Long key) {
        return redisTemplate
                .opsForValue()
                .setIfAbsent(generateKey(key), "locked", Duration.ofMillis(3_000)); // 3ì´ˆê°„ ì ìœ 
    }

    public void unlock(Long key) {
        redisTemplate.delete(generateKey(key));
    }

    private String generateKey(Long key) {
        return String.format("lock:%d", key);
    }
}
```

## Redisson

Pub-Sub ê¸°ë°˜ Lockì„ ì œê³µí•œë‹¤.

ì±„ë„ì„ ë§Œë“¤ê³ , ë½ì„ ì ìœ ì¤‘ì¸ ì“°ë ˆë“œê°€ ë½ì„ í•´ì œí•  ë•Œ ì±„ë„ì„ êµ¬ë…ì¤‘ì¸ ëŒ€ê¸°ì¤‘ ì“°ë ˆë“œì—ê²Œ ë½ í•´ì œë¥¼ ì•Œë¦¬ëŠ” ë°©ì‹ì´ë‹¤.

ì´ ë°©ì‹ì€ ëŒ€ë¶€ë¶„ retry ë¡œì§ì„ ì‘ì„±í•˜ì§€ ì•Šì•„ë„ ëœë‹¤.

![image](https://github.com/shin-je-woo/TIL/assets/39439576/a0b11b68-9efb-49dc-b3f2-6acee37db77e)

```java
@Slf4j
@Component
@RequiredArgsConstructor
public class RedissonLockStockFacade {

    private final RedissonClient redissonClient;
    private final StockService stockService;

    public void decrease(Long id, Long quantity) {
        RLock lock = redissonClient.getLock(id.toString());

        try {
            boolean available = lock.tryLock(10, 1, TimeUnit.SECONDS);
            if (!available) {
                log.info("lock íšë“ ì‹¤íŒ¨");
                return;
            }

            stockService.decrease(id, quantity);
        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        } finally {
            lock.unlock();
        }
    }
}
```

Lettuceì™€ ë‹¤ë¥´ê²Œ Redissonì€ ë½ íšë“ì„ ê³„ì† ì‹œë„í•˜ëŠ” ë°©ì‹ì´ ì•„ë‹ˆê¸° ë•Œë¬¸ì— Redisì˜ ë¶€í•˜ë¥¼ ì¤„ì¼ ìˆ˜ ìˆë‹¤ëŠ” ì¥ì ì´ ìˆë‹¤.

### Lettuce, Redisson ë¹„êµ

#### Lettuce

- êµ¬í˜„ì´ ê°„ë‹¨í•˜ë‹¤
- spring data redis ë¥¼ ì´ìš©í•˜ë©´ lettuce ê°€ ê¸°ë³¸ì´ê¸° ë•Œë¬¸ì— ë³„ë„ì˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì•„ë„ ëœë‹¤.
- spin lock ë°©ì‹ì´ê¸°ë•Œë¬¸ì— ë™ì‹œì— ë§ì€ ìŠ¤ë ˆë“œê°€ lock íšë“ ëŒ€ê¸° ìƒíƒœë¼ë©´ redis ì— ë¶€í•˜ê°€ ê°ˆ ìˆ˜ ìˆë‹¤.

#### Redisson 
- ë½ íšë“ ì¬ì‹œë„ë¥¼ ê¸°ë³¸ìœ¼ë¡œ ì œê³µí•œë‹¤.
- pub-sub ë°©ì‹ìœ¼ë¡œ êµ¬í˜„ì´ ë˜ì–´ìˆê¸° ë•Œë¬¸ì— lettuce ì™€ ë¹„êµí–ˆì„ ë•Œ redis ì— ë¶€í•˜ê°€ ëœ ê°„ë‹¤.
- ë³„ë„ì˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•´ì•¼í•œë‹¤.
- lock ì„ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì°¨ì›ì—ì„œ ì œê³µí•´ì£¼ê¸° ë–„ë¬¸ì— ì‚¬ìš©ë²•ì„ ê³µë¶€í•´ì•¼ í•œë‹¤.
